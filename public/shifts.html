<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <title data-lng="shifts_page_title">نظام إدارة الحضور والانصراف - إدارة الشفتات</title>

  <!-- مكتبات أساسية -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- خطوط عربية/إنجليزية -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Open+Sans:wght@400;700&display=swap"
    rel="stylesheet">

  <style>
    html {
      animation: fadeIn .3s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    html[lang="ar"] body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }

    html[lang="en"] body {
      font-family: 'Open Sans', sans-serif;
      direction: ltr;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }

    header {
      background: linear-gradient(45deg, #0062cc, #004085);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    header button {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    header button:hover {
      background: #c82333;
    }

    .container {
      display: flex;
      flex-direction: row-reverse;
    }

    .mainContent {
      flex: 1;
      padding: 20px;
    }

    .sidebar {
      width: 240px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      padding: 20px 10px;
    }

    .sidebar h2 {
      margin-bottom: 15px;
      font-size: 1rem;
      text-align: center;
      color: #444;
    }

    .navItem {
      padding: 12px 10px;
      margin: 6px 0;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      font-weight: 500;
      transition: background 0.3s, color 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navItem i {
      font-size: 1.1rem;
      color: #666;
      transition: color 0.3s;
    }

    .navItem:hover {
      background: #f0f0f0;
    }

    .navItem.active {
      background: #007bff;
      color: #fff;
    }

    .navItem.active i {
      color: #fff;
    }

    .errorMsg,
    .successMsg {
      margin: 10px 0;
      font-size: 0.95rem;
      font-weight: 600;
      display: none;
      padding: 10px;
      border-radius: 4px;
    }

    .errorMsg {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .successMsg {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .addBtn {
      background: #28a745;
      color: #fff;
      padding: 8px 14px;
      border-radius: 4px;
      margin-bottom: 15px;
      transition: background 0.3s;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
    }

    .addBtn:hover {
      background: #218838;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    table thead {
      background: #007bff;
      color: #fff;
    }

    table th,
    table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    .actionIcon {
      color: #007bff;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 6px;
      transition: color 0.3s;
    }

    .actionIcon:hover {
      color: #0056b3;
    }

    .modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }

    .modalContent {
      width: 800px;
      max-width: 95%;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: fadeInModal 0.3s ease;
      position: relative;
      max-height: 90vh;
    }

    @keyframes fadeInModal {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modalHeader {
      background: #007bff;
      color: #fff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      font-size: 1rem;
    }

    html[lang="ar"] .modalHeader {
      flex-direction: row-reverse;
    }

    .modalHeader h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .modalCloseBtn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.4rem;
      cursor: pointer;
      transition: color 0.3s;
    }

    .modalCloseBtn:hover {
      color: #ffdddd;
    }

    .modalBody {
      display: flex;
      width: 100%;
      flex: 1;
      overflow: auto;
    }

    /* نموذج الشفت */
    .shiftForm {
      margin-bottom: 15px;
      background: #fff;
    }

    .shiftFormRow {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .formGroup {
      flex: 1;
      min-width: 180px;
    }

    .formGroup label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .formGroup input[type="text"],
    .formGroup input[type="number"],
    .formGroup input[type="date"],
    .formGroup select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      font-family: inherit;
    }

    /* قائمة TimeSlots في المودال */
    .tsListTitle {
      margin: 0;
      padding: 6px;
      background: #ccc;
      font-size: 0.9rem;
      text-align: center;
      border-radius: 4px;
    }

    .tsItem {
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 6px 0;
      padding: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background-color: #fff;
      color: #333;
    }

    .tsItem:hover {
      outline: 2px solid #e9ecef;
    }

    .tsItem.selected {
      outline: 2px solid #66f;
    }

    .tsTitle {
      padding: 4px;
      border-radius: 4px;
      margin-bottom: 4px;
      color: #fff;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .tsTimeRange {
      font-size: 0.8rem;
      color: #444;
    }

    .daysGrid {
      flex: 1;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 10px;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }

    .dayCell {
      border: 1px solid #ccc;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      background: #f9f9f9;
      transition: transform 0.3s, box-shadow 0.3s;
      width: 100%;
      height: 80px;
      color: #fff;
      text-align: center;
    }

    .dayCell:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .dayCell.assigned {
      background: #aaa;
    }

    .cellTitle {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #333;
    }

    .cellDayName {
      font-size: 0.75rem;
      color: #555;
    }

    .cellTimeslotLabel {
      margin-top: 4px;
      padding: 3px 6px;
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
      display: inline-block;
      background-color: #007bff;
    }

    .deleteIcon {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 1rem;
      color: #fff;
      display: none;
      cursor: pointer;
    }

    .dayCell.assigned:hover .deleteIcon {
      display: block;
    }

    /* نموذج تنسيب الشفت للموظفين */
    .assignForm {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    #departmentsSelect {
      width: 100%;
      min-height: 50px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px;
    }

    #employeesContainer {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
      max-height: 200px;
      overflow: auto;
    }

    .empItem {
      border-bottom: 1px dashed #ccc;
      padding: 4px;
    }
  </style>
</head>

<body onload="initPage()">
  <header>
    <h1 data-lng="shifts_header_title">إدارة الشفتات</h1>
    <div>
      <button onclick="logout()" data-lng="shifts_logout">خروج</button>
      <select id="langSelector">
        <option value="en">English</option>
        <option value="ar" selected>العربية</option>
      </select>
    </div>
  </header>

  <!-- شاشة التحميل -->
  <div class="loadingOverlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <!-- المحتوى الرئيسي -->
    <div class="mainContent">
      <div class="errorMsg" id="errorMsg"></div>
      <div class="successMsg" id="successMsg"></div>

      <button class="addBtn" onclick="openMainModalForAdd()" data-lng="shifts_button_add">إضافة شفت</button>

      <!-- جدول الشفتات -->
      <table>
        <thead>
          <tr>
            <th data-lng="shifts_table_index">#</th>
            <th data-lng="shifts_table_shiftName">اسم الشفت</th>
            <th data-lng="shifts_table_cycleUnit">نوع الدورة</th>
            <th data-lng="shifts_table_cycleLength">طول الدورة</th>
            <th data-lng="shifts_table_createdAt">تاريخ الإنشاء</th>
            <th data-lng="shifts_table_control">التحكم</th>
          </tr>
        </thead>
        <tbody id="shiftTableBody">
          <!-- سيتم ملؤه ديناميكياً -->
        </tbody>
      </table>
    </div>

    <!-- الشريط الجانبي -->
    <div class="sidebar">
      <h2 data-lng="sidebarTitle"></h2>
      <div class="navItem" onclick="location.href='dashboard.html'">
        <i class="bi bi-house-fill"></i>
        <span data-lng="navOverview"></span>
      </div>
      <div class="navItem" onclick="location.href='employee.html'">
        <i class="bi bi-people-fill"></i>
        <span data-lng="navEmployees"></span>
      </div>
      <div class="navItem" onclick="location.href='report.html'">
        <i class="bi bi-bar-chart-line-fill"></i>
        <span data-lng="navReport"></span>
      </div>
      <div class="navItem" onclick="location.href='time-based-leaves.html'">
        <i class="bi bi-clock-fill"></i>
        <span data-lng="navTimeLeaves"></span>
      </div>
      <div class="navItem" onclick="location.href='holidays.html'">
        <i class="bi bi-calendar-event-fill"></i>
        <span data-lng="navHolidays"></span>
      </div>
      <div class="navItem" onclick="location.href='leaves.html'">
        <i class="bi bi-calendar3"></i>
        <span data-lng="navLeaves"></span>
      </div>
      <div class="navItem" onclick="location.href='attend.html'">
        <i class="bi bi-journal-check"></i>
        <span data-lng="navAttend"></span>
      </div>
      <div class="navItem" onclick="location.href='rewards.html'">
        <i class="bi bi-gift-fill"></i>
        <span data-lng="navRewards"></span>
      </div>
      <div class="navItem" onclick="location.href='devices.html'">
        <i class="bi bi-device-hdd-fill"></i>
        <span data-lng="navDevices"></span>
      </div>
      <div class="navItem" onclick="location.href='requests.html'">
        <i class="bi bi-list-check"></i>
        <span data-lng="navRequests"></span>
      </div>
      <div class="navItem" onclick="location.href='department.html'">
        <i class="bi bi-building"></i>
        <span data-lng="navDepartment"></span>
      </div>
      <!-- <div class="navItem" onclick="location.href='settings.html'">
              <i class="bi bi-gear-fill"></i>
              <span data-lng="navSettings"></span>
            </div> -->
      <div class="navItem" onclick="location.href='importemployee.html'">
        <i class="bi bi-person-exclamation"></i>
        <span data-lng="attend_sidebar_unregistered"></span>
      </div>
      <div class="navItem" onclick="location.href='employee-summary-report.html'">
        <i class="bi bi-people-fill"></i>
        <span data-lng="employee_summary_report"></span>
      </div>
      <div class="navItem" onclick="location.href='leaves-type.html'">
        <i class="bi bi-briefcase-fill"></i>
        <span data-lng="leaves_type">أنواع الإجازات</span>
      </div>
      <div class="navItem" onclick="location.href='public-settings.html'">
        <i class="bi bi-gear"></i>
        <span data-lng="public_settings"></span>
      </div>
      <div class="navItem active" onclick="location.href='shifts.html'">
        <i class="bi bi-hourglass-split"></i>
        <span data-lng="navshift"></span>
      </div>
      <div class="navItem " onclick="location.href='TimeSlot.html'">
        <i class="bi bi-watch"></i>
        <span data-lng="navSlot"></span>
      </div>

    </div>
  </div>



  <!-- مودال الشفت (إضافة/تعديل/نسخ) -->
  <div class="modalOverlay" id="mainModal">
    <div class="modalContent">
      <div class="modalHeader">
        <h2 id="mainModalTitle" data-lng="shifts_modal_title_add">إضافة شفت</h2>
        <button class="modalCloseBtn" onclick="closeMainModal()">×</button>
      </div>
      <div class="modalBody">
        <!-- القائمة اليسرى: TimeSlots -->
        <div style="width:250px; flex-shrink:0; border-left:1px solid #eee; background:#fafafa; padding:10px;">
          <p class="tsListTitle" data-lng="modal_ts_list_title">قائمة TimeSlots</p>
          <div id="tsListContainer"></div>
        </div>
        <!-- الجزء الأيمن: نموذج الشفت + شبكة الأيام -->
        <div style="flex:1; display:flex; flex-direction:column; padding:20px;">
          <div class="shiftForm">
            <div class="shiftFormRow">
              <div class="formGroup">
                <label data-lng="modal_label_shiftName">اسم الشفت:</label>
                <input type="text" id="shiftNameInput" data-lng-placeholder="modal_placeholder_shiftName"
                  placeholder="مثال: Morning Shift" />
              </div>
              <div class="formGroup">
                <label data-lng="modal_label_cycleUnit">نوع الدورة (Week/Month):</label>
                <select id="cycleUnitInput">
                  <option value="Week">أسبوع</option>
                  <option value="Month">شهر</option>
                </select>
              </div>
              <div class="formGroup">
                <label data-lng="modal_label_cycleLength">طول الدورة (رقم):</label>
                <input type="number" id="cycleLengthInput" value="7" min="1" />
              </div>
              <div class="formGroup">
                <label data-lng="modal_label_cycleStartDate">بداية الدورة (تاريخ):</label>
                <input type="date" id="cycleStartDateInput" />
              </div>
            </div>
            <!-- حقل مخفي للاحتفاظ بـ _id -->
            <input type="hidden" id="shiftDbId" />
            <!-- إخفاء الجيك بوكس -->
            <input type="checkbox" id="autoShiftChk" />
            <input type="checkbox" id="weeklyOvertimeChk" />
          </div>

          <div style="margin-top:10px;">
            <button class="btnClearAll" onclick="clearAllAssignments()" data-lng="modal_button_clearAll">مسح
              الكل</button>
          </div>
          <div class="daysGrid" id="daysGrid">
            <!-- سيتم ملؤه بالأيام -->
          </div>

          <div style="margin-top:10px;">
            <button class="btnSaveShift" onclick="saveCurrentShift()" data-lng="modal_button_save_shift">حفظ
              الشفت</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- مودال تنسيب الشفت للموظفين -->
  <div class="modalOverlay" id="assignModal">
    <div class="modalContent">
      <div class="modalHeader">
        <h2 id="assignModalTitle" data-lng="assign_modal_title">تنسيب الشفت للموظفين</h2>
        <button class="modalCloseBtn" onclick="closeAssignModal()">×</button>
      </div>
      <div class="modalBody">
        <div class="assignForm">
          <label data-lng="assign_modal_label_departments">اختر الأقسام (يمكن اختيار أكثر من قسم):</label>
          <select id="departmentsSelect" multiple></select>

          <button style="margin-top:6px;" onclick="fetchEmployeesForSelectedDepartments()"
            data-lng="assign_modal_button_fetch_employees">جلب الموظفين</button>

          <div id="employeesContainer"></div>

          <button
            style="margin-top:10px; background:#28a745; color:#fff; border:none; padding:8px 14px; border-radius:4px; cursor:pointer;"
            onclick="assignShiftToEmployees()" data-lng="assign_modal_button_assign_shift">
            تنسيب الشفت
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // آلية الترجمة الديناميكية
    // -----------------------------
    const LANG_KEY = 'lng';
    const SHIFTS_LANG_PATH = './lang';
    let translations = {};

    function getTranslate(key) {
      return translations[key] || "";
    }

    async function loadLanguageFile(lang) {
      try {
        const response = await fetch(`${SHIFTS_LANG_PATH}/${lang}_shifts.json`);
        if (!response.ok) {
          throw new Error(`Error loading ${lang}_shifts.json`);
        }
        translations = await response.json();
      } catch (error) {
        console.error("Shifts translation file error:", error);
      }
    }

    function applyTranslations(lang) {
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-lng]').forEach(el => {
        const key = el.getAttribute('data-lng');
        if (translations[key]) {
          el.textContent = translations[key];
        }
      });
      document.querySelectorAll('[data-lng-placeholder]').forEach(el => {
        const key = el.getAttribute('data-lng-placeholder');
        if (translations[key]) {
          el.placeholder = translations[key];
        }
      });
    }

    async function setLanguage(lang) {
      await loadLanguageFile(lang);
      localStorage.setItem(LANG_KEY, lang);
      applyTranslations(lang);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      let storedLang = localStorage.getItem(LANG_KEY) || 'ar';
      await loadLanguageFile(storedLang);
      applyTranslations(storedLang);
    });

    document.getElementById('langSelector').addEventListener('change', async function () {
      await setLanguage(this.value);
    });

    // -----------------------------
    // سكربت إدارة الشفتات
    // -----------------------------
    const authToken = localStorage.getItem('authToken') || "";
    const baseUrl = "";
    let shiftsData = [];
    let timeSlotsData = [];
    let editingShiftId = null;
    let daysAssignments = {};
    let selectedTimeSlot = null;
    let assignShiftId = null;
    let departmentsData = [];
    let employeesData = [];
    const dayNames = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];

    function initPage() {
      loadAllShifts();
      loadAllTimeSlots();
      fetchAllDepartments();
    }

    function logout() {
      localStorage.removeItem('authToken');
      window.location.href = 'login.html';
    }

    async function loadAllShifts() {
      showLoading();
      try {
        const resp = await fetch(`${baseUrl}/api/shifts`, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getTranslate("shifts_error_fetch_shifts"));
        shiftsData = await resp.json();
        renderShiftsTable();
      } catch (err) {
        showError(err.message);
      } finally {
        hideLoading();
      }
    }

    function renderShiftsTable() {
      const tb = document.getElementById('shiftTableBody');
      tb.innerHTML = '';
      shiftsData.forEach((sh, idx) => {
        const cdate = sh.createdAt ? new Date(sh.createdAt).toLocaleString() : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${sh.shiftName || ''}</td>
          <td>${sh.cycleUnit || ''}</td>
          <td>${sh.cycleLength || 7}</td>
          <td>${cdate}</td>
          <td>
            <i class="bi bi-pencil-fill actionIcon" title="${getTranslate("shifts_table_edit")}" onclick="openMainModalForEdit('${sh._id}')"></i>
            <i class="bi bi-files actionIcon" title="${getTranslate("shifts_table_copy")}" onclick="copyShift('${sh._id}')"></i>
            <i class="bi bi-people-fill actionIcon" title="${getTranslate("shifts_table_assign")}" onclick="openAssignModal('${sh._id}')"></i>
            <i class="bi bi-trash-fill actionIcon" title="${getTranslate("shifts_table_delete")}" onclick="deleteShift('${sh._id}')"></i>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    async function loadAllTimeSlots() {
      try {
        const resp = await fetch(`${baseUrl}/api/timeslots`, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getTranslate("shifts_error_fetch_timeslots"));
        timeSlotsData = await resp.json();
      } catch (err) {
        console.log(err.message);
      }
    }

    function openMainModalForAdd() {
      editingShiftId = null;
      document.getElementById('mainModalTitle').textContent = getTranslate("shifts_modal_title_add");
      document.getElementById('shiftDbId').value = '';
      document.getElementById('shiftNameInput').value = '';
      document.getElementById('cycleUnitInput').value = 'Week';
      document.getElementById('cycleLengthInput').value = '7';
      let today = new Date();
      today = fixToPreviousSunday(today);
      document.getElementById('cycleStartDateInput').value = formatDateForInput(today);
      document.getElementById('autoShiftChk').checked = false;
      document.getElementById('weeklyOvertimeChk').checked = false;
      daysAssignments = {};
      selectedTimeSlot = null;
      buildTimeSlotsList();
      buildDaysGrid();
      showMainModal();
    }

    async function openMainModalForEdit(shiftId) {
      editingShiftId = shiftId;
      try {
        showLoading();
        const resp = await fetch(`${baseUrl}/api/shifts/${shiftId}`, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getTranslate("shifts_error_fetch_shift"));
        const result = await resp.json();
        const sh = result.data;
        document.getElementById('mainModalTitle').textContent = getTranslate("shifts_modal_title_edit");
        document.getElementById('shiftDbId').value = sh._id;
        document.getElementById('shiftNameInput').value = sh.shiftName || '';
        document.getElementById('cycleUnitInput').value = sh.cycleUnit || 'Week';
        document.getElementById('cycleLengthInput').value = sh.cycleLength || (sh.cycleUnit === 'Month' ? 30 : 7);
        if (sh.cycleStartDate) {
          let dt = new Date(sh.cycleStartDate);
          dt = fixToPreviousSunday(dt);
          document.getElementById('cycleStartDateInput').value = formatDateForInput(dt);
        } else {
          let today = new Date();
          today = fixToPreviousSunday(today);
          document.getElementById('cycleStartDateInput').value = formatDateForInput(today);
        }
        document.getElementById('autoShiftChk').checked = !!sh.autoShift;
        document.getElementById('weeklyOvertimeChk').checked = !!sh.weeklyOvertime;
        daysAssignments = {};
        if (Array.isArray(sh.daysMap)) {
          sh.daysMap.forEach(d => {
            daysAssignments[d.dayIndex] = d.timeSlot;
          });
        }
        selectedTimeSlot = null;
        buildTimeSlotsList();
        buildDaysGrid();
        showMainModal();
      } catch (err) {
        showError(err.message);
      } finally {
        hideLoading();
      }
    }

    async function copyShift(shiftId) {
      editingShiftId = null;
      try {
        showLoading();
        const resp = await fetch(`${baseUrl}/api/shifts/${shiftId}`, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getTranslate("shifts_error_fetch_shift"));
        const result = await resp.json();
        const sh = result.data;
        document.getElementById('mainModalTitle').textContent = getTranslate("shifts_modal_title_copy");
        document.getElementById('shiftDbId').value = '';
        document.getElementById('shiftNameInput').value = '';
        document.getElementById('cycleUnitInput').value = sh.cycleUnit || 'Week';
        document.getElementById('cycleLengthInput').value = sh.cycleLength || (sh.cycleUnit === 'Month' ? 30 : 7);
        if (sh.cycleStartDate) {
          let dt = new Date(sh.cycleStartDate);
          dt = fixToPreviousSunday(dt);
          document.getElementById('cycleStartDateInput').value = formatDateForInput(dt);
        } else {
          let today = new Date();
          today = fixToPreviousSunday(today);
          document.getElementById('cycleStartDateInput').value = formatDateForInput(today);
        }
        daysAssignments = {};
        if (Array.isArray(sh.daysMap)) {
          sh.daysMap.forEach(d => {
            daysAssignments[d.dayIndex] = d.timeSlot;
          });
        }
        selectedTimeSlot = null;
        buildTimeSlotsList();
        buildDaysGrid();
        showMainModal();
      } catch (err) {
        showError(err.message);
      } finally {
        hideLoading();
      }
    }

    function buildTimeSlotsList() {
      const container = document.getElementById('tsListContainer');
      container.innerHTML = '';
      timeSlotsData.forEach(ts => {
        let d = document.createElement('div');
        d.className = 'tsItem';
        let colorBg = ts.color || '#007bff';
        d.innerHTML = `
          <div class="tsTitle" style="background-color:${colorBg};">
            ${ts.name}
          </div>
          <div class="tsTimeRange">
            ${ts.startTime} - ${ts.endTime}
          </div>
        `;
        d.addEventListener('click', () => {
          document.querySelectorAll('.tsItem').forEach(x => x.classList.remove('selected'));
          d.classList.add('selected');
          selectedTimeSlot = ts;
        });
        container.appendChild(d);
      });
    }

    function buildDaysGrid() {
      let grid = document.getElementById('daysGrid');
      grid.innerHTML = '';
      let cycleLen = +document.getElementById('cycleLengthInput').value || 7;
      for (let i = 0; i < cycleLen; i++) {
        let dayOrdinal = getArabicOrdinal(i + 1);
        let dayName = dayNames[i % 7];
        let cell = document.createElement('div');
        cell.className = 'dayCell';
        cell.style.backgroundColor = '#f9f9f9';
        cell.innerHTML = `
          <div class="cellTitle">${getTranslate("shifts_day_title")} ${dayOrdinal}</div>
          <div class="cellDayName">${dayName}</div>
        `;
        if (daysAssignments[i]) {
          cell.classList.add('assigned');
          cell.style.backgroundColor = '#aaa';
          const ts = daysAssignments[i];
          let labelBg = ts.color || '#007bff';
          cell.innerHTML += `
            <div class="cellTimeslotLabel" style="background-color:${labelBg};">
              ${ts.name}
            </div>
            <i class="bi bi-x-circle-fill deleteIcon" onclick="removeAssignment(${i}, event)"></i>
          `;
        }
        cell.addEventListener('click', (ev) => {
          if (ev.target.classList.contains('deleteIcon')) return;
          if (!selectedTimeSlot) {
            alert(getTranslate("shifts_alert_select_timeslot"));
            return;
          }
          daysAssignments[i] = selectedTimeSlot;
          buildDaysGrid();
        });
        grid.appendChild(cell);
      }
    }

    function clearAllAssignments() {
      daysAssignments = {};
      buildDaysGrid();
    }
    function removeAssignment(dayIndex, ev) {
      ev.stopPropagation();
      delete daysAssignments[dayIndex];
      buildDaysGrid();
    }
    function showMainModal() {
      document.getElementById('mainModal').style.display = 'flex';
    }
    function closeMainModal() {
      document.getElementById('mainModal').style.display = 'none';
    }
    async function deleteShift(shiftId) {
      if (!confirm(getTranslate("shifts_confirm_delete"))) return;
      showLoading();
      try {
        const resp = await fetch(`${baseUrl}/api/shifts/${shiftId}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getTranslate("shifts_error_delete"));
        showSuccess(getTranslate("shifts_success_delete"));
        loadAllShifts();
      } catch (err) {
        showError(err.message);
      } finally {
        hideLoading();
      }
    }
    function showAssignModal() {
      document.getElementById('assignModal').style.display = 'flex';
    }
    function closeAssignModal() {
      document.getElementById('assignModal').style.display = 'none';
    }
    function openAssignModal(shiftId) {
      assignShiftId = shiftId;
      document.getElementById('assignModalTitle').textContent = getTranslate("assign_modal_title") + " (Shift ID = " + shiftId + ")";
      document.getElementById('departmentsSelect').value = null;
      document.getElementById('employeesContainer').innerHTML = '';
      showAssignModal();
    }
    async function fetchAllDepartments() {
      try {
        const resp = await fetch(`${baseUrl}/api/departments`, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getTranslate("shifts_error_fetch_departments"));
        departmentsData = await resp.json();
        renderDepartmentsSelect();
      } catch (err) {
        console.error(err);
      }
    }
    function renderDepartmentsSelect() {
      const sel = document.getElementById('departmentsSelect');
      sel.innerHTML = '';
      let optAll = document.createElement('option');
      optAll.value = '__ALL__';
      optAll.textContent = getTranslate("assign_modal_option_all_departments");
      sel.appendChild(optAll);
      departmentsData.forEach(dep => {
        let opt = document.createElement('option');
        opt.value = dep.department_name;
        opt.textContent = dep.department_name;
        sel.appendChild(opt);
      });
    }
    async function fetchEmployeesForSelectedDepartments() {
      const sel = document.getElementById('departmentsSelect');
      const selectedVals = Array.from(sel.selectedOptions).map(o => o.value);
      document.getElementById('employeesContainer').innerHTML = '';
      employeesData = [];
      showLoading();
      try {
        if (selectedVals.includes('__ALL__')) {
          let url = `${baseUrl}/api/employees?page=1&limit=99999`;
          const resp = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error(getTranslate("assign_error_fetch_employees"));
          let arr = await resp.json();
          employeesData = arr.data;
        } else {
          for (let depName of selectedVals) {
            if (depName === '__ALL__') continue;
            let url = `${baseUrl}/api/employees?department=${encodeURIComponent(depName)}&page=1&limit=99999`;
            const resp = await fetch(url, {
              headers: { 'Authorization': 'Bearer ' + authToken }
            });
            if (!resp.ok) {
              let t = await resp.text();
              throw new Error(getTranslate("assign_error_fetch_employees") + " " + depName + ": " + t);
            }
            let arr = await resp.json();
            employeesData = employeesData.concat(arr.data);
          }
        }
        renderEmployeesList();
      } catch (err) {
        showError(err.message);
      } finally {
        hideLoading();
      }
    }
    function renderEmployeesList() {
      const cont = document.getElementById('employeesContainer');
      cont.innerHTML = '';
      employeesData.forEach(emp => {
        let d = document.createElement('div');
        d.className = 'empItem';
        d.textContent = `ID:${emp._id} - ${emp.name} (${emp.department || ''})`;
        cont.appendChild(d);
      });
    }
    async function assignShiftToEmployees() {
      if (!assignShiftId) {
        alert(getTranslate("assign_alert_no_shift"));
        return;
      }
      if (!employeesData || employeesData.length === 0) {
        alert(getTranslate("assign_alert_no_employees"));
        return;
      }
      showLoading();
      try {
        for (let emp of employeesData) {
          let bodyObj = {
            card: emp.card || "",
            department: emp.department || "",
            department_id: emp.department_id || "",
            enroll_id: emp.enroll_id || 0,
            joining_date: emp.joining_date || null,
            leave_date: emp.leave_date || null,
            main_salary: emp.main_salary || 0,
            name: emp.name || "",
            scheduleMode: "shift",
            shift_id: assignShiftId,
            week_zone: 0
          };
          let url = `${baseUrl}/api/employees/${emp._id}`;
          const resp = await fetch(url, {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(bodyObj)
          });
          if (!resp.ok) {
            let t = await resp.text();
            throw new Error(`فشل تحديث الموظف ${emp._id}: ${t}`);
          }
        }
        showSuccess(getTranslate("assign_success"));
        closeAssignModal();
      } catch (err) {
        showError(err.message);
      } finally {
        hideLoading();
      }
    }
    function fixToPreviousSunday(dateObj) {
      const day = dateObj.getDay();
      if (day !== 0) {
        dateObj.setDate(dateObj.getDate() - day);
      }
      return dateObj;
    }
    function formatDateForInput(dateObj) {
      const year = dateObj.getFullYear();
      const month = String(dateObj.getMonth() + 1).padStart(2, '0');
      const day = String(dateObj.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    function getArabicOrdinal(n) {
      const ordinals = [
        "الأول", "الثاني", "الثالث", "الرابع", "الخامس", "السادس", "السابع", "الثامن", "التاسع", "العاشر",
        "الحادي عشر", "الثاني عشر", "الثالث عشر", "الرابع عشر", "الخامس عشر", "السادس عشر", "السابع عشر",
        "الثامن عشر", "التاسع عشر", "العشرون", "الحادي والعشرون", "الثاني والعشرون", "الثالث والعشرون",
        "الرابع والعشرون", "الخامس والعشرون", "السادس والعشرون", "السابع والعشرون", "الثامن والعشرون",
        "التاسع والعشرون", "الثلاثون"
      ];
      return (n <= ordinals.length) ? ordinals[n - 1] : n;
    }
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
    function showError(msg) {
      const errEl = document.getElementById('errorMsg');
      errEl.textContent = msg;
      errEl.style.display = 'block';
      document.getElementById('successMsg').style.display = 'none';
    }
    function showSuccess(msg) {
      const sEl = document.getElementById('successMsg');
      sEl.textContent = msg;
      sEl.style.display = 'block';
      document.getElementById('errorMsg').style.display = 'none';
    }
    function clearMessages() {
      document.getElementById('errorMsg').style.display = 'none';
      document.getElementById('successMsg').style.display = 'none';
    }
  </script>
</body>

</html>