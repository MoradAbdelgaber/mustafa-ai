<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title data-lng="attend_head_title"></title>

  <!-- مكتبة jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- مكتبة Select2 (اختياري) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- أيقونات Bootstrap (لأيقونات التحرير والحذف) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- خط Tajawal وOpen Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Open+Sans:wght@400;700&display=swap"
    rel="stylesheet">

  <style>
    html {
      animation: fadeIn .3s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* عند العربية: Tajawal + RTL */
    html[lang="ar"] body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }

    /* عند الإنجليزية: Open Sans + LTR */
    html[lang="en"] body {
      font-family: 'Open Sans', sans-serif;
      direction: ltr;
    }

    /* زر اختيار اللغة */
    #langSelector {
      margin: 10px;
      padding: 6px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }

    /* رأس الصفحة */
    header {
      background: linear-gradient(45deg, #0062cc, #004085);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    header button {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    header button:hover {
      background: #c82333;
    }

    .container {
      display: flex;
      flex-direction: row-reverse;
    }

    .mainContent {
      flex: 1;
      padding: 20px;
    }

    .sidebar {
      width: 240px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      padding: 20px 10px;
    }

    .sidebar h2 {
      margin-bottom: 15px;
      font-size: 1rem;
      text-align: center;
      color: #444;
    }

    .navItem {
      padding: 12px 10px;
      margin: 6px 0;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      font-weight: 500;
      transition: background 0.3s, color 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navItem i {
      font-size: 1.1rem;
      color: #666;
      transition: color 0.3s;
    }

    .navItem:hover {
      background: #f0f0f0;
    }

    .navItem.active {
      background: #007bff;
      color: #fff;
    }

    .navItem.active i {
      color: #fff;
    }

    .errorMsg,
    .successMsg {
      margin: 10px 0;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .errorMsg {
      color: red;
    }

    .successMsg {
      color: green;
    }

    .addFingerprintBtn {
      background: #28a745;
      color: #fff;
      padding: 8px 14px;
      border-radius: 4px;
      margin-bottom: 15px;
      transition: background 0.3s;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
    }

    .addFingerprintBtn:hover {
      background: #218838;
    }

    .searchFilters {
      background: #fff;
      padding: 10px;
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .searchFilters label {
      margin-right: 4px;
      font-weight: 500;
    }

    .searchFilters select,
    .searchFilters input[type="date"],
    .searchFilters input[type="text"],
    .searchFilters input[type="datetime-local"] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .pagination button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.3s;
    }

    .pagination button:hover {
      background: #0056b3;
    }

    .pagination span {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .pagination button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    table thead {
      background: #007bff;
      color: #fff;
    }

    table th,
    table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
      vertical-align: middle;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    .modifiedRow {
      background-color: #fff7e6;
    }

    .actionIcon {
      cursor: pointer;
      font-size: 1rem;
      margin: 0 5px;
      transition: color 0.3s;
    }

    .actionIcon:hover {
      opacity: 0.8;
    }

    .iconEdit {
      color: #007bff;
    }

    .iconDelete {
      color: #dc3545;
    }

    .modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modalContent {
      width: 400px;
      max-width: 90%;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: fadeInModal 0.3s ease;
      position: relative;
    }

    @keyframes fadeInModal {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modalHeader {
      background: #007bff;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modalHeader h2 {
      margin: 0;
      font-size: 1rem;
    }

    .modalCloseBtn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.3s;
    }

    .modalCloseBtn:hover {
      color: #ffdddd;
    }

    .modalBody {
      padding: 20px;
    }

    .modalBody label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 500;
    }

    .modalBody input,
    .modalBody select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    .modalSaveBtn {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px 14px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .modalSaveBtn:hover {
      background: #218838;
    }

    #loaderOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99999;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: #fff;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .tableRecordImage {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>

<body onload="initPage()">

  <!-- شريط الهيدر -->
  <header>
    <h1 data-lng="attend_head_title"></h1>
    <div>
      <button onclick="logout()" data-lng="attend_logout"></button>

      <select id="langSelector" class="lang-select">
        <option value="en">English</option>
        <option value="ar">العربية</option>
      </select>
    </div>
  </header>

  <!-- شاشة تحميل (لودينغ) -->
  <div id="loaderOverlay" data-lng="loading"></div>

  <!-- الحاوية العامة -->
  <div class="container">
    <!-- المحتوى الرئيسي -->
    <div class="mainContent">
      <div class="errorMsg" id="errorMsg"></div>
      <div class="successMsg" id="successMsg"></div>

      <!-- فلاتر البحث -->
      <div class="searchFilters">
        <label for="searchFrom" data-lng="attend_filter_from_label"></label>
        <input type="date" id="searchFrom" />

        <label for="searchTo" data-lng="attend_filter_to_label"></label>
        <input type="date" id="searchTo" />

        <label for="searchEnrollId" data-lng="attend_filter_enroll_label"></label>
        <input type="text" id="searchEnrollId" data-lng-placeholder="placeholder-ex" placeholder="" />

        <label for="searchEvent" data-lng="attend_filter_event_label"></label>
        <select id="searchEvent">
          <option value="" data-lng-option="attend_filter_event_label_all"></option>
          <option value="1" data-lng-option="attend_filter_event_label_attendance"></option>
          <option value="2" data-lng-option="attend_filter_event_label_enter"></option>
          <option value="3" data-lng-option="attend_filter_event_label_exit"></option>
          <option value="4" data-lng-option="attend_filter_event_label_vacation_enter"></option>
          <option value="5" data-lng-option="attend_filter_event_label_vacation_exit"></option>
        </select>

        <button data-lng="attend_filter_button_search" onclick="startSearch()"
          style="background: #17a2b8; color: #fff; border:none; padding: 8px 14px; border-radius:4px; cursor:pointer;">
        </button>
      </div>

      <!-- أقسام التصفح (Pagination) + زر عرض الكل -->
      <div class="pagination">
        <button id="prevPageBtn" onclick="prevPage()" data-lng="attend_pagination_prev"></button>
        <span id="pageInfo" data-lng="attend_pagination_info"></span>
        <button id="nextPageBtn" onclick="nextPage()" data-lng="attend_pagination_next"></button>
        <button onclick="showAllFingerprints()" style="background:#6c757d;"
          data-lng="attend_filter_button_showall"></button>
      </div>

      <!-- زر إضافة سجل بصمة -->
      <button class="addFingerprintBtn" onclick="openModalForAdd()" data-lng="attend_button_add_fingerprint">

      </button>

      <!-- جدول السجلات -->
      <table id="fingerprintsTable">
        <thead>
          <tr>
            <th>#</th>
            <th data-lng="attend_table_header_enroll"></th>
            <th data-lng="attend_table_header_name"></th>
            <th data-lng="attend_table_header_event"></th>
            <th data-lng="attend_table_header_time"></th>
            <th data-lng="attend_table_header_created"></th>
            <th data-lng="attend_table_header_device"></th>
            <th data-lng="attend_table_header_image"></th>
            <th data-lng="attend_table_header_actions"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- الشريط الجانبي -->
    <div class="sidebar">
      <h2 data-lng="attend_sidebar_title"></h2>
      <div class="navItem" onclick="location.href='dashboard.html'">
        <i class="bi bi-house-fill"></i>
        <span data-lng="attend_sidebar_overview"></span>
      </div>
      <div class="navItem" onclick="location.href='employee.html'">
        <i class="bi bi-people-fill"></i>
        <span data-lng="attend_sidebar_employees"></span>
      </div>
      <div class="navItem" onclick="location.href='report.html'">
        <i class="bi bi-bar-chart-line-fill"></i>
        <span data-lng="attend_sidebar_report"></span>
      </div>
      <div class="navItem" onclick="location.href='time-based-leaves.html'">
        <i class="bi bi-clock-fill"></i>
        <span data-lng="attend_sidebar_time_leaves"></span>
      </div>
      <div class="navItem" onclick="location.href='holidays.html'">
        <i class="bi bi-calendar-event-fill"></i>
        <span data-lng="attend_sidebar_holidays"></span>
      </div>
      <div class="navItem" onclick="location.href='leaves.html'">
        <i class="bi bi-calendar3"></i>
        <span data-lng="attend_sidebar_leaves"></span>
      </div>
      <div class="navItem active" onclick="location.href='attend.html'">
        <i class="bi bi-journal-check"></i>
        <span data-lng="attend_sidebar_attend"></span>
      </div>
      <div class="navItem" onclick="location.href='rewards.html'">
        <i class="bi bi-gift-fill"></i>
        <span data-lng="attend_sidebar_rewards"></span>
      </div>
      <div class="navItem" onclick="location.href='devices.html'">
        <i class="bi bi-device-hdd-fill"></i>
        <span data-lng="attend_sidebar_devices"></span>

      </div>
      <div class="navItem" onclick="location.href='requests.html'">
        <i class="bi bi-list-check"></i>
        <span data-lng="attend_sidebar_requests"></span>

      </div>
      <div class="navItem" onclick="location.href='department.html'">
        <i class="bi bi-building"></i>
        <span data-lng="attend_sidebar_departments"></span>

      </div>
      <!-- <div class="navItem" onclick="location.href='settings.html'">
        <i class="bi bi-gear-fill"></i>
        <span data-lng="attend_sidebar_settings"></span>
      </div> -->
      <div class="navItem" onclick="location.href='importemployee.html'">
        <i class="bi bi-person-exclamation"></i>
        <span data-lng="attend_sidebar_unregistered"></span>
      </div>
      <div class="navItem" onclick="location.href='employee-summary-report.html'">
        <i class="bi bi-people-fill"></i>
        <span data-lng="employee_summary_report"></span>
      </div>
      <div class="navItem" onclick="location.href='leaves-type.html'">
        <i class="bi bi-briefcase-fill"></i>
        <span data-lng="leaves_type">أنواع الإجازات</span>
      </div>
      <div class="navItem" onclick="location.href='public-settings.html'">
        <i class="bi bi-gear"></i>
        <span data-lng="public_settings"></span>
      </div>
    </div>
  </div>

  <!-- مودال "إضافة/تعديل سجل بصمة" -->
  <div class="modalOverlay" id="fingerprintModal">
    <div class="modalContent">
      <div class="modalHeader">
        <h2 id="modalTitle" data-lng="attend_button_add_fingerprint"></h2>
        <button class="modalCloseBtn" onclick="closeModal()">×</button>
      </div>
      <div class="modalBody">
        <input type="hidden" id="fingerprintId" />

        <label for="employeeSelect" data-lng="attend_modal_label_employee"></label>
        <select id="employeeSelect" style="width:100%;"></select>

        <label for="enrollIdInput" data-lng="attend_modal_label_enroll"></label>
        <input type="text" id="enrollIdInput" readonly data-lng-placeholder="it_will_be_filled_automatically"
          placeholder="" />

        <label for="nameInput" data-lng="attend_modal_label_name"></label>
        <input type="text" id="nameInput" readonly data-lng-placeholder="it_will_be_filled_automatically"
          placeholder="" />

        <label for="eventSelect" data-lng="attend_filter_event_label"></label>
        <select id="eventSelect">
          <option value="1" data-lng-option="not_none"></option>
          <option value="2" data-lng-option="attend_filter_event_label_enter"></option>
          <option value="3" data-lng-option="attend_filter_event_label_exit"></option>
          <option value="4" data-lng-option="attend_filter_event_label_vacation_enter"></option>
          <option value="5" data-lng-option="attend_filter_event_label_vacation_exit"></option>
        </select>

        <label for="timeInput" data-lng="attend_modal_label_time"></label>
        <input type="datetime-local" id="timeInput" />

        <!-- حقل سبب التعديل (يظهر فقط في وضع التعديل) -->
        <label for="modificationReasonInput" id="modReasonLabel" style="display:none;"
          data-lng="attend_modal_label_modreason"></label>
        <input type="text" id="modificationReasonInput" style="display:none;"
          data-lng-placeholder="enter_attend_modal_label_modreason" placeholder="" />

        <button class="modalSaveBtn" onclick="saveFingerprint()" data-lng="attend_modal_button_save"></button>
      </div>
    </div>
  </div>



  <!-- preview image -->
  <div class="modalOverlay" id="imagePreview">
    <div class="modalContent" style="width: 500px;height: 500px;">

      <div class="img" style="width: 100%;height: 100%;">
        <img src="./images/no_image.png" style="width: 100%;height: 100%;">
      </div>

    </div>
  </div>




  <!-- كل الأكواد الأصلية للجافاسكربت (لا حذف) -->
  <script>
    let authToken = null;

    // متغيرات التصفح
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 10;

    let employees = [];

    const LANG_PATH = './lang';        // مجلد ملفات JSON
    const LANG_KEY = 'attend';
    let translations = {};
    function getTranslate(key) { return translations[key] || '' }

    async function loadLanguageFile(lang) {
      try {

        console.log(`${LANG_PATH}/${lang}_${LANG_KEY}.json`);


        const response = await fetch(`${LANG_PATH}/${lang}_${LANG_KEY}.json`);
        if (!response.ok) {
          throw new Error(`Error loading ${lang}.json`);
        }

        translations = await response.json();
      } catch (error) {
        console.error("Error loading translation file:", error);
      }
    }

    function applyTranslations(lang) {
      // تغيير اتجاه الصفحة ولغتها
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';

      // طبيق النصوص على العناصر data-lng="..."
      document.querySelectorAll('[data-lng]').forEach(el => {
        const key = el.getAttribute('data-lng');
        if (translations[key]) {
          el.textContent = translations[key];
        }
      });

      // تطبيق placeholder
      document.querySelectorAll('[data-lng-placeholder]').forEach(el => {
        const key = el.getAttribute('data-lng-placeholder');
        if (translations[key]) {
          el.placeholder = translations[key];
        }
      });

      // تطبيق نص للأوبشن
      document.querySelectorAll('[data-lng-option]').forEach(el => {
        const key = el.getAttribute('data-lng-option');
        if (translations[key]) {
          el.textContent = translations[key];
        }
      });

      document.querySelectorAll('[data-lng-hover-title]').forEach(el => {
        const key = el.getAttribute('data-lng-hover-title');
        if (translations[key]) {
          el.setAttribute('title', translations[key])
        }
      });


    }

    function getStringByKey(key) {
      const text = translations[key];
      return text
    }


    async function setLanguage(lang) {
      await loadLanguageFile(lang);
      localStorage.setItem("lng", lang);
      applyTranslations(lang);
    }



    function initPage() {
      authToken = localStorage.getItem('authToken');
      if (!authToken) {
        window.location.href = 'login.html';
        return;
      }

      loadEmployees();
      setupSelect2();

      loadFingerprints(1);


      let storedLang = localStorage.getItem("lng");
      if (!storedLang) {
        storedLang = 'en'; // افتراضي إنجليزي
      }
      loadLanguageFile(storedLang);
      document.getElementById('langSelector').value = storedLang;
      setLanguage(storedLang);



    }

    // تغيير اللغة من الـselect
    document.getElementById('langSelector').addEventListener('change', async function () {
      await setLanguage(this.value);
      localStorage.setItem("lng", this.value)
      setupSelect2();
    });


    function setupSelect2() {
      const text = getStringByKey("select_employee");
      console.log(text);

      $(document).ready(function () {

        $('#employeeSelect').select2({
          width: '100%',
          placeholder: text,
          dropdownParent: $('#fingerprintModal .modalBody')
        });
        $('#employeeSelect').on('change', onEmployeeSelectChange);
      });
    }

    function showLoader(show) {
      document.getElementById('loaderOverlay').style.display = show ? 'flex' : 'none';
    }

    function logout() {
      localStorage.removeItem('authToken');
      window.location.href = 'login.html';
    }

    function startSearch() {
      loadFingerprints(1);
    }
    function showAllFingerprints() {
      loadFingerprints(0);
    }

    async function loadFingerprints(pageNumber) {
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      const fromVal = document.getElementById('searchFrom').value;
      const toVal = document.getElementById('searchTo').value;
      const enrollVal = document.getElementById('searchEnrollId').value.trim();
      const eventVal = document.getElementById('searchEvent').value;

      let queryParams = [];
      if (fromVal) queryParams.push(`from=${fromVal}`);
      if (toVal) queryParams.push(`to=${toVal}`);
      if (enrollVal) queryParams.push(`enrollid=${enrollVal}`);
      if (eventVal) queryParams.push(`event=${eventVal}`);

      if (pageNumber !== 0) {
        queryParams.push(`page=${pageNumber}`);
        queryParams.push(`limit=${pageSize}`);
      } else {
        queryParams.push(`page=0`);
      }

      const queryString = queryParams.length ? `?${queryParams.join('&')}` : '';

      showLoader(true);
      try {
        const resp = await fetch('https://timeattendhr.com/api/fingerprints' + queryString, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) {
          const text = getStringByKey("attend_msg_error_fetch");
          throw new Error(text);
        }
        const data = await resp.json();

        let fingerprints = data.logs || data.data || [];
        currentPage = data.page || 1;
        totalPages = data.totalPages || 1;

        if (data.page === 0) {
          currentPage = 0;
          totalPages = 1;
        }

        renderFingerprints(fingerprints);
        updatePaginationUI();
      } catch (err) {
        errorMsg.textContent = err.message;
        console.error(err);
      } finally {
        showLoader(false);
      }
    }

    function updatePaginationUI() {
      const pageInfo = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');

      if (currentPage === 0) {
        const text = getStringByKey("view_all_records");
        pageInfo.textContent = text;
        prevBtn.disabled = true;
        nextBtn.disabled = true;
      } else {
        const text = `${getStringByKey("page")} ${currentPage} ${getStringByKey('from')} ${totalPages}`;
        pageInfo.textContent = text;
        prevBtn.disabled = (currentPage <= 1);
        nextBtn.disabled = (currentPage >= totalPages);
      }
    }
    function prevPage() {
      if (currentPage > 1) {
        loadFingerprints(currentPage - 1);
      }
    }
    function nextPage() {
      if (currentPage < totalPages) {
        loadFingerprints(currentPage + 1);
      }
    }

    document.getElementById('imagePreview').addEventListener('click', (event) => {
      if (event.target.matches('img')) return
      const modal = document.getElementById('imagePreview')
      modal.style.display = 'none'
    })

    function previewImage(src) {
      if (!src) return
      const modal = document.getElementById('imagePreview')
      const img = modal.querySelector('img')
      modal.style.display = 'flex'
      img.src = src
    }

    function renderFingerprints(arr) {
      const tb = document.querySelector('#fingerprintsTable tbody');
      tb.innerHTML = '';

      arr.forEach((item, index) => {
        let createdAt = item.createdAt
          ? new Date(item.createdAt).toISOString().split('T')[0]
          : '';

        let eventText = '';
        switch (item.event) {
          case 1: eventText = getStringByKey("attend_filter_event_label_attendance"); break;
          case 2: eventText = getStringByKey("attend_filter_event_label_enter"); break;
          case 3: eventText = getStringByKey("attend_filter_event_label_exit"); break;
          case 4: eventText = getStringByKey("attend_filter_event_label_vacation_enter"); break;
          case 5: eventText = getStringByKey("attend_filter_event_label_vacation_exit"); break;
          default: eventText = getStringByKey("not_none");
        }

        let timeVal = item.time ? new Date(item.time).toLocaleString() : '';

        let imageSrc = item.image
          ? 'data:image/png;base64,' + item.image
          : './images/no_image.png';

        const tr = document.createElement('tr');

        if (item.modified_time) {
          tr.classList.add('modifiedRow');
        }

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${item.enrollid || ''}</td>
          <td>${item.name || ''}</td>
          <td>${eventText}</td>
          <td>${timeVal}</td>
          <td>${createdAt}</td>
          <td>${item.device_name || ''}</td>
          <td>
            <img 
                src="${imageSrc}" onclick='previewImage("${imageSrc}")'
                alt="${getTranslate('image')}"
                class="tableRecordImage"
                onerror="this.onerror=null;this.src='./images/no_image.png';" />
          </td>
          <td>
            <i class="bi bi-pencil-square actionIcon iconEdit" data-lng-hover-title='edit'
                title=${getTranslate('edit')}
                onclick="openModalForEdit('${item._id}')"></i>
            <i class="bi bi-trash actionIcon iconDelete" data-lng-hover-title='delete'
                title=${getTranslate('delete')}
                onclick="deleteFingerprint('${item._id}')"></i>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    async function loadEmployees() {
      showLoader(true);
      try {
        const resp = await fetch('https://timeattendhr.com/api/employees?page=1&limit=9999', {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getStringByKey("attend_msg_error_fetch_employees"));

        const data = await resp.json();
        employees = data.data || [];

        const sel = document.getElementById('employeeSelect');
        sel.innerHTML = '';

        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = getStringByKey("select_employee"),

          sel.appendChild(defaultOpt);

        employees.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e._id;
          opt.textContent = e.name || (`${getStringByKey("employee")} ` + e.enroll_id);
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
      } finally {
        showLoader(false);
      }
    }

    function onEmployeeSelectChange() {
      const sel = document.getElementById('employeeSelect');
      const selectedVal = sel.value;
      const emp = employees.find(e => e._id == selectedVal);
      if (emp) {
        document.getElementById('enrollIdInput').value = emp.enroll_id || '';
        document.getElementById('nameInput').value = emp.name || '';
      } else {
        document.getElementById('enrollIdInput').value = '';
        document.getElementById('nameInput').value = '';
      }
    }

    function openModalForAdd() {
      // document.getElementById('modalTitle').textContent = 'إضافة سجل بصمة';
      document.getElementById('fingerprintId').value = '';

      document.getElementById('employeeSelect').value = '';
      $('#employeeSelect').trigger('change.select2');
      onEmployeeSelectChange();

      document.getElementById('eventSelect').value = '1';
      document.getElementById('timeInput').value = '';

      document.getElementById('modReasonLabel').style.display = 'none';
      document.getElementById('modificationReasonInput').style.display = 'none';
      document.getElementById('modificationReasonInput').value = '';

      showFingerprintModal(true);
    }

    async function openModalForEdit(id) {
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      showLoader(true);
      try {
        const resp = await fetch(`https://timeattendhr.com/api/fingerprints/${id}`, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getStringByKey("attend_msg_error_fetch_one"));
        const item = await resp.json();

        if (item.modified_time) {
          showLoader(false);
          alert(getStringByKey("attend_msg_already_modified"));
          return;
        }

        document.getElementById('modalTitle').textContent = getStringByKey("attend_modal_edit_title");
        document.getElementById('fingerprintId').value = item._id || '';

        let emp = employees.find(e => e.enroll_id == item.enrollid);
        if (emp) {
          document.getElementById('employeeSelect').value = emp._id || '';
        } else {
          document.getElementById('employeeSelect').value = '';
        }
        $('#employeeSelect').trigger('change.select2');
        onEmployeeSelectChange();

        document.getElementById('eventSelect').value = item.event || '1';

        if (item.time) {
          let dt = new Date(item.time);
          // let localVal = dt.toISOString().slice(0, 16);
          // document.getElementById('timeInput').value = localVal;

          let offset = dt.getTimezoneOffset() * 60000; // Convert minutes to milliseconds
          let localTime = new Date(dt.getTime() - offset).toISOString().slice(0, 16);

          document.getElementById('timeInput').value = localTime;

        } else {
          document.getElementById('timeInput').value = '';
        }

        document.getElementById('modReasonLabel').style.display = 'block';
        document.getElementById('modificationReasonInput').style.display = 'block';
        document.getElementById('modificationReasonInput').value = '';

        showFingerprintModal(true);
      } catch (err) {
        errorMsg.textContent = err.message;
        console.error(err);
      } finally {
        showLoader(false);
      }
    }

    async function saveFingerprint() {
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      const fingerprintId = document.getElementById('fingerprintId').value;

      const enrollIdVal = document.getElementById('enrollIdInput').value.trim();
      const nameVal = document.getElementById('nameInput').value.trim();
      const eventVal = parseInt(document.getElementById('eventSelect').value, 10);
      const timeVal = document.getElementById('timeInput').value;
      const reasonVal = document.getElementById('modificationReasonInput').value.trim();

      let isoTime = timeVal ? new Date(timeVal).toISOString() : '';

      const bodyObj = {
        enrollid: enrollIdVal ? +enrollIdVal : null,
        name: nameVal,
        event: eventVal,
        time: isoTime
      };

      if (fingerprintId) {
        bodyObj.modification_reason = reasonVal || '';
      }

      showLoader(true);
      try {
        let url = 'https://timeattendhr.com/api/fingerprints';
        let method = 'POST';
        if (fingerprintId) {
          url = `https://timeattendhr.com/api/fingerprints/${fingerprintId}`;
          method = 'PUT';
        }

        const resp = await fetch(url, {
          method,
          headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bodyObj)
        });
        if (!resp.ok) {
          const errorData = await resp.json().catch(() => ({ message: 'حدث خطأ' }));
          const text = getStringByKey('operation_failed');
          throw new Error(errorData.message || text);
        }

        successMsg.textContent = fingerprintId
          ? getStringByKey("attend_msg_success_edit")
          : getStringByKey("attend_msg_success_add");

        showFingerprintModal(false);
        loadFingerprints(currentPage);
      } catch (err) {
        errorMsg.textContent = err.message;
        console.error(err);
      } finally {
        showLoader(false);
      }
    }

    async function deleteFingerprint(id) {
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      if (!confirm(getStringByKey("attend_msg_confirm_delete"))) return;

      showLoader(true);
      try {
        const resp = await fetch(`https://timeattendhr.com/api/fingerprints/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getStringByKey("record_deletion_failed"));

        successMsg.textContent = getStringByKey("attend_msg_success_delete");
        loadFingerprints(currentPage);
      } catch (err) {
        errorMsg.textContent = err.message;
        console.error(err);
      } finally {
        showLoader(false);
      }
    }

    function showFingerprintModal(show) {
      const modal = document.getElementById('fingerprintModal');
      modal.style.display = show ? 'flex' : 'none';

      if (!show) {
        document.getElementById('fingerprintId').value = '';
        // document.getElementById('modalTitle').textContent = 'إضافة سجل بصمة';
        document.getElementById('employeeSelect').value = '';
        $('#employeeSelect').trigger('change.select2');
        document.getElementById('enrollIdInput').value = '';
        document.getElementById('nameInput').value = '';
        document.getElementById('eventSelect').value = '1';
        document.getElementById('timeInput').value = '';
        document.getElementById('modificationReasonInput').value = '';
        document.getElementById('modReasonLabel').style.display = 'none';
        document.getElementById('modificationReasonInput').style.display = 'none';
      }
    }
    function closeModal() {
      showFingerprintModal(false);
    }
  </script>

  <!-- سكربت الترجمة -->
  <script>
    // const ATTEND_LANG_KEY = 'attendance_lang'; // نفس المفتاح المستخدم في بقية الصفحات
    const ATTEND_LANG_KEY = 'lng'; // نفس المفتاح المستخدم في بقية الصفحات

    const ATTEND_LANG_PATH = './lang';         // ضع فيه ar_attend.json و en_attend.json

    async function loadAttendLangFile(lang) {
      try {
        const response = await fetch(`${ATTEND_LANG_PATH}/${lang}_attend.json`);
        if (!response.ok) {
          throw new Error(`Error loading ${lang}_attend.json`);
        }
        attendTranslations = await response.json();
      } catch (error) {
        console.error("Attendance translation file error:", error);
      }
    }


    window.addEventListener('DOMContentLoaded', async () => {
      let storedLang = localStorage.getItem(ATTEND_LANG_KEY);

      if (!storedLang) {
        // لو أردت الإنجليزية افتراضية، استبدل بـ 'en'
        storedLang = 'ar';
      }
      await loadAttendLangFile(storedLang);
      // applyAttendTranslations(storedLang);
    });
  </script>
</body>

</html>