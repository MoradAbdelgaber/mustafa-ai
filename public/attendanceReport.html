<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>تقرير الحضور المتكامل</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <style>
    html {
      animation: fadeIn .3s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      margin: 1rem;
      background-color: #f7f7f7;
    }

    h1 {
      margin-bottom: 1rem;
    }

    .filters,
    .field-toggles {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .table-container {
      background-color: #fff;
      padding: 1rem;
      border-radius: 5px;
      overflow-x: auto;
    }

    .table thead {
      background-color: #e0e0e0;
    }

    .d-none {
      display: none !important;
    }
  </style>
</head>

<body dir="rtl">
  <h1>تقرير الحضور المتكامل</h1>

  <!-- حقل إدخال التوكن (اختياري) -->
  <div class="mb-3">
    <label for="tokenInput" class="form-label">التوكن (JWT) :</label>
    <input type="text" id="tokenInput" class="form-control" placeholder="Bearer ey..." />
  </div>

  <!-- الفلاتر -->
  <div class="filters">
    <div>
      <label class="form-label">الموظف</label>
      <select id="employeeSelect" class="form-select">
        <option value="0">جميع الموظفين</option>
        <option value="122">Salah (122)</option>
        <option value="125">Mahmoud (125)</option>
      </select>
    </div>

    <div>
      <label class="form-label">القسم</label>
      <select id="departmentSelect" class="form-select">
        <option value="0">جميع الأقسام</option>
        <option value="1">قسم البرمجة</option>
        <option value="2">قسم المبيعات</option>
      </select>
    </div>

    <div>
      <label class="form-label">من تاريخ</label>
      <input type="date" id="startDate" class="form-control" value="2025-01-01" />
    </div>

    <div>
      <label class="form-label">إلى تاريخ</label>
      <input type="date" id="endDate" class="form-control" value="2025-01-15" />
    </div>

    <div>
      <label class="form-label">عطلات رسمية</label>
      <select id="showOfficialHolidays" class="form-select">
        <option value="1" selected>نعم</option>
        <option value="0">لا</option>
      </select>
    </div>

    <div>
      <label class="form-label">عطلات أسبوعية</label>
      <select id="showWeeklyOff" class="form-select">
        <option value="1" selected>نعم</option>
        <option value="0">لا</option>
      </select>
    </div>

    <div>
      <button id="getReportBtn" class="btn btn-primary mt-4">عرض التقرير</button>
    </div>
    <div>
      <button id="printBtn" class="btn btn-success mt-4">طباعة</button>
    </div>
  </div>

  <!-- Checkboxes لإظهار/إخفاء الحقول -->
  <div class="field-toggles">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="toggleRestBreaks" checked>
      <label class="form-check-label" for="toggleRestBreaks">عرض الاستراحات</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="toggleDelay" checked>
      <label class="form-check-label" for="toggleDelay">عرض التأخير (دقائق)</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="toggleEarlyExit" checked>
      <label class="form-check-label" for="toggleEarlyExit">الخروج المبكر (دقائق)</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="toggleOvertime" checked>
      <label class="form-check-label" for="toggleOvertime">الأوفر تايم (دقائق)</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="toggleDailySalary" checked>
      <label class="form-check-label" for="toggleDailySalary">الراتب اليومي</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="toggleNetSalaryBefore" checked>
      <label class="form-check-label" for="toggleNetSalaryBefore">صافي الراتب قبل التقريب</label>
    </div>
  </div>

  <!-- الجدول -->
  <div class="table-container">
    <table class="table table-striped" id="attendanceTable">
      <thead>
        <tr>
          <th>#</th>
          <th>الموظف</th>
          <th>التاريخ</th>
          <th>وقت الدخول</th>
          <th>وقت الخروج</th>
          <th>ساعات العمل</th>
          <th>الحالة</th>
          <th>صافي الراتب</th>

          <!-- أعمدة إضافية -->
          <th class="colRestBreaks">الاستراحات</th>
          <th class="colDelay">التأخير</th>
          <th class="colEarlyExit">الخروج المبكر</th>
          <th class="colOvertime">الأوفر تايم</th>
          <th class="colDailySalary">الراتب اليومي</th>
          <th class="colNetBefore">صافي قبل التقريب</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // دالة رئيسية لعرض التقرير
    async function fetchReport() {
      const token = document.getElementById("tokenInput").value.trim();
      const employee_id = document.getElementById("employeeSelect").value;
      const department_id = document.getElementById("departmentSelect").value;
      const start_date = document.getElementById("startDate").value;
      const end_date = document.getElementById("endDate").value;
      const show_official_holidays = document.getElementById("showOfficialHolidays").value;
      const show_weekly_off_days = document.getElementById("showWeeklyOff").value;

      // عدل الرابط حسب سيرفرك
      const baseURL = "/api/reports/attendance";
      // بناة الاستعلام
      const query = `?start_date=${start_date}&end_date=${end_date}&employee_id=${employee_id}&department_id=${department_id}&show_official_holidays=${show_official_holidays}&show_weekly_off_days=${show_weekly_off_days}&timezone=Asia/Baghdad`;
      const fullURL = baseURL + query;

      try {
        const response = await fetch(fullURL, {
          method: 'GET',
          headers: {
            "Content-Type": "application/json",
            ...(token ? { "Authorization": token } : {})
          }
        });
        if (!response.ok) {
          throw new Error("HTTP Error: " + response.status);
        }
        const data = await response.json();
        populateTable(data);
      } catch (err) {
        console.error(err);
        alert("حدث خطأ: " + err.message);
      }
    }

    // تعبئة الجدول بالبيانات
    function populateTable(data) {
      const tbody = document.getElementById("attendanceTable").querySelector("tbody");
      tbody.innerHTML = "";

      data.forEach((item, index) => {
        const row = document.createElement("tr");

        // 1) العمود التسلسلي
        let tdIdx = document.createElement("td");
        tdIdx.textContent = (index + 1);
        row.appendChild(tdIdx);

        // 2) الموظف
        let tdEmployee = document.createElement("td");
        tdEmployee.textContent = item.employee_name || "";
        row.appendChild(tdEmployee);

        // 3) التاريخ
        let tdDate = document.createElement("td");
        tdDate.textContent = item.attendance_date || "";
        row.appendChild(tdDate);

        // 4) وقت الدخول
        let tdCin = document.createElement("td");
        tdCin.textContent = item.check_in || "";
        row.appendChild(tdCin);

        // 5) وقت الخروج
        let tdCout = document.createElement("td");
        tdCout.textContent = item.check_out || "";
        row.appendChild(tdCout);

        // 6) ساعات العمل
        let tdWH = document.createElement("td");
        tdWH.textContent = item.work_hours || 0;
        row.appendChild(tdWH);

        // 7) الحالة
        let tdStatus = document.createElement("td");
        tdStatus.textContent = item.attendance_status || "";
        row.appendChild(tdStatus);

        // 8) صافي الراتب
        let tdNet = document.createElement("td");
        tdNet.textContent = item.net_salary || 0;
        row.appendChild(tdNet);

        // أعمدة إضافية (افتراضيًا ظاهرة)
        // a) الاستراحات
        let tdRest = document.createElement("td");
        tdRest.classList.add("colRestBreaks");
        if (item.rest_breaks && item.rest_breaks.length > 0) {
          let arr = item.rest_breaks.map((b, i) => `استراحة ${i + 1}: [${b.rest_in} - ${b.rest_out}] (${b.duration}س)`);
          tdRest.textContent = arr.join("\n");
        } else {
          tdRest.textContent = "";
        }
        row.appendChild(tdRest);

        // b) التأخير
        let tdDelay = document.createElement("td");
        tdDelay.classList.add("colDelay");
        tdDelay.textContent = item.delay_minutes || 0;
        row.appendChild(tdDelay);

        // c) الخروج المبكر
        let tdEarly = document.createElement("td");
        tdEarly.classList.add("colEarlyExit");
        tdEarly.textContent = item.early_exit_minutes || 0;
        row.appendChild(tdEarly);

        // d) الأوفر تايم
        let tdOver = document.createElement("td");
        tdOver.classList.add("colOvertime");
        tdOver.textContent = item.overtime_minutes || 0;
        row.appendChild(tdOver);

        // e) الراتب اليومي
        let tdDaily = document.createElement("td");
        tdDaily.classList.add("colDailySalary");
        tdDaily.textContent = item.daily_salary || 0;
        row.appendChild(tdDaily);

        // f) صافي الراتب قبل التقريب
        let tdNetBefore = document.createElement("td");
        tdNetBefore.classList.add("colNetBefore");
        tdNetBefore.textContent = item.net_salary_before_rounding || 0;
        row.appendChild(tdNetBefore);

        tbody.appendChild(row);
      });
    }

    // التحكم في إظهار/إخفاء الأعمدة
    function toggleFields() {
      // لكل checkbox, إما نضيف/نزيل d-none من العمود
      const restCols = document.querySelectorAll(".colRestBreaks");
      const delayCols = document.querySelectorAll(".colDelay");
      const earlyCols = document.querySelectorAll(".colEarlyExit");
      const overCols = document.querySelectorAll(".colOvertime");
      const dailyCols = document.querySelectorAll(".colDailySalary");
      const netBeforeCols = document.querySelectorAll(".colNetBefore");

      // حسب حالة checkbox
      document.getElementById("toggleRestBreaks").checked
        ? restCols.forEach(c => c.classList.remove("d-none"))
        : restCols.forEach(c => c.classList.add("d-none"));

      document.getElementById("toggleDelay").checked
        ? delayCols.forEach(c => c.classList.remove("d-none"))
        : delayCols.forEach(c => c.classList.add("d-none"));

      document.getElementById("toggleEarlyExit").checked
        ? earlyCols.forEach(c => c.classList.remove("d-none"))
        : earlyCols.forEach(c => c.classList.add("d-none"));

      document.getElementById("toggleOvertime").checked
        ? overCols.forEach(c => c.classList.remove("d-none"))
        : overCols.forEach(c => c.classList.add("d-none"));

      document.getElementById("toggleDailySalary").checked
        ? dailyCols.forEach(c => c.classList.remove("d-none"))
        : dailyCols.forEach(c => c.classList.add("d-none"));

      document.getElementById("toggleNetSalaryBefore").checked
        ? netBeforeCols.forEach(c => c.classList.remove("d-none"))
        : netBeforeCols.forEach(c => c.classList.add("d-none"));
    }

    function printPage() {
      window.print();
    }

    // ربط الأزرار
    document.getElementById("getReportBtn").addEventListener("click", fetchReport);
    document.getElementById("printBtn").addEventListener("click", printPage);

    // ربط التغير في الـcheckbox
    document.getElementById("toggleRestBreaks").addEventListener("change", toggleFields);
    document.getElementById("toggleDelay").addEventListener("change", toggleFields);
    document.getElementById("toggleEarlyExit").addEventListener("change", toggleFields);
    document.getElementById("toggleOvertime").addEventListener("change", toggleFields);
    document.getElementById("toggleDailySalary").addEventListener("change", toggleFields);
    document.getElementById("toggleNetSalaryBefore").addEventListener("change", toggleFields);

    // عند التحميل الأولي للصفحة, نخفي/نظهر حسب checked الافتراضي
    window.addEventListener("load", toggleFields);
  </script>
</body>

</html>