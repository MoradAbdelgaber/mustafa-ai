<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم - تقرير الحضور مع ملخص إضافي (نص في employee_name)</title>
  <!-- مكتبات jQuery و Select2 (للبحث داخل الـselect) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- خط Tajawal من Google Fonts (مثال) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    html {
      animation: fadeIn .3s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* عند العربية: الخط Tajawal + RTL */
    html[lang="ar"] body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }

    /* عند الإنجليزية: الخط Open Sans + LTR */
    html[lang="en"] body {
      font-family: 'Open Sans', sans-serif;
      direction: ltr;
    }

    /* قلب ترتيب العنصرين (sidebar, mainContent) */
    html[lang="ar"] .container {
      display: flex;
      flex-direction: row-reverse;
      /* Sidebar على اليمين */
    }

    html[lang="en"] .container {
      display: flex;
      flex-direction: row;
      /* Sidebar على اليسار */
    }

    html[lang="ar"] .sidebar {
      order: 1;
    }

    html[lang="ar"] .mainContent {
      order: 0;
    }

    html[lang="en"] .sidebar {
      order: 0;
    }

    html[lang="en"] .mainContent {
      order: 1;
    }

    * {
      box-sizing: border-box;
      padding: 0;
      margin: 0;
    }

    .lang-select {
      margin-left: 10px;
      padding: 5px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* رأس الصفحة */
    header {
      background: linear-gradient(45deg, #0062cc, #004085);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    header button {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    header button:hover {
      background: #c82333;
    }

    /* الحاوية العامة بعكس الاتجاه لعرض الـSidebar يمينًا */
    .container {
      display: flex;
      flex-direction: row-reverse;
    }

    /* المحتوى الرئيسي */
    .mainContent {
      flex: 1;
      padding: 20px;
    }

    /* الشريط الجانبي (Sidebar) */
    .sidebar {
      width: 240px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      padding: 20px 10px;
    }

    .sidebar h2 {
      margin-bottom: 15px;
      font-size: 1rem;
      text-align: center;
      color: #444;
    }

    .navItem {
      padding: 12px 10px;
      margin: 6px 0;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      font-weight: 500;
      transition: background 0.3s, color 0.3s;
    }

    .navItem:hover {
      background: #f0f0f0;
    }

    .navItem.active {
      background: #007bff;
      color: #fff;
    }

    /* صناديق الفلاتر */
    .filters {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .filters label {
      margin-right: 6px;
      font-weight: 500;
    }

    .filters select,
    .filters input[type="date"],
    .filters input[type="month"],
    .filters input[type="week"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 140px;
      font-size: 0.9rem;
    }

    .filters button {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .filters button:hover {
      background: #0056b3;
    }

    /* بطاقات الملخص الإحصائي */
    .cards {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 220px;
      padding: 15px;
      text-align: center;
    }

    .card h3 {
      margin: 0;
      font-size: 1.1rem;
      margin-bottom: 8px;
      color: #444;
    }

    .card .value {
      font-size: 1.6rem;
      color: #007bff;
      font-weight: bold;
    }

    /* جدول الواجهة */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    table thead {
      background: #007bff;
      color: #fff;
    }

    table th,
    table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    .errorMsg {
      color: red;
      margin: 10px 0;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .summaryRow {
      background: #ffe5b4;
      font-weight: bold;
    }

    /* أزرار التصدير والطباعة */
    .exportPrintButtons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .exportPrintButtons button {
      background: #28a745;
      border: none;
      padding: 10px 14px;
      border-radius: 4px;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s;
    }

    .exportPrintButtons button:hover {
      background: #218838;
    }

    /* زر الطباعة بلون آخر */
    #customPrintBtn {
      background: #6f42c1;
    }

    #customPrintBtn:hover {
      background: #5a379c;
    }

    /* ====== تنسيقات المودال ====== */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    /* زر اختيار اللغة */
    #langSelector {
      margin: 10px;
      padding: 6px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 1000px;
      position: relative;
      direction: rtl;
    }

    .modal-header,
    .modal-body,
    .modal-footer {
      padding: 10px;
      margin-bottom: 10px;
    }

    .modal-header {
      border-bottom: 1px solid #ccc;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    .closeBtn {
      position: absolute;
      top: 15px;
      left: 15px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .modal-body {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .modal-footer {
      border-top: 1px solid #ccc;
      text-align: left;
    }

    .modal-footer button {
      background: #007bff;
      border: none;
      padding: 8px 14px;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    .modal-footer button:hover {
      background: #0056b3;
    }

    .columnToggleItem {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 0.9rem;
      border: 1px solid #ddd;
      padding: 8px;
      border-radius: 4px;
      background: #fafafa;
      width: 160px;
    }

    .columnToggleItem label {
      cursor: pointer;
      margin-bottom: 4px;
      display: inline-block;
    }

    .columnToggleItem input[type="text"] {
      width: 60px;
      margin-top: 2px;
      padding: 3px;
      text-align: center;
    }

    /* ألوان خاصة لصفوف التجميع */
    .deptHeaderRow {
      background-color: #cce5ff !important;
    }

    .empHeaderRow {
      background-color: #d4edda !important;
    }

    /* ===== قسم الملخص الإضافي من الـ API ===== */
    .apiSummaryContainer {
      display: none;
      background-color: #fefefe;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .apiSummaryHeader {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      background: linear-gradient(to right, #dee2e6, #e6e6e6);
      padding: 8px;
      border-radius: 4px;
      color: #333;
    }

    .apiSummaryGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
    }

    .apiSummaryField {
      background: #ffffff;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: background 0.3s;
      min-height: 80px;
    }

    .apiSummaryField:nth-child(2n) {
      background: #f8f9fa;
    }

    .apiSummaryField:hover {
      background: #f1f3f5;
    }

    .apiSummaryLabel {
      background-color: #e3f2fd;
      color: #333;
      font-weight: bold;
      margin-bottom: 5px;
      border-radius: 4px;
      width: 100%;
      padding: 5px;
      text-align: center;
    }

    .apiSummaryValue {
      font-size: 1.2rem;
      color: #007bff;
      font-weight: bold;
      margin-top: auto;
    }
  </style>
</head>

<body onload="initPage()">
  <header>
    <h1>لوحة التحكم - تقرير الحضور</h1>
    <div>
      <button onclick="logout()">خروج</button>
      <!-- اختيار اللغة (مثل صفحة اللوجن) -->
      <select id="langSelector" id="langSelector">
        <option value="en">English</option>
        <option value="ar">العربية</option>
      </select>
    </div>

  </header>
  <div class="container">
    <!-- المحتوى الرئيسي -->
    <div class="mainContent">

      <!-- أزرار التصدير والطباعة -->
      <div class="exportPrintButtons">
        <button id="exportExcelBtn" onclick="exportTableToExcel('reportTable', 'AttendanceReport')">
          <i class="bi bi-file-earmark-excel"></i>
          تصدير كـ Excel
        </button>
        <button id="customPrintBtn" onclick="printCustomReport()">
          <i class="bi bi-printer-fill"></i>
          طباعة بتصميم
        </button>

        <!-- زر فتح المودال -->
        <button style="background:#17a2b8;" onclick="openColumnModal()">
          <i class="bi bi-layout-sidebar-inset"></i>
          تخصيص الأعمدة
        </button>
      </div>

      <!-- فلاتر -->
      <div class="filters">
        <label for="weekSelect">الأسبوع:</label>
        <input type="week" id="weekSelect" onchange="onWeekChange()" />

        <label for="monthSelect" data-lng="month:">الشهر:</label>
        <input type="month" id="monthSelect" onchange="onMonthChange()" />

        <label for="startDate" data-lng="start_date:">من تاريخ:</label>
        <input type="date" id="startDate" value="2024-12-01" />

        <label for="endDate" data-lng="end_date:">إلى تاريخ:</label>
        <input type="date" id="endDate" value="2024-12-31" />

        <label for="employeeSelect" data-lng="employee:">الموظف:</label>
        <select id="employeeSelect">
          <option value="0" data-lng="all_employees">جميع الموظفين</option>
        </select>

        <label for="departmentSelect">القسم:</label>
        <select id="departmentSelect">
          <option value="0" data-lng="all_departments">جميع الأقسام</option>
        </select>

        <label for="statusSelect" data-lng="status:">الحالة:</label>
        <select id="statusSelect" onchange="renderReport()">
          <option value="" data-lng="all_statuses">جميع الحالات</option>
          <option value="absent" data-lng="absent">غائب</option>
          <option value="late" data-lng="late">متأخر</option>
          <option value="early_exit" data-lng="early_exit">خروج مبكر</option>
          <option value="present" data-lng="present">موجود</option>
          <option value="semi_present" data-lng="semi_present">حضور جزئي</option>
          <option value="late_and_early_exit" data-lng="late_and_early_exit">متأخر + خروج مبكر</option>
          <option value="overtime" data-lng="overtime">أوفر تايم</option>
        </select>

        <label>
          <input type="checkbox" id="groupByDeptCheckbox" onchange="renderReport()" data-lng="group_by_dept">
          <span>تجميع حسب القسم</span>
        </label>
        <label>
          <input type="checkbox" id="groupByEmpCheckbox" data-lng="group_by_emp" onchange="renderReport()">
          <span>تجميع حسب الموظف</span>
        </label>

        <!-- Checkbox إظهار الملخص الإضافي -->
        <label>
          <input type="checkbox" id="showApiSummaryCheckbox" data-lng="show_api_summary"
            onchange="toggleApiSummaryVisibility()">
          <span>إظهار ملخص الـ API الإضافي</span>
        </label>
        <button onclick="loadReport()">جلب التقرير</button>
      </div>

      <!-- قسم الملخص الإضافي من الـ API (مخفي افتراضيًا) -->
      <div id="apiSummaryContainer" class="apiSummaryContainer">
        <div class="apiSummaryHeader">ملخص إضافي من النظام</div>
        <div class="apiSummaryGrid" id="apiSummaryGrid"></div>
      </div>

      <!-- بطاقات الملخص الإحصائي -->
      <div class="cards">
        <div class="card">
          <h3>عدد السجلات</h3>
          <div class="value" id="recordsCount">-</div>
        </div>
        <div class="card">
          <h3>مجموع التأخير (دقيقة)</h3>
          <div class="value" id="delaySum">-</div>
        </div>
        <div class="card">
          <h3>مجموع الخروج المبكر (دقيقة)</h3>
          <div class="value" id="earlySum">-</div>
        </div>
        <div class="card">
          <h3>صافي الراتب الكلي</h3>
          <div class="value" id="netSum">-</div>
        </div>
      </div>

      <div class="errorMsg" id="errorMsg"></div>

      <!-- جدول العرض في الواجهة -->
      <table id="reportTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- القائمة الجانبية -->
    <div class="sidebar">
      <h2>القائمة</h2>
      <div class="navItem" onclick="location.href='dashboard.html'">
        <i class="bi bi-house-fill"></i>
        نظرة عامة
      </div>
      <div class="navItem" onclick="location.href='employee.html'">
        <i class="bi bi-people-fill"></i>
        الموظفين
      </div>
      <div class="navItem active" onclick="location.href='report.html'">
        <i class="bi bi-bar-chart-line-fill"></i>
        تقرير الحضور
      </div>
      <div class="navItem" onclick="location.href='time-based-leaves.html'">
        <i class="bi bi-clock-fill"></i>
        إجازات زمنية
      </div>
      <div class="navItem" onclick="location.href='holidays.html'">
        <i class="bi bi-calendar-event-fill"></i>
        العطل الرسمية
      </div>
      <div class="navItem" onclick="location.href='leaves.html'">
        <i class="bi bi-calendar3"></i>
        أجازات
      </div>
      <div class="navItem" onclick="location.href='attend.html'">
        <i class="bi bi-journal-check"></i>
        سجل الحضور
      </div>
      <div class="navItem" onclick="location.href='rewards.html'">
        <i class="bi bi-gift-fill"></i>
        مكافآت وعقوبات
      </div>
      <div class="navItem" onclick="location.href='devices.html'">
        <i class="bi bi-device-hdd-fill"></i>
        الأجهزة
      </div>
      <div class="navItem" onclick="location.href='requests.html'">
        <i class="bi bi-list-check"></i>
        الأوامر
      </div>
      <div class="navItem" onclick="location.href='department.html'">
        <i class="bi bi-building"></i>
        الأقسام
      </div>
      <div class="navItem" onclick="location.href='settings.html'">
        <i class="bi bi-gear-fill"></i>
        الإعدادات
      </div>
      <div class="navItem" onclick="location.href='importemployee.html'">
        <i class="bi bi-person-exclamation"></i>
        <span></span>
      </div>
      <div class="navItem" onclick="location.href='employee-summary-report.html'">
        <i class="bi bi-people-fill"></i>
        <span></span>
      </div>
    </div>
  </div>
  <!-- /container -->

  <!-- ===== مودال تخصيص الأعمدة ===== -->
  <div id="columnModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" onclick="closeColumnModal()">&times; إغلاق</button>
      <div class="modal-header">
        <h2>تخصيص الأعمدة</h2>
      </div>
      <div class="modal-body" id="modalColumnToggles">
        <!-- سيتم تعبئته ديناميكيًا بـ buildColumnToggles() -->
      </div>
      <div class="modal-footer">
        <button onclick="saveAndCloseModal()">حفظ وإغلاق</button>
      </div>
    </div>
  </div>
  <!-- /مودال -->

  <script>
    let authToken = null;         // سيُؤخذ من localStorage
    let originalReportData = [];  // بيانات الجدول
    let summaryRowData = null;    // صف الملخص (تأتي بياناته كنص في employee_name)

    // مصفوفة تصف جميع الأعمدة الممكنة في التقرير
    let allColumns = [];
    function initPage() {
      let storedLang = localStorage.getItem(LANG_KEY);
      document.getElementById('langSelector').value = storedLang;
      setLanguage(storedLang).then(() => {
        authToken = localStorage.getItem('authToken');
        if (!authToken) {
          window.location.href = 'login.html';
          return;
        }
        setTodayAsDefaultDate();
        loadEmployees();
        loadDepartments();

        // تفعيل البحث في الـselect
        $(document).ready(function () {
          // $('#employeeSelect').select2({ width: '150px', placeholder: 'اختر موظفًا' });
          // $('#departmentSelect').select2({ width: '150px', placeholder: 'اختر قسمًا' });
          // $('#statusSelect').select2({ width: '130px', placeholder: 'كل الحالات' });
        });
      });

    }
    // هنا لو لديك تسميات بالعربية لبعض الحقول.
    const knownLabels = {
      attendance_date: 'التاريخ',
      check_in: 'وقت الدخول',
      check_out: 'وقت الخروج',
      attendance_status: 'حالة الحضور',
      work_hours: 'ساعات العمل',
      net_salary: 'الراتب المالي',
      delay_minutes: 'تأخير (دقائق)',
      early_exit_minutes: 'خروج مبكر (دقائق)',
      status_code: 'رمز الحالة',
      employee_name: 'اسم الموظف',
      department_name: 'اسم القسم',
      // إن لديك حقل endDayOffset ضمن البيانات، تستطيع تسميته هنا:
      endDayOffset: 'عدد أيام +'
    };

    // الحقول التي نريد إظهارها بشكل افتراضي في الجدول
    const defaultVisibleFields = new Set([
      'attendance_date',
      'check_in',
      'check_out',
      'attendance_status',
      'work_hours',
      'net_salary'
    ]);

    // مفتاح لقراءة/تخزين إعدادات الأعمدة في localStorage
    const LOCAL_STORAGE_KEY = 'attendanceReportColumns';
    const LEAVES_LANG_KEY = 'language'; // Make sure the key is consistent across pages
    const LEAVES_LANG_PATH = './lang'; // Path to ar_leaves.json and en_leaves.json
    // دالة لتحويل العدد العشري لساعات ودقائق (مثال)
    function formatWorkHours(value) {
      if (!value) return '';
      const hoursDecimal = parseFloat(value);
      if (isNaN(hoursDecimal) || hoursDecimal <= 0) {
        return '';
      }
      const wholeHours = Math.floor(hoursDecimal);
      const minutes = Math.round((hoursDecimal - wholeHours) * 60);
      return `${wholeHours}س و ${minutes}د`;
    }

    // تنسيق رقم كراتب مثلاً (اضافة فواصل آلاف)
    function formatNetSalary(value) {
      let num = parseFloat(value);
      if (isNaN(num)) return '';
      return num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // دالة تحليل نص الملخص من employee_name
    function parseSummaryString(summaryText) {
      if (!summaryText || !summaryText.includes('=')) {
        return {};
      }
      const parts = summaryText.split('|');
      if (parts.length && parts[0].includes('المُلخص')) {
        parts.shift(); // إزالة الجزء الأول لو هو "--- المُلخص ---"
      }
      let result = {};
      for (let rawPart of parts) {
        let part = rawPart.trim();
        if (!part.includes('=')) continue;
        let [fieldName, fieldVal] = part.split('=');
        if (!fieldName) continue;
        fieldName = fieldName.trim();
        fieldVal = (fieldVal || '').trim();
        result[fieldName] = fieldVal;
      }
      return result;
    }

    // Function to set the language (load files and apply translations)
    async function setLanguage(lang) {
      await loadLanguageFile(lang);
      await loadReportLangFile(lang);
      localStorage.setItem(LANG_KEY, lang);
      applyTranslations(lang);
      applyReportTranslations(lang);
    }
    // Function to apply general translations
    function applyTranslations(lang) {
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';

      // Apply translations to elements with data-lng attribute (general translations)
      document.querySelectorAll('[data-lng]').forEach(el => {
        const key = el.getAttribute('data-lng');
        if (translations[key]) {
          if (el.tagName === 'OPTION') {
            el.textContent = translations[key]; // Apply translation to <option> text
          } else {
            el.textContent = translations[key]; // Apply translation to other elements
          }
        }
      });
      // Language selection event listener
      document.getElementById('langSelector').addEventListener('change', (event) => {
        const selectedLang = event.target.value;
        setLanguage(selectedLang);
      });
      // Apply translations to placeholders
      document.querySelectorAll('[data-lng-placeholder]').forEach(el => {
        const key = el.getAttribute('data-lng-placeholder');
        if (translations[key]) {
          el.placeholder = translations[key];
        }
      });

      // Apply translations to options
      document.querySelectorAll('[data-lng-option]').forEach(el => {
        const key = el.getAttribute('data-lng-option');
        if (translations[key]) {
          el.textContent = translations[key];
        }
      });
    }
    // Function to load the general language file
    async function loadLanguageFile(lang) {
      try {
        const response = await fetch(`${LEAVES_LANG_PATH}/${lang}_report.json`); // General lang file (e.g., en.json or ar.json)
        if (!response.ok) {
          throw new Error(`Error loading ${lang}.json`);
        }
        translations = await response.json();
      } catch (error) {
        console.error("Error loading translation file:", error);
      }
    }

    // Function to load the leaves language file
    async function loadLeavesLangFile(lang) {
      try {
        const response = await fetch(`${LEAVES_LANG_PATH}/${lang}_leaves.json`); // Specific leaves lang file (e.g., en_leaves.json or ar_leaves.json)
        if (!response.ok) {
          throw new Error(`Error loading ${lang}_leaves.json`);
        }
        leavesTranslations = await response.json();
      } catch (error) {
        console.error("Leaves translation file error:", error);
      }
    }

    function setTodayAsDefaultDate() {
      const todayStr = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = todayStr;
      document.getElementById('endDate').value = todayStr;
    }

    function onMonthChange() {
      const monthVal = document.getElementById('monthSelect').value;
      if (!monthVal) return;
      const [year, month] = monthVal.split('-');
      const lastDayDate = new Date(year, parseInt(month), 0).getDate();
      document.getElementById('startDate').value = `${year}-${month}-01`;
      document.getElementById('endDate').value = `${year}-${month}-${lastDayDate}`;
    }

    function onWeekChange() {
      const weekVal = document.getElementById('weekSelect').value;
      if (!weekVal) return;
      const [yearStr, weekStr] = weekVal.split('-W');
      const yearNum = parseInt(yearStr);
      const weekNum = parseInt(weekStr);
      if (isNaN(yearNum) || isNaN(weekNum)) return;

      const monday = getDateOfISOWeek(weekNum, yearNum);
      const sunday = new Date(monday);
      sunday.setDate(sunday.getDate() + 6);

      const startStr = monday.toISOString().split('T')[0];
      const endStr = sunday.toISOString().split('T')[0];

      document.getElementById('startDate').value = startStr;
      document.getElementById('endDate').value = endStr;
    }

    function getDateOfISOWeek(week, year) {
      const simple = new Date(year, 0, 1 + (week - 1) * 7);
      const dow = simple.getDay();
      let ISOweekStart = simple;
      if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
      else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
      return ISOweekStart;
    }

    async function loadEmployees() {
      const sel = document.getElementById('employeeSelect');
      try {
        const url = 'https://timeattendhr.com/api/employees?page=1&limit=9999';
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + authToken } });
        if (!resp.ok) throw new Error('فشل جلب قائمة الموظفين');
        const data = await resp.json();
        const arr = data.data || [];
        arr.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.enroll_id;
          opt.textContent = emp.name;
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function loadDepartments() {
      const sel = document.getElementById('departmentSelect');
      try {
        const url = 'https://timeattendhr.com/api/departments';
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + authToken } });
        if (!resp.ok) throw new Error('فشل جلب قائمة الأقسام');
        const data = await resp.json();
        data.forEach(dept => {
          const opt = document.createElement('option');
          opt.value = dept._id;
          opt.textContent = dept.department_name;
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
      }
    }

    async function loadReport() {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = '';

      // إعادة ضبط الملخص وإخفائه
      summaryRowData = null;
      document.getElementById('apiSummaryContainer').style.display = 'none';

      const startD = document.getElementById('startDate').value || '2024-12-01';
      const endD = document.getElementById('endDate').value || '2024-12-31';
      const empId = document.getElementById('employeeSelect').value || '0';
      const deptId = document.getElementById('departmentSelect').value || '0';

      let url = 'https://timeattendhr.com/api/reports/attendance';
      url += `?start_date=${startD}&end_date=${endD}`;
      url += `&employee_id=${empId}`;
      url += `&department_id=${deptId}`;
      url += '&show_official_holidays=1&show_weekly_off_days=1';

      try {
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + authToken } });
        if (!resp.ok) throw new Error('فشل جلب التقرير: ' + resp.status);

        const data = await resp.json();
        originalReportData = data;

        // ابحث عن صف الملخص
        const summaryIndex = originalReportData.findIndex(r => r.attendance_status === '-- SUMMARY --');
        if (summaryIndex > -1) {
          let summaryText = originalReportData[summaryIndex].employee_name || '';
          let parsedSummary = parseSummaryString(summaryText);
          summaryRowData = parsedSummary;
          originalReportData.splice(summaryIndex, 1);
        }

        // بناء الأعمدة
        buildAllColumnsFromData();
        loadColumnConfigFromLocalStorage();
        renderReport();

        // لو وجدنا ملخص
        if (summaryRowData && Object.keys(summaryRowData).length > 0) {
          buildApiSummarySection(summaryRowData);
          toggleApiSummaryVisibility(); // تحترم حالة الـ checkbox
        }
      } catch (err) {
        errorMsg.textContent = err.message;
      }
    }

    function buildAllColumnsFromData() {
      const fields = new Set();
      originalReportData.forEach(row => {
        Object.keys(row).forEach(f => fields.add(f));
      });

      allColumns = [];
      fields.forEach(fieldName => {
        const isDefault = defaultVisibleFields.has(fieldName);

        let defaultWidth = '100px';
        if (fieldName === 'attendance_date') defaultWidth = '120px';
        if (fieldName === 'attendance_status') defaultWidth = '130px';
        if (fieldName === 'check_in' || fieldName === 'check_out') defaultWidth = '100px';
        if (fieldName === 'work_hours') defaultWidth = '70px';
        if (fieldName === 'net_salary') defaultWidth = '100px';

        let label = knownLabels[fieldName] || fieldName;

        allColumns.push({
          field: fieldName,
          label: label,
          checked: isDefault,
          width: defaultWidth
        });
      });

      // ترتيب الحقول: الافتراضية أولًا
      allColumns.sort((a, b) => {
        const av = a.checked ? 0 : 1;
        const bv = b.checked ? 0 : 1;
        return av - bv;
      });
    }

    function loadColumnConfigFromLocalStorage() {
      const savedConfig = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (!savedConfig) return;
      try {
        const configArr = JSON.parse(savedConfig);
        configArr.forEach(cfg => {
          const colObj = allColumns.find(c => c.field === cfg.field);
          if (colObj) {
            colObj.checked = cfg.checked;
            colObj.width = cfg.width;
          }
        });
      } catch (e) {
        console.warn('فشل قراءة إعدادات الأعمدة من localStorage', e);
      }
    }

    function saveColumnConfigToLocalStorage() {
      const configToSave = allColumns.map(c => ({
        field: c.field,
        checked: c.checked,
        width: c.width
      }));
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(configToSave));
    }

    function buildColumnToggles() {
      const container = document.getElementById('modalColumnToggles');
      container.innerHTML = '';

      allColumns.forEach(col => {
        const div = document.createElement('div');
        div.classList.add('columnToggleItem');
        div.innerHTML = `
          <label>
            <input type="checkbox" data-field="${col.field}" ${col.checked ? 'checked' : ''}/>
            ${col.label}
          </label>
          <input type="text" data-fieldwidth="${col.field}" value="${col.width}" />
        `;
        container.appendChild(div);
      });
    }

    function openColumnModal() {
      buildColumnToggles();
      const modal = document.getElementById('columnModal');
      modal.style.display = 'block';
    }

    function closeColumnModal() {
      const modal = document.getElementById('columnModal');
      modal.style.display = 'none';
    }

    function saveAndCloseModal() {
      const checkboxes = document.querySelectorAll('#modalColumnToggles input[type="checkbox"]');
      checkboxes.forEach(chk => {
        const field = chk.getAttribute('data-field');
        const col = allColumns.find(c => c.field === field);
        if (col) {
          col.checked = chk.checked;
        }
      });

      const widthInputs = document.querySelectorAll('#modalColumnToggles input[data-fieldwidth]');
      widthInputs.forEach(inp => {
        const field = inp.getAttribute('data-fieldwidth');
        const col = allColumns.find(c => c.field === field);
        if (col) {
          col.width = inp.value;
        }
      });

      saveColumnConfigToLocalStorage();
      renderReport();
      closeColumnModal();
    }

    function groupRows(data, groupByDept, groupByEmp) {
      const groupedData = {};
      data.forEach(row => {
        let deptKey = "All Departments";
        if (groupByDept) {
          deptKey = row.department_name || "بدون قسم";
        }

        let empKey = "All Employees";
        if (groupByEmp) {
          empKey = row.employee_name || "بدون اسم";
        }

        if (!groupedData[deptKey]) {
          groupedData[deptKey] = {};
        }
        if (!groupedData[deptKey][empKey]) {
          groupedData[deptKey][empKey] = [];
        }
        groupedData[deptKey][empKey].push(row);
      });
      return groupedData;
    }

    function getSummaryRowHtml(count, sumDelay, sumEarly, sumNet, colSpan) {
      return `
        <tr class="summaryRow">
          <td colspan="${colSpan}">
            <table style="width:100%; border-collapse:collapse;">
              <tr>
                <td style="background-color:#d1ecf1; text-align:center; font-weight:bold;">عدد السجلات</td>
                <td style="background-color:#d1ecf1; text-align:center;">${count}</td>
                
                <td style="background-color:#d4edda; text-align:center; font-weight:bold;">مجموع التأخير (دقيقة)</td>
                <td style="background-color:#d4edda; text-align:center;">${sumDelay}</td>
                
                <td style="background-color:#fff3cd; text-align:center; font-weight:bold;">مجموع الخروج المبكر (دقيقة)</td>
                <td style="background-color:#fff3cd; text-align:center;">${sumEarly}</td>
                
                <td style="background-color:#f8d7da; text-align:center; font-weight:bold;">صافي الراتب الكلي</td>
                <td style="background-color:#f8d7da; text-align:center;">${sumNet}</td>
              </tr>
            </table>
          </td>
        </tr>
      `;
    }

    function renderReport() {
      try {
        // Check if required data is available
        // if (!window.allColumns || !window.originalReportData) {
        //   console.error('Missing necessary data: allColumns or originalReportData is undefined.');
        //   return;
        // }

        const statusVal = document.getElementById('statusSelect').value;
        const tableHead = document.querySelector('#reportTable thead');
        const tableBody = document.querySelector('#reportTable tbody');

        // Clear existing table data
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        const displayedColumns = allColumns.filter(c => c.checked);

        // Ensure displayedColumns has valid columns
        if (displayedColumns.length === 0) {
          console.error('No columns are selected for display.');
          return;
        }

        // Build table header
        let theadHtml = '<tr>';
        displayedColumns.forEach(col => {
          theadHtml += `<th style="width:${col.width};">${col.label}</th>`;
        });
        theadHtml += '</tr>';
        tableHead.innerHTML = theadHtml;

        // Filter data based on selected status
        let filteredData = originalReportData.filter(row => {
          if (!statusVal) return true;
          return row.status_code === statusVal;
        });

        // Ensure filteredData is not empty
        if (filteredData.length === 0) {
          console.warn('No data matches the selected status.');
        }

        // Get grouping options
        const groupByDept = document.getElementById('groupByDeptCheckbox').checked;
        const groupByEmp = document.getElementById('groupByEmpCheckbox').checked;

        // Group data
        const groupedData = groupRows(filteredData, groupByDept, groupByEmp);

        // Ensure groupRows returns a valid object
        if (!groupedData || typeof groupedData !== 'object') {
          console.error('groupRows() did not return valid data.');
          return;
        }

        let count = 0;
        let sumDelay = 0;
        let sumEarly = 0;
        let sumNet = 0;
        let rowsHtml = '';

        // Generate table rows
        Object.keys(groupedData).forEach(deptKey => {
          if (groupByDept && deptKey !== 'All Departments') {
            rowsHtml += `
          <tr class="deptHeaderRow">
            <td colspan="${displayedColumns.length}" style="text-align:right; font-weight:bold;">
              قسم: ${deptKey}
            </td>
          </tr>
        `;
          }

          Object.keys(groupedData[deptKey]).forEach(empKey => {
            if (groupByEmp && empKey !== 'All Employees') {
              rowsHtml += `
            <tr class="empHeaderRow">
              <td colspan="${displayedColumns.length}" style="text-align:right; font-weight:bold;">
                الموظف: ${empKey}
              </td>
            </tr>
          `;
            }

            groupedData[deptKey][empKey].forEach(row => {
              count++;
              sumDelay += (row.delay_minutes || 0);
              sumEarly += (row.early_exit_minutes || 0);
              sumNet += (row.net_salary || 0);

              let trHtml = '<tr>';
              displayedColumns.forEach(col => {
                let cellVal = row[col.field] || '';

                // Format check_in/check_out times if needed
                if ((col.field === 'check_in' || col.field === 'check_out') && cellVal.includes(' ')) {
                  cellVal = cellVal.split(' ')[1];
                }

                // Additional formatting for work_hours and net_salary
                if (col.field === 'work_hours' && cellVal) {
                  cellVal = formatWorkHours(cellVal);
                }
                if (col.field === 'net_salary' && cellVal) {
                  cellVal = formatNetSalary(cellVal);
                }

                let cellStyle = `width:${col.width};`;
                if (col.field === 'attendance_status') {
                  switch (row.status_code) {
                    case 'absent': cellStyle += 'background-color:#ffd4d4;'; break;
                    case 'late': cellStyle += 'background-color:#fff5d4;'; break;
                    case 'early_exit': cellStyle += 'background-color:#ffe9d4;'; break;
                    case 'present': cellStyle += 'background-color:#d4ffd4;'; break;
                    case 'semi_present': cellStyle += 'background-color:#d4ffff;'; break;
                    case 'late_and_early_exit': cellStyle += 'background-color:#ffe6ff;'; break;
                    case 'overtime': cellStyle += 'background-color:#e6ffe6;'; break;
                  }
                }
                trHtml += `<td style="${cellStyle}">${cellVal}</td>`;
              });
              trHtml += '</tr>';
              rowsHtml += trHtml;
            });
          });
        });

        // Append rows to the table body
        tableBody.innerHTML = rowsHtml;

        // Update summary information
        document.getElementById('recordsCount').textContent = count;
        document.getElementById('delaySum').textContent = sumDelay;
        document.getElementById('earlySum').textContent = sumEarly;
        const sumNetFormatted = formatNetSalary(sumNet);
        document.getElementById('netSum').textContent = sumNetFormatted;

        // Add summary row if data exists
        if (count > 0) {
          const summaryRowHtml = getSummaryRowHtml(count, sumDelay, sumEarly, sumNetFormatted, displayedColumns.length);
          tableBody.innerHTML += summaryRowHtml;
        }
      } catch (error) {
        console.error('Error in renderReport():', error);
      }
    }

    function buildApiSummarySection(parsedSummary) {
      const gridContainer = document.getElementById('apiSummaryGrid');
      gridContainer.innerHTML = '';

      for (let key in parsedSummary) {
        let val = parsedSummary[key] || '';
        if (!isNaN(val) && val.trim() !== '') {
          let num = parseFloat(val);
          val = num.toLocaleString('en-US', { maximumFractionDigits: 2 });
        }

        const divField = document.createElement('div');
        divField.className = 'apiSummaryField';
        divField.innerHTML = `
          <div class="apiSummaryLabel">${key}</div>
          <div class="apiSummaryValue">${val}</div>
        `;
        gridContainer.appendChild(divField);
      }
    }

    function toggleApiSummaryVisibility() {
      const container = document.getElementById('apiSummaryContainer');
      const checkbox = document.getElementById('showApiSummaryCheckbox');
      if (!summaryRowData) {
        container.style.display = 'none';
        return;
      }
      container.style.display = checkbox.checked ? 'block' : 'none';
    }

    function exportTableToExcel(tableID, filename = '') {
      let table = document.getElementById(tableID);
      if (!table) return;
      let tableHTML = table.outerHTML.replace(/ /g, '%20');
      filename = filename ? (filename + '.xls') : 'excel_data.xls';
      let downloadLink = document.createElement("a");
      document.body.appendChild(downloadLink);
      downloadLink.href = 'data:application/vnd.ms-excel;charset=utf-8,' + tableHTML;
      downloadLink.download = filename;
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    function chunkArray(array, chunkSize) {
      const results = [];
      for (let i = 0; i < array.length; i += chunkSize) {
        results.push(array.slice(i, i + chunkSize));
      }
      return results;
    }

    function printCustomReport() {
      const startDate = document.getElementById('startDate').value || '';
      const endDate = document.getElementById('endDate').value || '';
      const statusVal = document.getElementById('statusSelect').value;

      let filteredData = [...originalReportData];
      if (statusVal) {
        filteredData = filteredData.filter(row => row.status_code === statusVal);
      }

      const groupByDept = document.getElementById('groupByDeptCheckbox').checked;
      const groupByEmp = document.getElementById('groupByEmpCheckbox').checked;
      const groupedData = groupRows(filteredData, groupByDept, groupByEmp);

      const chunkSize = 32;
      const pagesData = [];

      Object.keys(groupedData).forEach(deptKey => {
        Object.keys(groupedData[deptKey]).forEach(empKey => {
          const rows = groupedData[deptKey][empKey];
          const chunked = chunkArray(rows, chunkSize);
          chunked.forEach(chunk => {
            pagesData.push({
              deptName: (groupByDept && deptKey !== 'All Departments') ? deptKey : null,
              empName: (groupByEmp && empKey !== 'All Employees') ? empKey : null,
              rows: chunk
            });
          });
        });
      });

      const displayedColumns = allColumns.filter(c => c.checked);

      const printWindow = window.open('', '', 'width=1200,height=700');

      printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
          <meta charset="UTF-8">
          <title>تقرير الحضور</title>
          <style>
            @page {
              size: A4 portrait;
              margin: 20mm;
            }
            body {
              margin: 0;
              padding: 0;
              font-family: 'Tajawal', sans-serif;
              font-size: 14px;
            }
            .page {
              width: 100%;
              page-break-after: always;
              margin-bottom: 20px;
            }
            .last-page {
              page-break-after: auto;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 1rem;
            }
            th, td {
              border: 1px solid #000;
              padding: 6px 8px;
              text-align: center;
            }
            th {
              background: #e8e8e8;
            }
            .header {
              display: flex;
              flex-direction: column;
              align-items: flex-start;
              justify-content: space-between;
              margin-bottom: 10px;
            }
            .report-title {
              font-size: 1.2rem;
              font-weight: bold;
              margin: 5px 0;
            }
            .sub-header {
              font-size: 0.95rem;
              color: #555;
              margin-bottom: 10px;
            }
            .dept-header-cell {
              background-color: #cce5ff;
              font-weight: bold;
            }
            .emp-header-cell {
              background-color: #d4edda;
              font-weight: bold;
            }
            .no-print { 
              display: none !important; 
            }
            .page-summary-table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 20px;
            }
            .page-summary-table th,
            .page-summary-table td {
              border: 1px solid #000;
              padding: 6px 8px;
              text-align: center;
            }
            .page-summary-table th {
              background-color: #f3f3f3;
            }
          </style>
        </head>
        <body>
      `);

      pagesData.forEach((pageObj, pageIndex) => {
        const isLastPage = (pageIndex === pagesData.length - 1);
        const { deptName, empName, rows } = pageObj;

        let pageNetTotal = 0;
        let pageWorkHoursSum = 0;
        let pageDelaySum = 0;
        let pageDelayCount = 0;
        let pageEarlyCount = 0;
        let pageAbsentDays = 0;
        let pageRewardsPunish = 0;
        let pageLeavesCount = 0;
        let pageTimeBased = 0;
        let pageBreaks = 0;

        rows.forEach(r => {
          pageNetTotal += (r.net_salary || 0);
          let wh = parseFloat(r.work_hours || '0');
          if (!isNaN(wh)) pageWorkHoursSum += wh;

          if (r.delay_minutes && r.delay_minutes > 0) {
            pageDelaySum += r.delay_minutes;
            pageDelayCount++;
          }
          if (r.early_exit_minutes && r.early_exit_minutes > 0) {
            pageEarlyCount++;
          }
          if (r.status_code === 'absent') {
            pageAbsentDays++;
          }
        });

        printWindow.document.write(`
          <div class="page ${isLastPage ? 'last-page' : ''}">
            <div class="header">
              <div class="report-title">تقرير الحضور للفترة من ${startDate} إلى ${endDate}</div>
              ${(deptName || empName)
            ? `<div class="sub-header">
                     ${deptName ? (`<strong>القسم:</strong> ${deptName}`) : ''}
                     ${deptName && empName ? ' | ' : ''}
                     ${empName ? (`<strong>الموظف:</strong> ${empName}`) : ''}
                   </div>`
            : ''
          }
            </div>
        `);

        if (deptName) {
          printWindow.document.write(`
            <table>
              <tr>
                <td class="dept-header-cell" style="text-align:right;" colspan="${displayedColumns.length}">
                  قسم: ${deptName}
                </td>
              </tr>
            </table>
          `);
        }

        if (empName) {
          printWindow.document.write(`
            <table>
              <tr>
                <td class="emp-header-cell" style="text-align:right;" colspan="${displayedColumns.length}">
                  الموظف: ${empName}
                </td>
              </tr>
            </table>
          `);
        }

        printWindow.document.write(`
          <table>
            <thead>
              <tr>
        `);
        displayedColumns.forEach(col => {
          printWindow.document.write(`<th style="width:${col.width};">${col.label}</th>`);
        });
        printWindow.document.write(`
              </tr>
            </thead>
            <tbody>
        `);

        rows.forEach(row => {
          printWindow.document.write(`<tr>`);
          displayedColumns.forEach(col => {
            let cellVal = row[col.field] || '';
            if ((col.field === 'check_in' || col.field === 'check_out') && cellVal.includes(' ')) {
              cellVal = cellVal.split(' ')[1];
            }
            if (col.field === 'work_hours' && cellVal) {
              cellVal = formatWorkHours(cellVal);
            }
            if (col.field === 'net_salary' && cellVal) {
              cellVal = formatNetSalary(cellVal);
            }
            let cellStyle = `width:${col.width};`;
            if (col.field === 'attendance_status') {
              switch (row.status_code) {
                case 'absent': cellStyle += 'background-color:#ffd4d4;'; break;
                case 'late': cellStyle += 'background-color:#fff5d4;'; break;
                case 'early_exit': cellStyle += 'background-color:#ffe9d4;'; break;
                case 'present': cellStyle += 'background-color:#d4ffd4;'; break;
                case 'semi_present': cellStyle += 'background-color:#d4ffff;'; break;
                case 'late_and_early_exit': cellStyle += 'background-color:#ffe6ff;'; break;
                case 'overtime': cellStyle += 'background-color:#e6ffe6;'; break;
              }
            }
            printWindow.document.write(`<td style="${cellStyle}">${cellVal}</td>`);
          });
          printWindow.document.write(`</tr>`);
        });

        printWindow.document.write(`
            </tbody>
          </table>
        `);

        const recordCount = rows.length;
        const netSalaryStr = formatNetSalary(pageNetTotal);

        function convertHoursToStr(hh) {
          const whole = Math.floor(hh);
          const mins = Math.round((hh - whole) * 60);
          return `${whole}س و ${mins}د`;
        }
        const totalWorkHoursStr = convertHoursToStr(pageWorkHoursSum);

        printWindow.document.write(`
          <table class="page-summary-table">
            <thead>
              <tr>
                <th>عدد السجلات</th>
                <th>إجمالي الراتب</th>
                <th>إجمالي الساعات</th>
                <th>إجمالي التأخير (دقيقة)</th>
                <th>عدد مرات التأخير</th>
                <th>عدد مرات الخروج المبكر</th>
                <th>مكافآت وعقوبات</th>
                <th>إجمالي الإجازات</th>
                <th>عدد أيام الغياب</th>
                <th>إجمالي الزمنيات</th>
                <th>إجمالي الاستراحة</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${recordCount}</td>
                <td>${netSalaryStr}</td>
                <td>${totalWorkHoursStr}</td>
                <td>${pageDelaySum}</td>
                <td>${pageDelayCount}</td>
                <td>${pageEarlyCount}</td>
                <td>${pageRewardsPunish}</td>
                <td>${pageLeavesCount}</td>
                <td>${pageAbsentDays}</td>
                <td>${pageTimeBased}</td>
                <td>${pageBreaks}</td>
              </tr>
            </tbody>
          </table>
        `);

        printWindow.document.write(`</div>`);
      });

      printWindow.document.write(`
        <div style="text-align:center; margin:15px 0;" class="no-print">
          <button onclick="window.print()">طباعة</button>
        </div>
      `);

      printWindow.document.write(`
        
        </html>
      `);

      printWindow.document.close();
      printWindow.focus();
    }

    function logout() {
      localStorage.removeItem('authToken');
      window.location.href = 'login.html';
    }
  </script>

  <!-- 
    ========== المودال الجديد والوظائف الجديدة لعرض سجلات الحضور للفترة المحددة ==========
    دون تعديل أكواد الدوال الأصلية، إنما أضفنا فقط ما يلزم للمودال والارتباط بالنقر.
  -->
  <!-- مودال لعرض سجلات الحضور (fingerprints logs) -->
  <div id="attendanceLogsModal" class="modal">
    <div class="modal-content">
      <button class="closeBtn" onclick="closeAttendanceLogsModal()">&times; إغلاق</button>
      <div class="modal-header">
        <h2>سجل الحضور</h2>
      </div>
      <div class="modal-body" style="display:block;">
        <!-- عرض الفترة -->
        <p id="logsDateRange" style="font-weight: bold; margin-bottom: 15px;"></p>

        <!-- فلاتر بسيطة داخل المودال للبحث -->
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
          <label for="logsFromDate">من تاريخ:</label>
          <input type="date" id="logsFromDate" />

          <label for="logsToDate">إلى تاريخ:</label>
          <input type="date" id="logsToDate" />

          <label for="logsEnrollId">EnrolID:</label>
          <input type="number" id="logsEnrollId" style="width:80px" />

          <button onclick="fetchAttendanceLogs()">بحث</button>
        </div>

        <!-- حاوية الجدول -->
        <div style="max-height: 400px; overflow:auto;">
          <table id="logsTable" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#007bff; color:#fff;">
                <th style="border:1px solid #ddd; padding:8px;">Enroll ID</th>
                <th style="border:1px solid #ddd; padding:8px;">الاسم</th>
                <th style="border:1px solid #ddd; padding:8px;">الوقت</th>
                <th style="border:1px solid #ddd; padding:8px;">الحدث</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
      <div class="modal-footer">
        <button onclick="closeAttendanceLogsModal()">إغلاق</button>
      </div>
    </div>
  </div>

  <script>
    // دوال للمودال وسحب البيانات

    // دالة مساعدة لتحويل "yyyy-mm-dd" إلى كائن Date
    function parseDateString(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return new Date(+y, +m - 1, +d);
    }

    // دالة لتنسيق كائن Date إلى "yyyy-mm-dd"
    function formatDateYMD(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, '0');
      const d = String(dt.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // إضافة عدد أيام لـ Date
    function addDaysToDate(baseDate, days) {
      const newDate = new Date(baseDate.valueOf());
      newDate.setDate(newDate.getDate() + days);
      return newDate;
    }

    // فتح المودال مع حساب الفترة من attendance_date + "T00:00:00"
    // ولغاية attendance_date + endDayOffset + "T23:59:59"
    function openAttendanceLogsModal(attDateStr, endDayOffset, enrollId) {
      // parse attDateStr إلى Date
      const baseDate = parseDateString(attDateStr);
      // تاريخ النهاية
      const endDateObj = addDaysToDate(baseDate, endDayOffset || 0);

      // صيغة العرض والفلترة
      const startDateFormatted = formatDateYMD(baseDate);
      const endDateFormatted = formatDateYMD(endDateObj);

      // تعبئة حقول التاريخ في المودال (date inputs)
      document.getElementById('logsFromDate').value = startDateFormatted;
      document.getElementById('logsToDate').value = endDateFormatted;
      // تعبئة EnrollID (إن وجد)
      document.getElementById('logsEnrollId').value = enrollId || '';

      // كتابة العنوان في أعلى المودال
      document.getElementById('logsDateRange').textContent =
        `سجلات من ${startDateFormatted} 00:00 إلى ${endDateFormatted} 23:59`;

      // إظهار المودال
      document.getElementById('attendanceLogsModal').style.display = 'block';

      // جلب البيانات مباشرة
      fetchAttendanceLogs();
    }

    function closeAttendanceLogsModal() {
      document.getElementById('attendanceLogsModal').style.display = 'none';
    }

    async function fetchAttendanceLogs() {
      const fromDate = document.getElementById('logsFromDate').value; // yyyy-mm-dd
      const toDate = document.getElementById('logsToDate').value;   // yyyy-mm-dd
      const eid = document.getElementById('logsEnrollId').value.trim();

      if (!fromDate || !toDate) {
        alert('الرجاء اختيار تاريخ البداية والنهاية');
        return;
      }

      // نضمّن التوقيت في الاستعلام: 00:00:00 و 23:59:59
      const fromStr = fromDate + 'T00:00:00';
      const toStr = toDate + 'T23:59:59';

      let url = `https://timeattendhr.com/api/fingerprints?from=${fromStr}&to=${toStr}`;
      if (eid) {
        url += `&enrollid=${eid}`;
      }

      try {
        const authTokenLocal = localStorage.getItem('authToken');
        const resp = await fetch(url, {
          headers: { 'Authorization': 'Bearer ' + authTokenLocal }
        });
        if (!resp.ok) {
          throw new Error('فشل جلب سجلات الحضور من السيرفر');
        }
        const data = await resp.json();
        const logs = data.logs || [];

        // عرض النتائج في الجدول
        const tbody = document.querySelector('#logsTable tbody');
        tbody.innerHTML = '';
        logs.forEach(log => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="border:1px solid #ddd; padding:6px;">${log.enrollid || ''}</td>
            <td style="border:1px solid #ddd; padding:6px;">${log.name || ''}</td>
            <td style="border:1px solid #ddd; padding:6px;">${(log.time || '').replace('T', ' ').split('.')[0]}</td>
            <td style="border:1px solid #ddd; padding:6px;">${log.event || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert(err.message);
        console.error(err);
      }
    }

    /*
      نستخدم setInterval لإضافة حدث النقر على الأسطر كل ثانية
      دون تعديل الدوال الأصلية في renderReport().
      نفترض أن الحقل الأول (attendance_date) والحقل الثاني (endDayOffset).
    */
    setInterval(() => {
      const tableBodyRows = document.querySelectorAll('#reportTable tbody tr');
      if (!tableBodyRows.length) return;

      tableBodyRows.forEach((row) => {
        if (
          row.classList.contains('deptHeaderRow') ||
          row.classList.contains('empHeaderRow') ||
          row.classList.contains('summaryRow')
        ) {
          return; // تجاهل صفوف التجميع والملخص
        }

        if (!row.dataset.clickBound) {
          row.dataset.clickBound = 'true';

          const dateCell = row.cells[0];
          const offsetCell = row.cells[1];

          if (!dateCell) return;

          const attDateStr = dateCell.textContent.trim();
          let offsetVal = 0;
          if (offsetCell) {
            const maybeOffset = parseInt(offsetCell.textContent.trim(), 10);
            if (!isNaN(maybeOffset)) {
              offsetVal = maybeOffset;
            }
          }

          // إن كنت ترغب بجلب الـ enrollId من عمود آخر، عدّل ذلك هنا.
          const exampleEnrollId = 4433; // مثال

          row.addEventListener('click', () => {
            openAttendanceLogsModal(attDateStr, offsetVal, exampleEnrollId);
          });
        }
      });
    }, 1000);
  </script>

  <!-- ================================================================================================== -->
  <!-- ===============================  i18n script start  =============================================== -->
  <!-- ================================================================================================== -->
  <script>
    // مفتاح اللغة في Local Storage
    const LANG_KEY = 'lng';
    // مسار ملفات الترجمة
    const REPORT_LANG_PATH = './lang';
    // كائن سيحمل نصوص الترجمة بعد تحميلها
    let reportTranslations = {};
    let translations = {};
    // تحميل ملف الترجمة
    async function loadReportLangFile(lang) {
      try {
        const response = await fetch(`${REPORT_LANG_PATH}/${lang}_report.json`);
        if (!response.ok) {
          throw new Error(`Error loading ${lang}_report.json`);
        }
        reportTranslations = await response.json();
      } catch (error) {
        console.error("Report translation file error:", error);
      }
    }

    // تطبيق الترجمة على عناصر الصفحة
    function applyReportTranslations(lang) {
      // ضبط اتجاه الصفحة
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-lng]').forEach(el => {
        const key = el.getAttribute('data-lng');
        if (translations[key]) {
          el.textContent = translations[key]; // Apply translation
        }
      });
      // العنوان في التبويب
      if (reportTranslations['report_head_title']) {
        document.title = reportTranslations['report_head_title'];
      }

      // الهيدر الرئيسي
      const mainHeaderH1 = document.querySelector('header h1');
      if (mainHeaderH1 && reportTranslations['report_header_title']) {
        mainHeaderH1.textContent = reportTranslations['report_header_title'];
      }
      const logoutBtn = document.querySelector('header button');
      if (logoutBtn && reportTranslations['report_logout']) {
        logoutBtn.textContent = reportTranslations['report_logout'];
      }
      document.querySelectorAll('option[data-lng]').forEach(option => {
        const key = option.getAttribute('data-lng');
        if (reportTranslations[key]) {
          option.textContent = reportTranslations[key];
        }
        // Translate the checkbox labels if they have data-lng
        document.querySelectorAll('label').forEach(label => {
          const input = label.querySelector('input');
          if (input && input.getAttribute('data-lng')) {
            const key = input.getAttribute('data-lng');
            if (reportTranslations[key]) {
              label.querySelector('span') ? label.querySelector('span').textContent = reportTranslations[key] : label.textContent = reportTranslations[key];
            }
          }
        });
      });
      // الفلاتر
      const labelWeek = document.querySelector('label[for="weekSelect"]');
      if (labelWeek && reportTranslations['report_filter_week']) {
        labelWeek.textContent = reportTranslations['report_filter_week'];
      }
      const labelMonth = document.querySelector('label[for="monthSelect"]');
      if (labelMonth && reportTranslations['report_filter_month']) {
        labelMonth.textContent = reportTranslations['report_filter_month'];
      }
      const labelStart = document.querySelector('label[for="startDate"]');
      if (labelStart && reportTranslations['report_filter_start_date']) {
        labelStart.textContent = reportTranslations['report_filter_start_date'];
      }
      const labelEnd = document.querySelector('label[for="endDate"]');
      if (labelEnd && reportTranslations['report_filter_end_date']) {
        labelEnd.textContent = reportTranslations['report_filter_end_date'];
      }
      const labelEmp = document.querySelector('label[for="employeeSelect"]');
      if (labelEmp && reportTranslations['report_filter_employee']) {
        labelEmp.textContent = reportTranslations['report_filter_employee'];
      }
      const labelDept = document.querySelector('label[for="departmentSelect"]');
      if (labelDept && reportTranslations['report_filter_department']) {
        labelDept.textContent = reportTranslations['report_filter_department'];
      }
      const labelStatus = document.querySelector('label[for="statusSelect"]');
      if (labelStatus && reportTranslations['report_filter_status']) {
        labelStatus.textContent = reportTranslations['report_filter_status'];
      }

      // checkbox groupByDept
      const groupByDeptLabel = document.querySelector('label[for="groupByDeptCheckbox"]');
      if (groupByDeptLabel && reportTranslations['report_filter_group_dept']) {
        groupByDeptLabel.lastChild.textContent = reportTranslations['report_filter_group_dept'];
      }
      // checkbox groupByEmp
      const groupByEmpLabel = document.querySelector('label[for="groupByEmpCheckbox"]');
      if (groupByEmpLabel && reportTranslations['report_filter_group_emp']) {
        groupByEmpLabel.lastChild.textContent = reportTranslations['report_filter_group_emp'];
      }
      // checkbox showApiSummary
      const showApiSummLabel = document.querySelector('label[for="showApiSummaryCheckbox"]');
      if (showApiSummLabel && reportTranslations['report_filter_api_summary']) {
        showApiSummLabel.lastChild.textContent = reportTranslations['report_filter_api_summary'];
      }

      // زر "جلب التقرير"
      const filterButtons = document.querySelectorAll('.filters button');
      if (filterButtons.length > 0 && reportTranslations['report_filter_load_btn']) {
        // نفترض أن زر جلب التقرير هو آخر زر
        filterButtons[filterButtons.length - 1].textContent = reportTranslations['report_filter_load_btn'];
      }

      // الأزرار العلوية (تصدير اكسل + طباعة بتصميم + تخصيص الأعمدة)
      const exportExcelBtn = document.getElementById('exportExcelBtn');
      if (exportExcelBtn && reportTranslations['report_export_excel']) {
        exportExcelBtn.innerHTML = `<i class="bi bi-file-earmark-excel"></i> ${reportTranslations['report_export_excel']}`;
      }
      const printBtn = document.getElementById('customPrintBtn');
      if (printBtn && reportTranslations['report_print_design']) {
        printBtn.innerHTML = `<i class="bi bi-printer-fill"></i> ${reportTranslations['report_print_design']}`;
      }
      const customizeBtns = document.querySelectorAll('.exportPrintButtons button');
      if (customizeBtns.length >= 3 && reportTranslations['report_customize_columns']) {
        // نفترض أن زر تخصيص الأعمدة هو الثالث
        customizeBtns[2].innerHTML = `<i class="bi bi-layout-sidebar-inset"></i> ${reportTranslations['report_customize_columns']}`;
      }

      // العناوين في بطاقات الملخص
      const cardHeaders = document.querySelectorAll('.card h3');
      if (cardHeaders.length >= 4) {
        if (reportTranslations['report_cards_record_count']) {
          cardHeaders[0].textContent = reportTranslations['report_cards_record_count'];
        }
        if (reportTranslations['report_cards_delay_sum']) {
          cardHeaders[1].textContent = reportTranslations['report_cards_delay_sum'];
        }
        if (reportTranslations['report_cards_early_sum']) {
          cardHeaders[2].textContent = reportTranslations['report_cards_early_sum'];
        }
        if (reportTranslations['report_cards_net_sum']) {
          cardHeaders[3].textContent = reportTranslations['report_cards_net_sum'];
        }
      }

      // الملخص الإضافي
      const apiSummContainer = document.getElementById('apiSummaryContainer');
      if (apiSummContainer) {
        const headerDiv = apiSummContainer.querySelector('.apiSummaryHeader');
        if (headerDiv && reportTranslations['report_api_summary_header']) {
          headerDiv.textContent = reportTranslations['report_api_summary_header'];
        }
      }

      // الشريط الجانبي
      const sidebarTitle = document.querySelector('.sidebar h2');
      if (sidebarTitle && reportTranslations['report_sidebar_title']) {
        sidebarTitle.textContent = reportTranslations['report_sidebar_title'];
      }
      const sidebarItems = document.querySelectorAll('.sidebar .navItem');
      if (sidebarItems.length >= 12) {
        if (reportTranslations['report_sidebar_overview']) {
          sidebarItems[0].innerHTML = `<i class="bi bi-house-fill"></i> ${reportTranslations['report_sidebar_overview']}`;
        }
        if (reportTranslations['report_sidebar_employees']) {
          sidebarItems[1].innerHTML = `<i class="bi bi-people-fill"></i> ${reportTranslations['report_sidebar_employees']}`;
        }
        if (reportTranslations['report_sidebar_report']) {
          sidebarItems[2].innerHTML = `<i class="bi bi-bar-chart-line-fill"></i> ${reportTranslations['report_sidebar_report']}`;
        }
        if (reportTranslations['report_sidebar_time_leaves']) {
          sidebarItems[3].innerHTML = `<i class="bi bi-clock-fill"></i> ${reportTranslations['report_sidebar_time_leaves']}`;
        }
        if (reportTranslations['report_sidebar_holidays']) {
          sidebarItems[4].innerHTML = `<i class="bi bi-calendar-event-fill"></i> ${reportTranslations['report_sidebar_holidays']}`;
        }
        if (reportTranslations['report_sidebar_leaves']) {
          sidebarItems[5].innerHTML = `<i class="bi bi-calendar3"></i> ${reportTranslations['report_sidebar_leaves']}`;
        }
        if (reportTranslations['report_sidebar_attend']) {
          sidebarItems[6].innerHTML = `<i class="bi bi-journal-check"></i> ${reportTranslations['report_sidebar_attend']}`;
        }
        if (reportTranslations['report_sidebar_rewards']) {
          sidebarItems[7].innerHTML = `<i class="bi bi-gift-fill"></i> ${reportTranslations['report_sidebar_rewards']}`;
        }
        if (reportTranslations['report_sidebar_devices']) {
          sidebarItems[8].innerHTML = `<i class="bi bi-device-hdd-fill"></i> ${reportTranslations['report_sidebar_devices']}`;
        }
        if (reportTranslations['report_sidebar_requests']) {
          sidebarItems[9].innerHTML = `<i class="bi bi-list-check"></i> ${reportTranslations['report_sidebar_requests']}`;
        }
        if (reportTranslations['report_sidebar_departments']) {
          sidebarItems[10].innerHTML = `<i class="bi bi-building"></i> ${reportTranslations['report_sidebar_departments']}`;
        }
        if (reportTranslations['report_sidebar_settings']) {
          sidebarItems[11].innerHTML = `<i class="bi bi-gear-fill"></i> ${reportTranslations['report_sidebar_settings']}`;
        }
        if (reportTranslations['attend_sidebar_unregistered']) {
          sidebarItems[12].innerHTML = `<i class="bi bi-person-exclamation"></i> ${reportTranslations['attend_sidebar_unregistered']}`;
        }
        if (reportTranslations['employee_summary_report']) {
          sidebarItems[13].innerHTML = `<i class="bi bi-people-fill"></i> ${reportTranslations['employee_summary_report']}`;
        }

      }

      // مودال تخصيص الأعمدة
      const columnModalHeader = document.querySelector('#columnModal .modal-header h2');
      if (columnModalHeader && reportTranslations['report_modal_column_title']) {
        columnModalHeader.textContent = reportTranslations['report_modal_column_title'];
      }
      const columnModalClose = document.querySelector('#columnModal .closeBtn');
      if (columnModalClose && reportTranslations['report_modal_close_btn']) {
        columnModalClose.innerHTML = `&times; ${reportTranslations['report_modal_close_btn']}`;
      }
      const columnModalSaveClose = document.querySelector('#columnModal .modal-footer button');
      if (columnModalSaveClose && reportTranslations['report_modal_save_close_btn']) {
        columnModalSaveClose.textContent = reportTranslations['report_modal_save_close_btn'];
      }

      // مودال سجلات الحضور
      const logsModalHeader = document.querySelector('#attendanceLogsModal .modal-header h2');
      if (logsModalHeader && reportTranslations['report_modal_attend_logs_title']) {
        logsModalHeader.textContent = reportTranslations['report_modal_attend_logs_title'];
      }
      const logsModalClose = document.querySelector('#attendanceLogsModal .closeBtn');
      if (logsModalClose && reportTranslations['report_modal_attend_logs_close']) {
        logsModalClose.innerHTML = `&times; ${reportTranslations['report_modal_attend_logs_close']}`;
      }
      const logsFromLabel = document.querySelector('label[for="logsFromDate"]');
      if (logsFromLabel && reportTranslations['report_modal_attend_logs_from']) {
        logsFromLabel.textContent = reportTranslations['report_modal_attend_logs_from'];
      }
      const logsToLabel = document.querySelector('label[for="logsToDate"]');
      if (logsToLabel && reportTranslations['report_modal_attend_logs_to']) {
        logsToLabel.textContent = reportTranslations['report_modal_attend_logs_to'];
      }
      const logsEnrollLabel = document.querySelector('label[for="logsEnrollId"]');
      if (logsEnrollLabel && reportTranslations['report_modal_attend_logs_enrollid']) {
        logsEnrollLabel.textContent = reportTranslations['report_modal_attend_logs_enrollid'];
      }
      const logsBtns = document.querySelector('#attendanceLogsModal .modal-body button');
      if (logsBtns && reportTranslations['report_modal_attend_logs_search']) {
        logsBtns.textContent = reportTranslations['report_modal_attend_logs_search'];
      }
      const logsModalFooterBtn = document.querySelector('#attendanceLogsModal .modal-footer button');
      if (logsModalFooterBtn && reportTranslations['report_modal_attend_logs_close']) {
        logsModalFooterBtn.textContent = reportTranslations['report_modal_attend_logs_close'];
      }

      // رؤوس جدول المودال #logsTable
      const logsTheadCells = document.querySelectorAll('#logsTable thead tr th');
      if (logsTheadCells.length >= 4) {
        if (reportTranslations['report_table_logs_enrollid']) {
          logsTheadCells[0].textContent = reportTranslations['report_table_logs_enrollid'];
        }
        if (reportTranslations['report_table_logs_name']) {
          logsTheadCells[1].textContent = reportTranslations['report_table_logs_name'];
        }
        if (reportTranslations['report_table_logs_time']) {
          logsTheadCells[2].textContent = reportTranslations['report_table_logs_time'];
        }
        if (reportTranslations['report_table_logs_event']) {
          logsTheadCells[3].textContent = reportTranslations['report_table_logs_event'];
        }
      }
    }

    // عند تحميل الصفحة، نقرأ اللغة من localStorage ونطبّقها
    window.addEventListener('DOMContentLoaded', async () => {
      let storedLang = localStorage.getItem(LANG_KEY);
      if (!storedLang) {
        storedLang = 'ar'; // اجعل العربية افتراضية أو "en" إن أردت الإنجليزية افتراضية
      }
      await loadReportLangFile(storedLang);
      applyReportTranslations(storedLang);
    });
  </script>
  <!-- ================================================================================================== -->
  <!-- ===============================  i18n script end  ================================================ -->
  <!-- ================================================================================================== -->

</body>

</html>