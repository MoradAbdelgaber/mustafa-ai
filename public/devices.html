<!DOCTYPE html>
<html>
<!-- نفترض الانجليزية هي الافتراضية -->

<head>
  <meta charset="UTF-8">
  <title id="devices_page_title" data-lng="devices_page_title">Devices - Attendance System</title>

  <!-- مكتبة jQuery (إن احتجتها) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- مكتبة Select2 (اختياري) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- أيقونات Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- خطا Tajawal (للغة العربية) وOpen Sans (للإنجليزية) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Open+Sans:wght@400;700&display=swap"
    rel="stylesheet">

  <style>
    html {
      animation: fadeIn .3s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* ضبط الخط والاتجاه وفق اللغة المختارة */

    html[lang="ar"] body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }

    html[lang="en"] body {
      font-family: 'Open Sans', sans-serif;
      direction: ltr;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }

    /* رأس الصفحة */

    header {
      background: linear-gradient(45deg, #0062cc, #004085);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    header button {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    header button:hover {
      background: #c82333;
    }

    /* عنصر اختيار اللغة في الهيدر */

    .lang-select {
      margin-left: 10px;
      padding: 5px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* حاوية عامة بعكس الاتجاه لعرض الـSidebar يمينًا في العربية */

    .container {
      display: flex;
      /* عند العربية direction: rtl، في الإنجليزية direction: ltr،
         لكننا نستطيع قلب الـ flex-direction ديناميكيًا عبر JS أو باستخدام خاصية direction. */
      flex-direction: row-reverse;
    }

    /* المحتوى الرئيسي */

    .mainContent {
      flex: 1;
      padding: 20px;
    }

    /* تنسيق للقوائم الفرعية لتظهر كفرع */

    .submenu {
      border-left: 2px solid #dee2e6;
      margin-left: 15px;
      padding-left: 10px;
      margin-bottom: 5px;
    }

    .menu-group-header {
      font-weight: bold;
      background: #dee2e6;
    }

    /* الشريط الجانبي (Sidebar) */

    .sidebar {
      width: 240px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      padding: 20px 10px;
    }

    .sidebar h2 {
      margin-bottom: 15px;
      font-size: 1rem;
      text-align: center;
      color: #444;
    }

    .navItem {
      padding: 12px 10px;
      margin: 6px 0;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      font-weight: 500;
      transition: background 0.3s, color 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navItem i {
      font-size: 1.1rem;
      color: #666;
      transition: color 0.3s;
    }

    .navItem:hover {
      background: #f0f0f0;
    }

    .navItem.active {
      background: #007bff;
      color: #fff;
    }

    .navItem.active i {
      color: #fff;
    }

    /* الرسائل */

    .errorMsg,
    .successMsg {
      margin: 10px 0;
      font-size: 0.95rem;
      font-weight: 600;
      padding: 10px;
      border-radius: 4px;
    }

    .errorMsg {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .successMsg {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    /* زر إضافة جهاز */

    .addDeviceBtn {
      background: #28a745;
      color: #fff;
      padding: 8px 14px;
      border-radius: 4px;
      transition: background 0.3s;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
    }

    .addDeviceBtn:hover {
      background: #218838;
    }

    /* حاوية البحث (Filters) */

    .searchFilters {
      background: #fff;
      padding: 10px;
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .searchFilters label {
      margin-right: 4px;
      font-weight: 500;
    }

    .searchFilters select,
    .searchFilters input[type="date"],
    .searchFilters input[type="text"] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    /* جدول الأجهزة */

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    table thead {
      background: #007bff;
      color: #fff;
    }

    table th,
    table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    /* أيقونات في خلية التحكم */

    .actionIcon {
      color: #007bff;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 4px;
      transition: color 0.3s;
    }

    .actionIcon:hover {
      color: #0056b3;
    }

    /* شكل القائمة المنسدلة للإجراءات */

    .actionSelect {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px;
      background: #fff;
      font-size: 0.85rem;
      cursor: pointer;
    }

    /* تلوين حالة الاتصال */

    .connectedCell {
      background-color: #d4edda;
      /* أخضر فاتح */
      color: #155724;
      /* أخضر غامق */
      font-weight: 600;
    }

    .disconnectedCell {
      background-color: #f8d7da;
      /* أحمر فاتح */
      color: #721c24;
      /* أحمر غامق */
      font-weight: 600;
    }

    /* الـ Modal Overlay */

    .modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modalContent {
      width: 700px;
      max-width: 95%;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: fadeInModal 0.3s ease;
      position: relative;
      max-height: 90vh;
      /* حتى لا يتمدد خارج الشاشة */
    }

    @keyframes fadeInModal {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* هيدر المودال */

    .modalHeader {
      background: #007bff;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modalHeader h2 {
      margin: 0;
      font-size: 1rem;
    }

    .modalCloseBtn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.3s;
    }

    .modalCloseBtn:hover {
      color: #ffdddd;
    }

    /* جسم المودال */

    .modalBody {
      padding: 20px;
      overflow: auto;
      /* للتمرير إذا طال المحتوى */
    }

    .modalBody label {
      font-weight: 500;
    }

    .modalBody input,
    .modalBody select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    .modalSaveBtn {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px 14px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .modalSaveBtn:hover {
      background: #218838;
    }

    /* أقسام الإعدادات */

    .settings-section {
      background: #f9f9f9;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      border-radius: 6px;
      padding: 10px;
    }

    .settings-section h3 {
      font-size: 1rem;
      margin: 0 0 10px 0;
      color: #333;
    }

    .fieldGroup {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 10px;
    }

    .fieldItem {
      flex: 1 1 200px;
      /* يمكن ضبطه حسب الحاجة */
    }

    .fieldItem label {
      display: block;
      margin-bottom: 5px;
    }

    /* شاشة التحميل (Overlay) */

    .loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      flex-direction: column;
      /* لكي نضع العداد تحت السبنر */
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #progressText {
      color: #fff;
      font-size: 18px;
      margin-top: 10px;
    }

    /* جداول المنطقة الزمنية */

    .timeZoneSection h3 {
      margin-bottom: 10px;
    }

    .timeZoneTable {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: #fff;
    }

    .timeZoneTable th,
    .timeZoneTable td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 0.85rem;
      text-align: center;
    }

    .timeZoneTable thead {
      background: #007bff;
      color: #fff;
    }

    .timeZoneTable input {
      width: 100%;
      font-size: 0.85rem;
      padding: 4px;
      box-sizing: border-box;
      text-align: center;
    }

    .timeZoneTable select {
      width: 100%;
      font-size: 0.85rem;
    }

    /* مودال عرض معلومات الجهاز الجديد */

    #deviceInfoBody table {
      width: 100%;
      border-collapse: collapse;
    }

    #deviceInfoBody table th,
    #deviceInfoBody table td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      font-size: 0.9rem;
    }

    #deviceInfoBody table thead {
      background: #007bff;
      color: #fff;
    }

    .topDiv {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 32px;
    }

    .topDiv p {
      color: #5b5b5b;
      margin: 0;
    }

    .topDiv span {
      padding-inline: 18px;
    }

    .accordion {
      box-sizing: border-box;
    }

    .accordion-header {
      background-color: #dddddd4f;
      color: #000;
      padding: 10px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: background-color 0.3s ease;
      margin: 0 0 9px 0;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      position: relative;
    }

    .accordion-header::before {
      content: '+';
      position: absolute;
      top: 6px;
      right: 11px;
      font-size: 1.4rem;
      color: #000;
    }

    html[lang="ar"] .accordion-header::before {
      right: auto;
      left: 11px;
    }

    .accordion-header:hover {
      background-color: #ddd;
    }

    .accordion-header.active {
      margin-bottom: 0;
      border-bottom-right-radius: 0;
      border-bottom-left-radius: 0;
      border: 1px solid #ddd;
      background-color: #ddd;
    }

    .accordion-header.active::before {
      content: '_';
      top: -6px;
    }

    .accordion-content {
      display: none;
      background-color: #f1f1f1;
      padding: 15px;
      border: 1px solid #ddd;
      border-top: none;
      margin-bottom: 5px;
    }
  </style>
</head>

<body onload="initPage()">

  <!-- هيدر الصفحة -->
  <header>
    <!-- العنوان -->
    <h1 id="devices_header_title" data-lng="devices_header_title">Devices (Default)</h1>

    <!-- الجزء الأيمن: زر الخروج + اختيار اللغة -->
    <div>
      <button id="devices_btn_logout" onclick="logout()" data-lng="devices_btn_logout">Logout</button>
      <select id="langSelector" class="lang-select">
        <option value="en">English</option>
        <option value="ar">العربية</option>
      </select>
    </div>
  </header>

  <!-- حاوية التحميل -->
  <div class="loadingOverlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="progressText"></div>
  </div>

  <!-- الحاوية العامة -->
  <div class="container">
    <!-- المحتوى الرئيسي -->
    <div class="mainContent">
      <div class="errorMsg" id="errorMsg" style="display:none;"></div>
      <div class="successMsg" id="successMsg" style="display:none;"></div>

      <!-- حاوية البحث أعلى الجدول -->
      <div class="searchFilters">
        <label id="devices_search_name_label" for="searchName" data-lng="devices_search_name_label"></label>
        <input type="text" id="searchName" oninput="filterDevicesLocally()"
          data-lng-placeholder="devices_search_name_placeholder" placeholder="">

        <label id="devices_search_serial_label" for="searchSerial" data-lng="devices_search_serial_label"></label>
        <input type="text" id="searchSerial" oninput="filterDevicesLocally()"
          data-lng-placeholder="devices_search_serial_placeholder" placeholder="">

        <label id="devices_search_serverip_label" for="searchServerIp" data-lng="devices_search_serverip_label"></label>
        <input type="text" id="searchServerIp" oninput="filterDevicesLocally()"
          data-lng-placeholder="devices_search_serverip_placeholder" placeholder="">

        <label id="devices_search_status_label" for="searchStatus" data-lng="devices_search_status_label"></label>
        <select id="searchStatus" onchange="filterDevicesLocally()">
          <option data-lng-option="all_statuses" value="">...</option>
          <option data-lng-option="devices_modal_status_option_true" value="true">...</option>
          <option data-lng-option="devices_modal_status_option_false" value="false">...</option>
        </select>

        <label id="devices_search_creation_label" for="searchCreation" data-lng="devices_search_creation_label"></label>
        <input type="date" id="searchCreation" onchange="filterDevicesLocally()" />
      </div>

      <!-- زر إضافة جهاز -->
      <div class="topDiv">
        <button class="addDeviceBtn" id="devices_add_button" onclick="openModalForAdd()" data-lng="devices_add_button">
          Add Device</button>
        <p>IP: 140.82.38.238
          <span></span>Port: 7715
        </p>
      </div>

      <!-- جدول الأجهزة -->
      <table id="devicesTable">
        <thead>
          <tr>
            <th data-lng="devices_table_th_no">#</th>
            <th data-lng="devices_table_th_name">Device Name</th>
            <th data-lng="devices_table_th_serial">Serial</th>
            <th data-lng="devices_table_th_serverip">Server IP</th>
            <th data-lng="timeZone">timeZone</th>
            <th data-lng="devices_table_th_status">Status</th>
            <th data-lng="devices_table_th_creation">Creation</th>
            <th data-lng="devices_table_th_oldFlag">Old Flag</th>
            <th data-lng="devices_table_th_control">Control</th>
            <th data-lng="devices_table_th_actions">Actions</th>
            <th data-lng="devices_table_th_connection">Connection</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- الشريط الجانبي -->
    <div class="sidebar"></div>

    <script>
      // دالة لتبديل عرض وإخفاء القائمة الفرعية
      function toggleSubMenu(id) {
        var submenu = document.getElementById(id);
        if (submenu.style.display === "none" || submenu.style.display === "") {
          submenu.style.display = "block";
        } else {
          submenu.style.display = "none";
        }
      }

      // عند تحميل الصفحة، نقوم بفحص إذا كان أي عنصر ضمن القائمة الفرعية يحمل الكلاس "active"
      // وفي حال وجوده، نقوم بفتح القائمة الفرعية تلقائياً.
      // document.addEventListener("DOMContentLoaded", function () {
      //   var submenus = document.querySelectorAll('.submenu');
      //   submenus.forEach(function (submenu) {
      //     if (submenu.querySelector('.navItem.active')) {
      //       submenu.style.display = "block";
      //     }
      //   });
      // });
    </script>


    <!-- مودال إضافة / تعديل الجهاز -->
    <div class="modalOverlay" id="deviceModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="devices_modal_title" data-lng="devices_modal_add_title">Add Device</h2>
          <button class="modalCloseBtn" onclick="closeModal()">×</button>
        </div>
        <div class="modalBody">
          <input type="hidden" id="deviceId" />

          <label id="devices_modal_name_label" data-lng="devices_modal_label_name" for="deviceName">Device Name:</label>
          <input type="text" id="deviceName" placeholder="" />

          <label id="devices_modal_serial_label" data-lng="deviceSerial" for="deviceSerial">Device Serial:</label>
          <input type="text" id="deviceSerial" placeholder="12345-ABCDE" />

          <label id="devices_modal_serverip_label" data-lng="devices_modal_label_serverip"
            for="serverIp">ServerIP:</label>
          <input type="text" id="serverIp" placeholder="192.168.1.50" />


          <label id="devices_modal_oldFlag_label" data-lng="devices_modal_label_oldFlag" for="oldFlag">OldFlag:</label>
          <select id="oldFlag">
            <option value="true" data-lng-option="devices_modal_status_option_true">Enabled</option>
            <option value="false" data-lng-option="devices_modal_status_option_false">Disabled</option>
          </select>

          <label data-lng="timeZoneLable" for="deviceTimeZone">timeZone:</label>
          <input list="timezones" id="deviceTimeZone" data-lng-placeholder="timeZone" />
          <datalist id="timezones"></datalist>

          <label id="devices_modal_status_label" data-lng="devices_modal_label_status"
            for="deviceStatus">Status:</label>
          <select id="deviceStatus">
            <option value="true" data-lng-option="devices_modal_status_option_true">Enabled</option>
            <option value="false" data-lng-option="devices_modal_status_option_false">Disabled</option>
          </select>

          <button class="modalSaveBtn" id="devices_modal_save_button" data-lng="devices_modal_button_save"
            onclick="saveDevice()">Save</button>
        </div>
      </div>
    </div>
    <!-- مودال إعدادات الجهاز -->
    <div class="modalOverlay" id="deviceSettingsModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="devices_settings_title" data-lng="devices_settings_title">Device Settings</h2>
          <button class="modalCloseBtn" onclick="closeSettingsModal()">×</button>
        </div>
        <div class="modalBody" id="devSettingsBody">
          <!-- أقسام الإعدادات (كما في كودك السابق) -->

          <div class="accordion">
            <h3 data-lng="registration_options" class="accordion-header">خيارات التسجيل</h3>
            <div class="accordion-content">
              <!-- (1) خيارات التسجيل -->
              <div class="settings-section">

                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="rfid_free_reg" data-lng="rfid_free_reg">تسجيل مجاني للبطاقة</label>
                    <select id="rfid_free_reg">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="rfid_auto_reg" data-lng="rfid_auto_reg">استعمال البطاقة لتسجيل الحضور</label>
                    <select id="rfid_auto_reg">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="face_double_check" data-lng="face_double_check">فحص تكرار الوجه</label>
                    <select id="face_double_check">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="reg_card_1" data-lng="add_card_1">إضافة بطاقة1</label>
                    <input type="number" id="reg_card_1" />
                  </div>
                  <div class="fieldItem">
                    <label for="reg_card_2" data-lng="add_card_2">إضافة بطاقة2</label>
                    <input type="number" id="reg_card_2" />
                  </div>
                  <div class="fieldItem">
                    <label for="reg_card_3" data-lng="add_card_3">إضافة بطاقة3</label>
                    <input type="number" id="reg_card_3" />
                  </div>
                </div>
              </div>
            </div>

            <h3 data-lng="attendance_and_time_settings" class="accordion-header">إعدادات الحضور والوقت</h3>
            <div class="accordion-content">
              <!-- (2) إعدادات الحضور والوقت -->
              <div class="settings-section">

                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="reverifytime" data-lng="reverifytime">فترة التسجيل</label>
                    <input type="number" id="reverifytime" />
                  </div>
                  <div class="fieldItem">
                    <label for="glog_warning" data-lng="glog_warning">تحذير سجل الحضور</label>
                    <input type="number" id="glog_warning" />
                  </div>
                  <div class="fieldItem">
                    <label for="use_logphoto" data-lng="use_logphoto">حفظ الصورة</label>
                    <select id="use_logphoto">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="stranger_photo" data-lng="stranger_photo">صورة الضيف</label>
                    <select id="stranger_photo">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="verifyfail_hint" data-lng="verifyfail_hint">سبب فشل التأكد</label>
                    <select id="verifyfail_hint">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="selfchecklog" data-lng="selfchecklog">التحقق من السجل</label>
                    <select id="selfchecklog">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="default_shift" data-lng="default_shift">وقت العمل الافتراضي</label>
                    <input type="number" id="default_shift" />
                  </div>
                  <div class="fieldItem">
                    <label for="shift_weekend_ot" data-lng="shift_weekend_ot">عمل إضافي في عطلة نهاية الأسبوع</label>
                    <select id="shift_weekend_ot">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="excel_password" data-lng="excel_password">Excel Pwd</label>
                    <input type="text" id="excel_password" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="allow_latetime" data-lng="allow_latetime">وقت التأخير</label>
                    <input type="number" id="allow_latetime" />
                  </div>
                  <div class="fieldItem">
                    <label for="allow_earlytime" data-lng="allow_earlytime">وقت الخروج المبكر</label>
                    <input type="number" id="allow_earlytime" />
                  </div>
                  <div class="fieldItem">
                    <label for="reverify_nolock" data-lng="reverify_nolock">تأكيد عدم فتح الباب</label>
                    <select id="reverify_nolock">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <h3 data-lng="dst_and_reboot" class="accordion-header">التوقيت الصيفي وإعادة التشغيل</h3>
            <div class="accordion-content">
              <!-- (3) التوقيت الصيفي وإعادة التشغيل -->
              <div class="settings-section">

                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="use_dst" data-lng="use_dst">استخدام DST</label>
                    <select id="use_dst">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="dst_start" data-lng="dst_start">بداية التوقيت الصيفي</label>
                    <input type="number" id="dst_start" />
                  </div>
                  <div class="fieldItem">
                    <label for="dst_end" data-lng="dst_end">نهاية التوقيت الصيفي</label>
                    <input type="number" id="dst_end" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="reboottime1" data-lng="reboottime1">وقت إعادة التشغيل 1</label>
                    <input type="number" id="reboottime1" />
                  </div>
                  <div class="fieldItem">
                    <label for="reboottime2" data-lng="reboottime2">وقت إعادة التشغيل 2</label>
                    <input type="number" id="reboottime2" />
                  </div>
                  <div class="fieldItem">
                    <label for="reboottime3" data-lng="reboottime3">وقت إعادة التشغيل 3</label>
                    <input type="number" id="reboottime3" />
                  </div>
                </div>
              </div>
            </div>

            <h3 data-lng="section_4_title" class="accordion-header">إعدادات الصوت والعرض</h3>
            <div class="accordion-content">
              <!-- (4) إعدادات الصوت والعرض -->
              <div class="settings-section">

                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="volume" data-lng="volume">مستوى الصوت</label>
                    <input type="number" id="volume" />
                  </div>
                  <div class="fieldItem">
                    <label for="tts_voice" data-lng="tts_voice">TTS Voice</label>
                    <select id="tts_voice" data-lng="tts_voice">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="multifaces" data-lng="multifaces">Multi-Faces</label>
                    <select id="multifaces">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="showresulttime" data-lng="showresulttime">مدة عرض النتيجة</label>
                    <input type="number" id="showresulttime" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="screensavertime" data-lng="screensavertime">وقت شاشة التوقف</label>
                    <input type="number" id="screensavertime" />
                  </div>
                  <div class="fieldItem">
                    <label for="sleeptime" data-lng="sleeptime">وضع السكون</label>
                    <input type="number" id="sleeptime" />
                  </div>
                  <div class="fieldItem">
                    <label for="live_detect" data-lng="live_detect">اكتشاف حي</label>
                    <select id="live_detect">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="show_avatar" data-lng="show_avatar">إظهار صورة الوجه</label>
                    <select id="show_avatar">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <h3 data-lng="section_5_title" class="accordion-header">إعدادات الخصوصية والتعرف</h3>
            <div class="accordion-content">
              <!-- (5) إعدادات الخصوصية والتعرف -->
              <div class="settings-section">

                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="managers" data-lng="managers">عدد المدراء</label>
                    <input type="number" id="managers" />
                  </div>
                  <div class="fieldItem">
                    <label for="hide_privacy" data-lng="hide_privacy">إخفاء الخصوصية</label>
                    <select id="hide_privacy">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="fcmatch_level" data-lng="fcmatch_level">مستوى مطابقة الوجه</label>
                    <input type="number" id="fcmatch_level" />
                  </div>
                  <div class="fieldItem">
                    <label for="live_treshold" data-lng="live_treshold">عتبة الاكتشاف الحي</label>
                    <input type="number" id="live_treshold" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="wear_mask" data-lng="wear_mask">ارتداء قناع</label>
                    <select id="wear_mask">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="mask_treshold" data-lng="mask_treshold">عتبة القناع</label>
                    <input type="number" id="mask_treshold" />
                  </div>
                  <div class="fieldItem">
                    <label for="filllight_period" data-lng="filllight_period">فترة الإضاءة</label>
                    <input type="number" id="filllight_period" />
                  </div>
                  <div class="fieldItem">
                    <label for="exposure_value" data-lng="exposure_value">قيمة التعرض</label>
                    <input type="number" id="exposure_value" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="online_debug" data-lng="online_debug">تصحيح عبر الإنترنت</label>
                    <select id="online_debug">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <h3 data-lng="section_6_title" class="accordion-header">إعدادات الباب</h3>
            <div class="accordion-content">
              <!-- (6) إعدادات الباب -->
              <div class="settings-section">

                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="door_opentime" data-lng="door_opentime">وقت فتح الباب</label>
                    <input type="number" id="door_opentime" />
                  </div>
                  <div class="fieldItem">
                    <label for="stranger_lock" data-lng="stranger_lock">قفل الغرباء</label>
                    <select id="stranger_lock">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="door_password" data-lng="door_password">كلمة مرور الباب</label>
                    <input type="number" id="door_password" />
                  </div>
                  <div class="fieldItem">
                    <label for="multiusers" data-lng="multiusers">دخول متعدد</label>
                    <select id="multiusers">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="card_reversal" data-lng="card_reversal">عكس البطاقة</label>
                    <select id="card_reversal">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="outwg_shot" data-lng="outwg_shot">إخراج Wiegand قصير</label>
                    <select id="outwg_shot">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="door_interlock" data-lng="door_interlock">تشابك الأبواب</label>
                    <select id="door_interlock">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="door_firealarmin" data-lng="door_firealarmin">مدخل إنذار الحريق</label>
                    <select id="door_firealarmin">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="door_trycount" data-lng="door_trycount">عدد المحاولات</label>
                    <input type="number" id="door_trycount" />
                  </div>
                  <div class="fieldItem">
                    <label for="timezone_punchs" data-lng="timezone_punchs">ضربات المنطقة الزمنية</label>
                    <select id="timezone_punchs">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="access_denied_nolog" data-lng="access_denied_nolog">منع الوصول بلا سجل</label>
                    <select id="access_denied_nolog">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="outof_notimzone_denied" data-lng="outof_notimzone_denied">رفض خارج الوقت المسموح</label>
                    <select id="outof_notimzone_denied">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <h3 data-lng="section_7_title" class="accordion-header">إعدادات الشبكة</h3>
            <div class="accordion-content">
              <!-- (7) إعدادات الشبكة -->
              <div class="settings-section">

                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="deviceid" data-lng="deviceid">رقم الجهاز</label>
                    <input type="number" id="deviceid" />
                  </div>
                  <div class="fieldItem">
                    <label for="netportnum" data-lng="netportnum">رقم منفذ الشبكة</label>
                    <input type="number" id="netportnum" />
                  </div>
                  <div class="fieldItem">
                    <label for="use_bs" data-lng="use_bs">استخدام BS</label>
                    <select id="use_bs">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="use_domain_name" data-lng="use_domain_name">استخدام اسم النطاق</label>
                    <select id="use_domain_name">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="bs_domain_name" data-lng="bs_domain_name">BS Domain Name</label>
                    <input type="text" id="bs_domain_name" />
                  </div>
                  <div class="fieldItem">
                    <label for="serverip_" data-lng="serverip_">Server IP (رقم صحيح)</label>
                    <input type="text" id="serverip_" />
                  </div>
                  <div class="fieldItem">
                    <label for="serverport" data-lng="serverport">Server Port</label>
                    <input type="number" id="serverport" />
                  </div>
                  <div class="fieldItem">
                    <label for="server_response_time" data-lng="server_response_time">Server Resp Time</label>
                    <input type="number" id="server_response_time" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="use_eth_dhcp" data-lng="use_eth_dhcp">Ethernet DHCP</label>
                    <select id="use_eth_dhcp">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="netipaddress" data-lng="netipaddress">Net IP (int)</label>
                    <input type="text" id="netipaddress" />
                  </div>
                  <div class="fieldItem">
                    <label for="netmask" data-lng="netmask">Net Mask (int)</label>
                    <input type="text" id="netmask" />
                  </div>
                  <div class="fieldItem">
                    <label for="netgateway" data-lng="netgateway">Net Gateway (int)</label>
                    <input type="text" id="netgateway" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="dns_server_ip" data-lng="dns_server_ip">DNS Server (int)</label>
                    <input type="text" id="dns_server_ip" />
                  </div>
                  <div class="fieldItem">
                    <label for="use_wlan_dhcp" data-lng="use_wlan_dhcp">WLAN DHCP</label>
                    <select id="use_wlan_dhcp">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="wlan_ip_address" data-lng="wlan_ip_address">WLAN IP (int)</label>
                    <input type="text" id="wlan_ip_address" />
                  </div>
                  <div class="fieldItem">
                    <label for="wlan_net_mask" data-lng="wlan_net_mask">WLAN Mask (int)</label>
                    <input type="text" id="wlan_net_mask" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="wlan_gateway" data-lng="wlan_gateway">WLAN Gateway (int)</label>
                    <input type="text" id="wlan_gateway" />
                  </div>
                </div>
              </div>
            </div>

            <h3 data-lng="section_8_title" class="accordion-header">إعدادات متنوعة</h3>
            <div class="accordion-content">
              <!-- (8) إعدادات متنوعة -->
              <div class="settings-section">

                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="line_notify" data-lng="line_notify">Line Notify</label>
                    <select id="line_notify">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="app_token" data-lng="app_token">App Token</label>
                    <input type="text" id="app_token" />
                  </div>
                  <div class="fieldItem">
                    <label for="shift_weekend" data-lng="shift_weekend">عطلة نهاية الأسبوع</label>
                    <input type="number" id="shift_weekend" />
                  </div>
                  <div class="fieldItem">
                    <label for="auto_sign" data-lng="auto_sign">توقيع تلقائي للغائبين</label>
                    <input type="number" id="auto_sign" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="time_format" data-lng="time_format">صيغة الوقت</label>
                    <input type="number" id="time_format" />
                  </div>
                  <div class="fieldItem">
                    <label for="date_format" data-lng="date_format">صيغة التاريخ</label>
                    <input type="number" id="date_format" />
                  </div>
                  <div class="fieldItem">
                    <label for="language" data-lng="language">اللغة</label>
                    <input type="number" id="language" />
                  </div>
                  <div class="fieldItem">
                    <label for="screensaver_wakeup" data-lng="screensaver_wakeup">استيقاظ شاشة التوقف</label>
                    <select id="screensaver_wakeup">
                      <option value="1" data-lng-option="enable">مفعل</option>
                      <option value="0" data-lng-option="disable">معطل</option>
                    </select>
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="label_style" data-lng="label_style">نمط التسمية</label>
                    <input type="number" id="label_style" />
                  </div>
                  <div class="fieldItem">
                    <label for="identify_distance" data-lng="identify_distance">مسافة التعرف</label>
                    <input type="number" id="identify_distance" />
                  </div>
                  <div class="fieldItem">
                    <label for="verifymode" data-lng="verifymode">نمط التحقق</label>
                    <input type="number" id="verifymode" />
                  </div>
                  <div class="fieldItem">
                    <label for="use_qrcode" data-lng="use_qrcode">استخدام QR</label>
                    <input type="number" id="use_qrcode" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="filllight" data-lng="filllight">الإضاءة الإضافية</label>
                    <input type="number" id="filllight" />
                  </div>
                  <div class="fieldItem">
                    <label for="door_sensor_type" data-lng="door_sensor_type">نوع حساس الباب</label>
                    <input type="number" id="door_sensor_type" />
                  </div>
                  <div class="fieldItem">
                    <label for="door_antipass" data-lng="door_antipass">منع المرور العكسي</label>
                    <input type="number" id="door_antipass" />
                  </div>
                  <div class="fieldItem">
                    <label for="wiegand_output_mode" data-lng="wiegand_output_mode">Wiegand Output Mode</label>
                    <input type="number" id="wiegand_output_mode" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="wiegand_output_bit" data-lng="wiegand_output_bit">Wiegand Output Bit</label>
                    <input type="number" id="wiegand_output_bit" />
                  </div>
                  <div class="fieldItem">
                    <label for="card_disp_format" data-lng="card_disp_format">تنسيق عرض البطاقة</label>
                    <input type="number" id="card_disp_format" />
                  </div>
                  <div class="fieldItem">
                    <label for="combaurate" data-lng="combaurate">منفذ الاتصال</label>
                    <input type="number" id="combaurate" />
                  </div>
                  <div class="fieldItem">
                    <label for="rs485_fun">RS485 Fun</label>
                    <input type="number" id="rs485_fun" />
                  </div>
                </div>
                <div class="fieldGroup">
                  <div class="fieldItem">
                    <label for="server_verify" data-lng="server_verify">التحقق من السيرفر</label>
                    <select id="server_verify">
                      <option value="1" data-lng-option="option_yes">نعم</option>
                      <option value="0" data-lng-option="option_no">لا</option>
                    </select>
                  </div>
                  <div class="fieldItem">
                    <label for="line_push_type">Line Push</label>
                    <input type="number" id="line_push_type" />
                  </div>
                  <div class="fieldItem">
                    <label for="password" data-lng="password">كلمة المرور العامة</label>
                    <input type="text" id="password" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- زر الحفظ -->
          <button class="modalSaveBtn" id="devices_settings_save_button" data-lng=devices_settings_save_button
            onclick="saveDevSettings()">Save Settings
          </button>
        </div>
      </div>
    </div>

    <!-- مودال ضبط أوقات السماحية -->
    <div class="modalOverlay" id="devLockModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="devices_lockmodal_title" data-lng="devices_lockmodal_title">Lock Times</h2>
          <button class="modalCloseBtn" onclick="closeDevLockModal()">×</button>
        </div>
        <div class="modalBody timeZoneSection">
          <!-- الجداول نفسها -->
          <h3 data-lng="time_zone" id="devices_lockmodal_day_zone">Day TimeZone</h3>

          <table class="timeZoneTable">
            <thead>
              <tr>
                <th data-lng="zone_no">NO.</th>
                <th data-lng="zone_1">منطقة زمنية1</th>
                <th data-lng="zone_2">منطقة زمنية2</th>
                <th data-lng="zone_3">منطقة زمنية3</th>
                <th data-lng="zone_4">منطقة زمنية4</th>
                <th data-lng="zone_5">منطقة زمنية5</th>
              </tr>
            </thead>
            <tbody>
              <script>
                for (let i = 0; i < 8; i++) {
                  document.write('<tr><td>' + (i + 1) + '</td>');
                  for (let j = 0; j < 5; j++) {
                    document.write(`<td><input type="text" id="dayzone_${i}_${j}" value="00:00~00:00" /></td>`);
                  }
                  document.write('</tr>');
                }
                // دالة لتحويل الرقم إلى عنوان IP نقطي
                function long2ip(long) {
                  return [
                    (long >>> 24) & 0xFF,
                    (long >>> 16) & 0xFF,  // استخدم >>> هنا
                    (long >>> 8) & 0xFF,   // واستخدم >>> هنا أيضاً
                    long & 0xFF
                  ].join('.');
                }

                // دالة تحويل عنوان IP إلى رقم 32 بت بالترتيب الشبكي (Big‑endian)
                function ip2long(ip) {
                  const parts = ip.split('.');
                  if (parts.length !== 4) return 0;
                  return parts.reduce((acc, part) => (acc << 8) + parseInt(part, 10), 0) >>> 0;
                }

                // إذا كان الجهاز يحتاج إلى ترتيب بايتات مختلف (مثلاً Little‑endian)، يمكنك استخدام دالة لعكس البايتات:
                function reverseBytes(num) {
                  return ((num & 0xFF) << 24) |
                    ((num & 0xFF00) << 8) |
                    ((num >> 8) & 0xFF00) |
                    ((num >> 24) & 0xFF);
                }
              </script>
            </tbody>
          </table>

          <h3 data-lng="week_zone">أسبوع المنطقة الزمنية</h3>
          <table class="timeZoneTable">
            <thead>
              <tr>
                <th data-lng="week_zone_no">NO.</th>
                <th data-lng="day_1">الأحد</th>
                <th data-lng="day_2">الإثنين</th>
                <th data-lng="day_3">الثلاثاء</th>
                <th data-lng="day_4">الأربعاء</th>
                <th data-lng="day_5">الخميس</th>
                <th data-lng="day_6">الجمعة</th>
                <th data-lng="day_7">السبت</th>
              </tr>
            </thead>
            <tbody>
              <script>
                for (let i = 0; i < 8; i++) {
                  document.write('<tr><td>' + (i + 1) + '</td>');
                  for (let j = 0; j < 7; j++) {
                    document.write(
                      `<td>
                      <select id="weekzone_${i}_${j}">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                      </select>
                    </td>`
                    );
                  }
                  document.write('</tr>');
                }
              </script>
            </tbody>
          </table>

          <h3 data-lng="open_time">الوقت الاعتباري للفتح</h3>
          <table class="timeZoneTable">
            <thead>
              <tr>
                <th data-lng="day_1">الأحد</th>
                <th data-lng="day_2">الإثنين</th>
                <th data-lng="day_3">الثلاثاء</th>
                <th data-lng="day_4">الأربعاء</th>
                <th data-lng="day_5">الخميس</th>
                <th data-lng="day_6">الجمعة</th>
                <th data-lng="day_7">السبت</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <script>
                  for (let i = 0; i < 7; i++) {
                    document.write(`<td><select id="nopentime_${i}"><option value="0">0</option><option value="1">1</option></select></td>`);
                  }
                </script>
              </tr>
            </tbody>
          </table>

          <h3 data-lng="visitor_time">وقت الزائر</h3>
          <table class="timeZoneTable">
            <thead>
              <tr>
                <th data-lng="day_1">الأحد</th>
                <th data-lng="day_2">الإثنين</th>
                <th data-lng="day_3">الثلاثاء</th>
                <th data-lng="day_4">الأربعاء</th>
                <th data-lng="day_5">الخميس</th>
                <th data-lng="day_6">الجمعة</th>
                <th data-lng="day_7">السبت</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <script>
                  for (let i = 0; i < 7; i++) {
                    document.write(`<td><select id="visitortime_${i}"><option value="0">0</option><option value="1">1</option></select></td>`);
                  }
                </script>
              </tr>
            </tbody>
          </table>

          <button class="modalSaveBtn" id="devices_lockmodal_save_button" data-lng="save"
            onclick="saveDevLock()">Save</button>
        </div>
      </div>
    </div>

    <!-- مودال الاستبيان -->
    <div class="modalOverlay" id="questionnaireModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="devices_questionnaire_title" data-lng="Questionnaire">Questionnaire</h2>
          <button class="modalCloseBtn" onclick="closeQuestionnaireModal()">×</button>
        </div>
        <div class="modalBody">
          <div style="border:1px solid #ccc; padding:10px; border-radius:6px;">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
              <div style="flex:1;">
                <label data-lng="enabel_quest">تمكين الاستبيان</label>
                <select id="qn_usequestion">
                  <option value="true" data-lng="option_yes">نعم</option>
                  <option value="false" data-lng="option_no">لا</option>
                </select>
              </div>
              <div style="flex:1;">
                <label data-lng="use_table">استخدام الجدول التلقائي</label>
                <select id="qn_useschedule">
                  <option value="true" data-lng="option_yes">نعم</option>
                  <option value="false" data-lng="option_no">لا</option>
                </select>
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
              <div style="flex:1;">
                <label data-lng="one_sllection">اختيار واحد</label>
                <select id="qn_radio">
                  <option value="yes" data-lng="option_yes">yes</option>
                  <option value="no" data-lng="option_no">no</option>
                </select>
              </div>
              <div style="flex:1;">
                <label data-lng="address">العنوان</label>
                <input type="text" id="qn_title" />
              </div>
              <div style="flex:1;">
                <label data-lng="voice">الصوت</label>
                <input type="text" id="qn_voice" />
              </div>
              <div style="flex:1;">
                <label data-lng="error_msg">رسالة الخطأ</label>
                <input type="text" id="qn_errmsg" />
              </div>
            </div>

            <table style="width:100%; border-collapse: collapse;">
              <thead>
                <tr style="background:#007bff; color:#fff;">
                  <th style="border:1px solid #ddd;" data-lng="event">حدث</th>
                  <th style="border:1px solid #ddd;" data-lng="event_info">معلومات الحدث</th>
                  <th style="border:1px solid #ddd;" data-lng="required">مطلوب</th>
                </tr>
              </thead>
              <tbody>
                <script>
                  for (let i = 1; i <= 16; i++) {
                    document.write(`
                    <tr>
                      <td style="border:1px solid #ddd; padding:6px;">${i}</td>
                      <td style="border:1px solid #ddd; padding:6px;">
                        <input style="width:98%;" type="text" id="qn_item_${i}" data-lng-placeholder='place_holder_${i}'/>
                      </td>
                      <td style="border:1px solid #ddd; padding:6px;"></td>
                    </tr>
                  `);
                  }
                </script>
              </tbody>
            </table>

            <div data-lng="hint" style="margin-top:10px; font-size:0.9rem; color:#666;">
              عندما يقوم جميع الأشخاص بتسجيل الدخول أثناء فترة التخطيط للحدث، سيتم تحديد الحدث الدليل افتراضياً...
            </div>

            <!-- جدول الأحداث -->
            <h3 data-lng="event_tables" style="margin-top:20px; font-size:1rem; color:#333;">جدول الأحداث</h3>
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr style="background:#007bff; color:#fff;">
                  <th style="border:1px solid #ddd;">#</th>
                  <th data-lng="start" style="border:1px solid #ddd;">start</th>
                  <th data-lng="end" style="border:1px solid #ddd;">end</th>
                  <th data-lng="event" style="border:1px solid #ddd;">event</th>
                </tr>
              </thead>
              <tbody>
                <script>
                  for (let i = 1; i <= 8; i++) {
                    document.write(`
                    <tr>
                      <td style="border:1px solid #ddd; padding:6px;">${i}</td>
                      <td style="border:1px solid #ddd; padding:6px;">
                        <input style="width:95%;" type="time" id="qn_start_${i}" value="00:00"/>
                      </td>
                      <td style="border:1px solid #ddd; padding:6px;">
                        <input style="width:95%;" type="time" id="qn_end_${i}" value="00:00"/>
                      </td>
                      <td style="border:1px solid #ddd; padding:6px;">
                        <input style="width:95%;" type="number" id="qn_event_${i}" value="0"/>
                      </td>
                    </tr>
                  `);
                  }
                </script>
              </tbody>
            </table>
          </div>
        </div>
        <button class="modalSaveBtn" id="devices_questionnaire_send_button" style="margin:10px;"
          onclick="sendQuestionnaire()">Send</button>
      </div>
    </div>

    <!-- مودال معلومات الجهاز الجديد -->
    <div class="modalOverlay" id="deviceInfoModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="devices_info_title">Device Info</h2>
          <button class="modalCloseBtn" onclick="closeDeviceInfoModal()">×</button>
        </div>
        <div class="modalBody" id="deviceInfoBody">
          <!-- سيتم تعبئة هذه المنطقة ديناميكياً بالبيانات -->
        </div>
      </div>
    </div>

    <script>
      /***************************************************
       *              إعدادات تعدد اللغات
       ***************************************************/
      // يفترض وجود مجلد lang يحوي ar.json و en.json
      const LANG_PATH = './lang';
      const LANG_KEY = 'lng';

      let translations = {};
      function getTranslate(key) { return translations[key] || '' }

      // تحميل ملف الترجمة
      async function loadLanguageFile(lang) {
        try {
          const response = await fetch(`${LANG_PATH}/${lang}_devices.json`);
          if (!response.ok) {
            throw new Error(`Error loading ${lang}.json`);
          }
          translations = await response.json();
        } catch (error) {
          console.error("خطأ عند تحميل ملف الترجمة:", error);
        }
      }

      // تطبيق النصوص المترجمة
      function applyTranslations(lang) {
        // ضبط اتجاه الصفحة
        document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
        document.documentElement.lang = lang;


        document.querySelectorAll('[data-lng]').forEach(el => {
          const key = el.getAttribute('data-lng');
          if (translations[key]) {
            el.textContent = translations[key];
          }
        });

        // تطبيق placeholder
        document.querySelectorAll('[data-lng-placeholder]').forEach(el => {
          const key = el.getAttribute('data-lng-placeholder');
          if (translations[key]) {
            el.placeholder = translations[key];
          }
        });

        // تطبيق نص للأوبشن
        document.querySelectorAll('[data-lng-option]').forEach(el => {
          const key = el.getAttribute('data-lng-option');
          if (translations[key]) {
            el.textContent = translations[key];
          }
        });

        document.querySelectorAll('[data-lng-hover-title]').forEach(el => {
          const key = el.getAttribute('data-lng-hover-title');
          if (translations[key]) {
            el.setAttribute('title', translations[key])
          }
        });
        // // تغيير عنوان الصفحة
        // if (translations['devices_page_title']) {
        //   document.getElementById('devices_page_title').textContent = translations['devices_page_title'];
        // }

        // // هيدر
        // if (translations['devices_header_title']) {
        //   document.getElementById('devices_header_title').textContent = translations['devices_header_title'];
        // }
        // if (translations['devices_btn_logout']) {
        //   document.getElementById('devices_btn_logout').textContent = translations['devices_btn_logout'];
        // }

        // // sidebar
        // if (translations['devices_sidebar_menu_title']) {
        //   document.getElementById('devices_sidebar_menu_title').textContent = translations['devices_sidebar_menu_title'];
        // }
        // if (translations['devices_sidebar_overview']) {
        //   document.getElementById('devices_sidebar_overview').textContent = translations['devices_sidebar_overview'];
        // }
        // // ... وهكذا لبقية العناصر في الشريط الجانبي
        // // يمكنك تكرار نفس النمط لبقية العناصر ذات الـ id المحدد.

        // // حقول البحث
        // if (translations['devices_search_name_label']) {
        //   document.getElementById('devices_search_name_label').textContent = translations['devices_search_name_label'];
        // }
        // if (translations['devices_search_name_placeholder']) {
        //   document.getElementById('searchName').placeholder = translations['devices_search_name_placeholder'];
        // }
        // // بقية حقول البحث...

        // // زر إضافة جهاز
        // if (translations['devices_add_button']) {
        //   document.getElementById('devices_add_button').textContent = translations['devices_add_button'];
        // }

        // // عناوين الجدول
        // if (translations['devices_table_th_no']) {
        //   document.getElementById('devices_table_th_no').textContent = translations['devices_table_th_no'];
        // }
        // // ... تابع بقية العناوين

        // // المودال (إضافة/تعديل جهاز)
        // if (translations['devices_modal_title']) {
        //   document.getElementById('devices_modal_title').textContent = translations['devices_modal_title'];
        // }
        // if (translations['devices_modal_name_label']) {
        //   document.getElementById('devices_modal_name_label').textContent = translations['devices_modal_name_label'];
        // }
        // // ... بقية عناصر المودال

        // // وهكذا لبقية المودالات...

      }

      // تعيين اللغة
      async function setLanguage(lang) {
        await loadLanguageFile(lang);
        localStorage.setItem(LANG_KEY, lang);
        applyTranslations(lang);

        await loadSidebarLangFile(lang);
        applySidebarTranslation();

      }

      // عند تغيير الـ select
      document.getElementById('langSelector').addEventListener('change', async function () {
        await setLanguage(this.value);
        const successMsg = document.getElementById('successMsg').textContent = '';
        const errorMsg = document.getElementById('errorMsg').textContent = '';
      });

      // عند تحميل الصفحة
      window.addEventListener('load', async () => {
        let storedLang = localStorage.getItem(LANG_KEY);
        if (!storedLang) {
          storedLang = 'en';
        }
        document.getElementById('langSelector').value = storedLang;
        await setLanguage(storedLang);
      });

      let authToken = null;
      let allDevices = [];
      let editModeDeviceId = null;

      function initPage() {
        authToken = localStorage.getItem('authToken');
        if (!authToken) {
          window.location.href = 'login.html';
          return;
        }
        loadDevices();
        renderTimeZones()
      }

      function logout() {
        localStorage.removeItem('authToken');
        window.location.href = 'login.html';
      }

      // إظهار شاشة التحميل
      function showLoading() {
        document.getElementById('progressText').textContent = '';
        document.getElementById('loadingOverlay').style.display = 'flex';
      }
      // إخفاء شاشة التحميل
      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('progressText').textContent = '';
      }
      // تحديث نص العداد
      function updateProgressText(msg) {
        document.getElementById('progressText').textContent = msg;
      }

      // إظهار رسالة خطأ
      function showError(msg) {
        const errorMsg = document.getElementById('errorMsg');
        errorMsg.textContent = msg;
        errorMsg.style.display = 'block';
        document.getElementById('successMsg').style.display = 'none';
      }
      // إظهار رسالة نجاح
      function showSuccess(msg) {
        const successMsg = document.getElementById('successMsg');
        successMsg.textContent = msg;
        successMsg.style.display = 'block';
        document.getElementById('errorMsg').style.display = 'none';
      }
      // إخفاء الرسائل
      function clearMessages() {
        document.getElementById('errorMsg').style.display = 'none';
        document.getElementById('successMsg').style.display = 'none';
      }

      // جلب جميع الأجهزة
      async function loadDevices() {
        clearMessages();
        showLoading();
        try {
          const resp = await fetch('/api/devices', {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) {
            throw new Error('Failed to load devices');
          }
          const data = await resp.json();
          allDevices = data;
          renderDevices(data);
        } catch (err) {
          showError(getTranslate('devices_msg_error_fetch'));
        } finally {
          hideLoading();
        }
      }

      // عرض الأجهزة في الجدول
      function renderDevices(devArr) {
        const tb = document.querySelector('#devicesTable tbody');
        tb.innerHTML = '';

        devArr.forEach((d, i) => {
          const creationDate = d.createdAt
            ? new Date(d.createdAt).toISOString().split('T')[0]
            : '';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${d.name || ''}</td>
            <td>${d.serial || ''}</td>
            <td>${d.serverip || ''}</td>
            <td>${d.timeZone || ''}</td>
            <td data-lng='${d.status ? 'devices_modal_status_option_true' : 'devices_modal_status_option_false'}'>${getTranslate(d.status ? 'devices_modal_status_option_true' : 'devices_modal_status_option_false')}</td>
            <td>${creationDate}</td>
            <td data-lng='${d.oldFlag ? 'devices_modal_status_option_true' : 'devices_modal_status_option_false'}'>${getTranslate(d.status ? 'devices_modal_status_option_true' : 'devices_modal_status_option_false')}</td>

            <td>
              <i class="bi bi-pencil-fill actionIcon" data-lng-hover-title='devices_table_control_titles_edit'
                 title=${getTranslate('devices_table_control_titles_edit')}
                 onclick="openModalForEdit('${d._id}')"></i>
              <i class="bi bi-trash-fill actionIcon" data-lng-hover-title='devices_table_control_titles_delete'
                 title=${getTranslate('devices_table_control_titles_delete')}
                 onclick="deleteDevice('${d._id}')"></i>
              <i class="bi bi-gear-fill actionIcon" data-lng-hover-title='devices_table_control_titles_settings'
                 title=${getTranslate('devices_table_control_titles_settings')}
                 onclick="openDeviceSettings('${d.serverip}', '${d.serial}')"></i>
              <i class="bi bi-cloud-download actionIcon" data-lng-hover-title='devices_table_control_titles_pulllog'
                 title=${getTranslate('devices_table_control_titles_pulllog')}
                 onclick="pullLogsFromDevice('${d.serverip}', '${d.serial}')"></i>
              <i class="bi bi-clock-fill actionIcon" data-lng-hover-title='devices_table_control_titles_lock'
                 title=${getTranslate('devices_table_control_titles_lock')}
                 onclick="openDevLockModal('${d.serverip}', '${d.serial}')"></i>
              <i class="bi bi-question-circle-fill actionIcon" data-lng-hover-title='devices_table_control_titles_questionnaire'
                 title=${getTranslate('devices_table_control_titles_questionnaire')}
                 onclick="openQuestionnaireModal('${d.serverip}', '${d.serial}')"></i>
  
              <i class="bi bi-info-circle-fill actionIcon" data-lng-hover-title='devices_table_control_titles_info'
                 title=${getTranslate('devices_table_control_titles_info')}
                 onclick="openDeviceInfo('${d.serverip}', '${d.serial}')"></i>
            </td>
            <td>
              <select class="actionSelect" onchange="handleDeviceAction('${d.serverip}', '${d.serial}', this.value)">
                <option value="">---</option>
                <option value="settime" data-lng='setTime'>${getTranslate('setTime')}</option>
                <option value="reboot" data-lng='Reboot'>${getTranslate('Reboot')}</option>
                <option value="cleanuser" data-lng='Clean_Users'>${getTranslate('Clean_Users')}</option>
                <option value="cleanlog" data-lng='Clean_Logs'>${getTranslate('Clean_Logs')}</option>
                <option value="initsys" data-lng='Init_System'>${getTranslate('Init_System')}</option>
                <option value="cleanadmin" data-lng='Clean_Admin'>${getTranslate('Clean_Admin')}</option>
                <option value="opendoor" data-lng='Open_Door'>${getTranslate('Open_Door')}</option>
              </select>
            </td>
            <td class="connStatusCell">Checking...</td>
          `;
          tb.appendChild(tr);

          // بعد إنشاء الصف نحدث حالة الاتصال
          const connCell = tr.querySelector('.connStatusCell');
          updateDeviceConnectionStatus(d.serverip, d.serial, connCell);
        });
      }

      // فلترة محلية
      function filterDevicesLocally() {
        const nameVal = document.getElementById('searchName').value.toLowerCase().trim();
        const serialVal = document.getElementById('searchSerial').value.toLowerCase().trim();
        const serverIpVal = document.getElementById('searchServerIp').value.toLowerCase().trim();
        const statusVal = document.getElementById('searchStatus').value;
        const creationVal = document.getElementById('searchCreation').value;

        let filtered = allDevices.filter(d => {
          if (nameVal && !d.name?.toLowerCase().includes(nameVal)) return false;
          if (serialVal && !d.serial?.toLowerCase().includes(serialVal)) return false;
          if (serverIpVal && !d.serverip?.toLowerCase().includes(serverIpVal)) return false;
          if (statusVal) {
            const boolStatus = d.status ? 'true' : 'false';
            if (boolStatus !== statusVal) return false;
          }
          if (creationVal) {
            let cdate = d.createdAt
              ? new Date(d.createdAt).toISOString().split('T')[0]
              : '';
            if (cdate !== creationVal) return false;
          }
          return true;
        });

        renderDevices(filtered);
      }

      // فتح المودال للإضافة
      function openModalForAdd() {
        editModeDeviceId = null;
        document.getElementById('devices_modal_title').textContent = getTranslate('devices_modal_add_title');
        document.getElementById('deviceId').value = '';

        document.getElementById('deviceName').value = '';
        document.getElementById('deviceSerial').value = '';
        document.getElementById('serverIp').value = '';
        document.getElementById('oldFlag').value = 'true';
        document.getElementById('deviceStatus').value = 'true';

        showModal();
      }

      // فتح المودال للتعديل
      async function openModalForEdit(id) {
        clearMessages();
        editModeDeviceId = id;
        showLoading();
        try {
          const resp = await fetch(`/api/devices/${id}`, {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error('Failed to get device data');
          const d = await resp.json();

          document.getElementById('devices_modal_title').textContent = getTranslate('devices_modal_edit_title');
          document.getElementById('deviceId').value = d._id || '';
          document.getElementById('deviceName').value = d.name || '';
          document.getElementById('deviceSerial').value = d.serial || '';
          document.getElementById('serverIp').value = d.serverip || '';
          document.getElementById('deviceTimeZone').value = d.timeZone
          document.getElementById('deviceStatus').value = d.status ? 'true' : 'false';
          document.getElementById('oldFlag').value = d.oldFlag ? 'true' : 'false';

          showModal();
        } catch (err) {
          showError(err.message);
        } finally {
          hideLoading();
        }
      }

      // حفظ (إضافة/تعديل)
      async function saveDevice() {
        clearMessages();
        showLoading();

        const deviceId = document.getElementById('deviceId').value;
        const name = document.getElementById('deviceName').value.trim();
        const serial = document.getElementById('deviceSerial').value.trim();
        const serverip = document.getElementById('serverIp').value.trim();
        const timeZone = document.getElementById('deviceTimeZone').value
        const statusVal = (document.getElementById('deviceStatus').value === 'true');
        const oldFlag = (document.getElementById('oldFlag').value === 'true');

        if (!name || !serial || !serverip || !timeZone) return

        clearMessages();
        showLoading();


        const bodyObj = {
          name,
          serial,
          serverip,
          oldFlag,
          timeZone,
          status: statusVal,
        };

        try {
          let url = '/api/devices';
          let method = 'POST';
          if (deviceId) {
            url = `/api/devices/${deviceId}`;
            method = 'PUT';
          }

          const resp = await fetch(url, {
            method,
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(bodyObj)
          });
          if (!resp.ok) throw new Error(`Failed to ${deviceId ? 'update' : 'add'} device`);

          showSuccess(`Device ${deviceId ? 'updated' : 'added'} successfully.`);
          closeModal();
          loadDevices();
        } catch (err) {
          showError(getTranslate(deviceId ? 'devices_msg_error_edit' : 'devices_msg_error_add'));
        } finally {
          hideLoading();
        }
      }

      // حذف
      async function deleteDevice(id) {
        clearMessages();
        if (!confirm(getTranslate('confirm'))) return;

        showLoading();
        try {
          const resp = await fetch(`/api/devices/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error('Failed to delete device');
          showSuccess('Device deleted successfully.');
          loadDevices();
        } catch (err) {
          showError(getTranslate('devices_msg_error_delete'));
        } finally {
          hideLoading();
        }
      }

      // أوامر الإجراء (settime, reboot, إلخ)
      async function handleDeviceAction(serverip, serial, action) {
        clearMessages();
        if (!action) return;
        showLoading();
        try {
          let url = '';
          let bodyObj = {};

          if (action === 'settime') {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const mins = String(now.getMinutes()).padStart(2, '0');
            const secs = String(now.getSeconds()).padStart(2, '0');
            const formattedTime = `${year}-${month}-${day} ${hours}:${mins}:${secs}`;
            bodyObj = { sn: serial, time: formattedTime };
            url = `${serverip}/api/settime`;

          } else if (action === 'reboot') {
            bodyObj = { sn: serial };
            url = `${serverip}/api/reboot`;

          } else if (action === 'cleanuser') {
            bodyObj = { sn: serial };
            url = `${serverip}/api/cleanuser`;

          } else if (action === 'cleanlog') {
            bodyObj = { sn: serial };
            url = `${serverip}/api/cleanlog`;

          } else if (action === 'initsys') {
            bodyObj = { sn: serial };
            url = `${serverip}/api/initsys`;

          } else if (action === 'cleanadmin') {
            bodyObj = { sn: serial };
            url = `${serverip}/api/cleanadmin`;

          } else if (action === 'opendoor') {
            bodyObj = { sn: serial };
            url = `${serverip}/api/opendoor`;
          } else {
            hideLoading();
            return;
          }

          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyObj)
          });

          let result;
          try {
            result = await resp.json();
          } catch (jsonErr) {
            result = { message: await resp.text() };
          }

          if (!resp.ok) {
            throw new Error(result?.error || result?.message || 'Action failed');
          }
          showSuccess(result?.message || 'Action done successfully');

        } catch (err) {
          showError(err.message);
        } finally {
          hideLoading();
        }
      }

      // فحص الاتصال
      async function updateDeviceConnectionStatus(serverip, serial, cell) {
        try {
          const resp = await fetch(`${serverip}/api/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sn: serial })
          });

          if (!resp.ok) {
            setDisconnectedCell(cell);
            return;
          }

          const data = await resp.json();
          if (data?.success && data?.data?.online === true) {
            setConnectedCell(cell);
          } else {
            setDisconnectedCell(cell);
          }
        } catch (err) {
          setDisconnectedCell(cell);
        }
      }
      function setConnectedCell(cell) {
        cell.classList.remove('disconnectedCell');
        cell.classList.add('connectedCell');
        cell.textContent = getTranslate('online');
        cell.setAttribute('data-lng', 'online')
      }
      function setDisconnectedCell(cell) {
        cell.classList.remove('connectedCell');
        cell.classList.add('disconnectedCell');
        cell.textContent = getTranslate('offline');
        cell.setAttribute('data-lng', 'offline')
      }



      function renderTimeZones() {

        const timeZones = Intl.supportedValuesOf("timeZone")
        const currentTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone

        const input = document.getElementById('deviceTimeZone');
        const list = document.getElementById('timezones');

        timeZones.forEach(zone => {
          const opt = document.createElement('option');
          opt.value = zone;
          list.appendChild(opt);
        });

        input.value = currentTimeZone

      }


      // إظهار/إخفاء مودال الجهاز
      function showModal() {
        document.getElementById('deviceModal').style.display = 'flex';
      }
      function closeModal() {
        document.getElementById('deviceModal').style.display = 'none';
        document.getElementById('deviceId').value = '';
        document.getElementById('devices_modal_title').textContent = 'Add Device';
        document.getElementById('deviceName').value = '';
        document.getElementById('deviceSerial').value = '';
        document.getElementById('serverIp').value = '';
        document.getElementById('deviceStatus').value = 'true';
        document.getElementById('oldFlag').value = 'true';
      }

      // سحب السجلات
      async function pullLogsFromDevice(serverip, serial) {
        clearMessages();
        showLoading();
        updateProgressText("Pulling logs...");

        let totalStored = 0;
        let from = 0;
        let to = 20;
        let stn = true;

        try {
          while (true) {
            const logsData = await fetchLogsChunk(serverip, serial, from, to, stn);
            if (!logsData || !logsData.success) {
              break;
            }
            const recordArr = logsData.data.record || [];
            if (recordArr.length === 0) {
              break;
            }
            for (const rec of recordArr) {
              try {
                const stored = await storeLogRecord(rec, logsData.data.sn);
                if (stored) totalStored++;
                updateProgressText(`Stored so far: ${totalStored} logs...`);
              } catch (e) {
                console.warn("Error storing log:", e.message);
              }
            }
            if (recordArr.length < 20) {
              break;
            }
            stn = false;
            from += 20;
            to += 20;
          }

          showSuccess(`Done. Total stored: ${totalStored} logs.`);
        } catch (err) {
          showError("Error pulling logs: " + err.message);
        } finally {
          hideLoading();
        }
      }

      async function fetchLogsChunk(serverip, serial, from, to, stn) {
        const bodyObj = { sn: serial, from, to, stn };
        const resp = await fetch(serverip + '/api/getalllog', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyObj)
        });
        const data = await resp.json();
        return data;
      }

      let storedSet = new Set();
      async function storeLogRecord(rec, deviceSN) {
        let isoTime = convertToISO(rec.time);
        // تعديل الوقت (مثال -3س)
        const deviceTimeZoneOffset = 3;
        let localDt = new Date(isoTime);
        localDt.setHours(localDt.getHours() - deviceTimeZoneOffset);
        isoTime = localDt.toISOString();

        let bodyObj = {
          enrollid: rec.enrollid,
          name: rec.name || "",
          time: isoTime,
          image: "",
          event: rec.event,
          device_sn: deviceSN,
          fetch_date: new Date().toISOString(),
          mode: rec.mode,
          inout: rec.inout
        };

        let resp = await fetch(`/api/fingerprints`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authToken
          },
          body: JSON.stringify(bodyObj)
        });

        if (resp.ok) {
          let uniqueKey = deviceSN + "_" + isoTime;
          storedSet.add(uniqueKey);
          return true;
        } else {
          let msg = "";
          try {
            msg = await resp.text();
          } catch (e) { }
          if (msg.includes("duplicate") || msg.includes("already exists")) {
            return false;
          }
          else {
            throw new Error("Storing log failed: " + msg);
          }
        }
      }

      function convertToISO(dateString) {
        if (!dateString) return new Date().toISOString();
        let tmp = dateString.replace(" ", "T");
        if (!tmp.endsWith("Z")) tmp += ".000Z";
        return tmp;
      }


      // --------------------------------------------------------------------------------
      //                          إعدادات الجهاز
      // --------------------------------------------------------------------------------

      // إعدادات الجهاز
      let currentDeviceSN = null;
      let currentDeviceServerIp = null;
      async function openDeviceSettings(serverip, serial) {
        clearMessages();
        currentDeviceSN = serial;
        currentDeviceServerIp = serverip;
        showLoading();
        try {
          const resp = await fetch(serverip + '/api/getdevinfo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sn: serial })
          });

          if (!resp.ok) {
            throw new Error("Failed to get dev settings. Using defaults.");
          }

          const result = await resp.json();

          if (!result || !result.data) {
            throw new Error("No valid data. Using defaults.");
          }

          fillSettingsForm(result.data);
          showSuccess("Device settings fetched.");
        } catch (err) {
          showError(err.message);
          fillSettingsForm(getDefaultDevInfo());
        } finally {
          hideLoading();
          document.getElementById('deviceSettingsModal').style.display = 'flex';
        }
      }
      function closeSettingsModal() {
        document.getElementById('deviceSettingsModal').style.display = 'none';
        currentDeviceSN = null;
        currentDeviceServerIp = null;
      }
      function getDefaultDevInfo() {
        return {
          rfid_free_reg: 1,
          rfid_auto_reg: 0,
          face_double_check: 1,
          reg_card_1: 0,
          reg_card_2: 0,
          reg_card_3: 0,
          reverifytime: 5,
          glog_warning: 1000,
          use_logphoto: 0,
          stranger_photo: 0,
          verifyfail_hint: 0,
          selfchecklog: 1,
          default_shift: 1,
          shift_weekend_ot: 0,
          excel_password: "",
          allow_latetime: 0,
          allow_earlytime: 0,
          reverify_nolock: 0,
          use_dst: 0,
          dst_start: 117,
          dst_end: 309,
          reboottime1: 0,
          reboottime2: 0,
          reboottime3: 0,
          volume: 9,
          tts_voice: 1,
          multifaces: 1,
          showresulttime: 3,
          screensavertime: 60,
          sleeptime: 15,
          live_detect: 1,
          show_avatar: 1,
          managers: 10,
          hide_privacy: 0,
          fcmatch_level: 52,
          live_treshold: 10,
          wear_mask: 0,
          mask_treshold: 50,
          filllight_period: 0,
          exposure_value: 0,
          online_debug: 0,
          door_opentime: 1,
          stranger_lock: 0,
          door_password: 0,
          multiusers: 0,
          card_reversal: 0,
          outwg_shot: 0,
          door_interlock: 0,
          door_firealarmin: 0,
          door_trycount: 0,
          timezone_punchs: 0,
          access_denied_nolog: 0,
          outof_notimzone_denied: 0,
          deviceid: 1,
          netportnum: 5005,
          use_bs: 1,
          use_domain_name: 0,
          bs_domain_name: "http://4.2.2.235:8080/api",
          serverip: 67240683,
          serverport: 7711,
          server_response_time: 0,
          use_eth_dhcp: 0,
          netipaddress: 3232236000,
          netmask: 4294967040,
          netgateway: 3232235777,
          dns_server_ip: 134744072,
          use_wlan_dhcp: 1,
          wlan_ip_address: 67240617,
          wlan_net_mask: 4294967040,
          wlan_gateway: 67240449,
          line_notify: 0,
          app_token: "",
          shift_weekend: 5,
          auto_sign: 3,
          time_format: 0,
          date_format: 0,
          language: 13,
          screensaver_wakeup: 0,
          label_style: 2,
          identify_distance: 2,
          verifymode: 0,
          use_qrcode: 2,
          filllight: 0,
          door_sensor_type: 0,
          door_antipass: 0,
          wiegand_output_mode: 0,
          wiegand_output_bit: 0,
          card_disp_format: 0,
          combaurate: 2,
          rs485_fun: 1,
          server_verify: 0,
          line_push_type: 0,
          password: "aa"
        };
      }

      function fillSettingsForm(info) {
        document.getElementById('rfid_free_reg').value = info.rfid_free_reg;
        document.getElementById('rfid_auto_reg').value = info.rfid_auto_reg;
        document.getElementById('face_double_check').value = info.face_double_check;
        document.getElementById('reg_card_1').value = info.reg_card_1;
        document.getElementById('reg_card_2').value = info.reg_card_2;
        document.getElementById('reg_card_3').value = info.reg_card_3;
        document.getElementById('reverifytime').value = info.reverifytime;
        document.getElementById('glog_warning').value = info.glog_warning;
        document.getElementById('use_logphoto').value = info.use_logphoto;
        document.getElementById('stranger_photo').value = info.stranger_photo;
        document.getElementById('verifyfail_hint').value = info.verifyfail_hint;
        document.getElementById('selfchecklog').value = info.selfchecklog;
        document.getElementById('default_shift').value = info.default_shift;
        document.getElementById('shift_weekend_ot').value = info.shift_weekend_ot;
        document.getElementById('excel_password').value = info.excel_password;
        document.getElementById('allow_latetime').value = info.allow_latetime;
        document.getElementById('allow_earlytime').value = info.allow_earlytime;
        document.getElementById('reverify_nolock').value = info.reverify_nolock;
        document.getElementById('use_dst').value = info.use_dst;
        document.getElementById('dst_start').value = info.dst_start;
        document.getElementById('dst_end').value = info.dst_end;
        document.getElementById('reboottime1').value = info.reboottime1;
        document.getElementById('reboottime2').value = info.reboottime2;
        document.getElementById('reboottime3').value = info.reboottime3;
        document.getElementById('volume').value = info.volume;
        document.getElementById('tts_voice').value = info.tts_voice;
        document.getElementById('multifaces').value = info.multifaces;
        document.getElementById('showresulttime').value = info.showresulttime;
        document.getElementById('screensavertime').value = info.screensavertime;
        document.getElementById('sleeptime').value = info.sleeptime;
        document.getElementById('live_detect').value = info.live_detect;
        document.getElementById('show_avatar').value = info.show_avatar;
        document.getElementById('managers').value = info.managers;
        document.getElementById('hide_privacy').value = info.hide_privacy;
        document.getElementById('fcmatch_level').value = info.fcmatch_level;
        document.getElementById('live_treshold').value = info.live_treshold;
        document.getElementById('wear_mask').value = info.wear_mask;
        document.getElementById('mask_treshold').value = info.mask_treshold;
        document.getElementById('filllight_period').value = info.filllight_period;
        document.getElementById('exposure_value').value = info.exposure_value;
        document.getElementById('online_debug').value = info.online_debug;
        document.getElementById('door_opentime').value = info.door_opentime;
        document.getElementById('stranger_lock').value = info.stranger_lock;
        document.getElementById('door_password').value = info.door_password;
        document.getElementById('multiusers').value = info.multiusers;
        document.getElementById('card_reversal').value = info.card_reversal;
        document.getElementById('outwg_shot').value = info.outwg_shot;
        document.getElementById('door_interlock').value = info.door_interlock;
        document.getElementById('door_firealarmin').value = info.door_firealarmin;
        document.getElementById('door_trycount').value = info.door_trycount;
        document.getElementById('timezone_punchs').value = info.timezone_punchs;
        document.getElementById('access_denied_nolog').value = info.access_denied_nolog;
        document.getElementById('outof_notimzone_denied').value = info.outof_notimzone_denied;
        document.getElementById('deviceid').value = info.deviceid;
        document.getElementById('netportnum').value = info.netportnum;
        document.getElementById('use_bs').value = info.use_bs;
        document.getElementById('use_domain_name').value = info.use_domain_name;
        document.getElementById('bs_domain_name').value = info.bs_domain_name;
        document.getElementById('serverip_').value = long2ip(parseInt(info.serverip, 10));
        document.getElementById('serverport').value = info.serverport;
        document.getElementById('server_response_time').value = info.server_response_time;
        document.getElementById('use_eth_dhcp').value = info.use_eth_dhcp;
        document.getElementById('netipaddress').value = long2ip(parseInt(info.netipaddress, 10));
        document.getElementById('netmask').value = long2ip(parseInt(info.netmask, 10));
        document.getElementById('netgateway').value = long2ip(parseInt(info.netgateway, 10));
        document.getElementById('dns_server_ip').value = long2ip(parseInt(info.dns_server_ip, 10));
        document.getElementById('use_wlan_dhcp').value = info.use_wlan_dhcp;
        document.getElementById('wlan_ip_address').value = long2ip(parseInt(info.wlan_ip_address, 10));
        document.getElementById('wlan_net_mask').value = long2ip(parseInt(info.wlan_net_mask, 10));
        document.getElementById('wlan_gateway').value = long2ip(parseInt(info.wlan_gateway, 10));
        document.getElementById('line_notify').value = info.line_notify;
        document.getElementById('app_token').value = info.app_token;
        document.getElementById('shift_weekend').value = info.shift_weekend;
        document.getElementById('auto_sign').value = info.auto_sign;
        document.getElementById('time_format').value = info.time_format;
        document.getElementById('date_format').value = info.date_format;
        document.getElementById('language').value = info.language;
        document.getElementById('screensaver_wakeup').value = info.screensaver_wakeup;
        document.getElementById('label_style').value = info.label_style;
        document.getElementById('identify_distance').value = info.identify_distance;
        document.getElementById('verifymode').value = info.verifymode;
        document.getElementById('use_qrcode').value = info.use_qrcode;
        document.getElementById('filllight').value = info.filllight;
        document.getElementById('door_sensor_type').value = info.door_sensor_type;
        document.getElementById('door_antipass').value = info.door_antipass;
        document.getElementById('wiegand_output_mode').value = info.wiegand_output_mode;
        document.getElementById('wiegand_output_bit').value = info.wiegand_output_bit;
        document.getElementById('card_disp_format').value = info.card_disp_format;
        document.getElementById('combaurate').value = info.combaurate;
        document.getElementById('rs485_fun').value = info.rs485_fun;
        document.getElementById('server_verify').value = info.server_verify;
        document.getElementById('line_push_type').value = info.line_push_type;
        document.getElementById('password').value = info.password;
      }

      // جمع بيانات النموذج (الإعدادات)
      function ip2long(ip) {
        const parts = ip.split('.');
        if (parts.length !== 4) return 0;
        return parts.reduce((acc, part) => (acc << 8) + parseInt(part, 10), 0) >>> 0;
      }
      function collectSettingsForm() {
        return {
          sn: currentDeviceSN,
          devInfo: {
            rfid_free_reg: parseInt(document.getElementById('rfid_free_reg').value) || 0,
            rfid_auto_reg: parseInt(document.getElementById('rfid_auto_reg').value) || 0,
            face_double_check: parseInt(document.getElementById('face_double_check').value) || 0,
            reg_card_1: parseInt(document.getElementById('reg_card_1').value) || 0,
            reg_card_2: parseInt(document.getElementById('reg_card_2').value) || 0,
            reg_card_3: parseInt(document.getElementById('reg_card_3').value) || 0,
            reverifytime: parseInt(document.getElementById('reverifytime').value) || 5,
            glog_warning: parseInt(document.getElementById('glog_warning').value) || 1000,
            use_logphoto: parseInt(document.getElementById('use_logphoto').value) || 0,
            stranger_photo: parseInt(document.getElementById('stranger_photo').value) || 0,
            verifyfail_hint: parseInt(document.getElementById('verifyfail_hint').value) || 0,
            selfchecklog: parseInt(document.getElementById('selfchecklog').value) || 1,
            default_shift: parseInt(document.getElementById('default_shift').value) || 1,
            shift_weekend_ot: parseInt(document.getElementById('shift_weekend_ot').value) || 0,
            excel_password: document.getElementById('excel_password').value,
            allow_latetime: parseInt(document.getElementById('allow_latetime').value) || 0,
            allow_earlytime: parseInt(document.getElementById('allow_earlytime').value) || 0,
            reverify_nolock: parseInt(document.getElementById('reverify_nolock').value) || 0,
            use_dst: parseInt(document.getElementById('use_dst').value) || 0,
            dst_start: parseInt(document.getElementById('dst_start').value) || 0,
            dst_end: parseInt(document.getElementById('dst_end').value) || 0,
            reboottime1: parseInt(document.getElementById('reboottime1').value) || 0,
            reboottime2: parseInt(document.getElementById('reboottime2').value) || 0,
            reboottime3: parseInt(document.getElementById('reboottime3').value) || 0,
            volume: parseInt(document.getElementById('volume').value) || 9,
            tts_voice: parseInt(document.getElementById('tts_voice').value) || 0,
            multifaces: parseInt(document.getElementById('multifaces').value) || 1,
            showresulttime: parseInt(document.getElementById('showresulttime').value) || 3,
            screensavertime: parseInt(document.getElementById('screensavertime').value) || 60,
            sleeptime: parseInt(document.getElementById('sleeptime').value) || 15,
            live_detect: parseInt(document.getElementById('live_detect').value) || 0,
            show_avatar: parseInt(document.getElementById('show_avatar').value) || 0,
            managers: parseInt(document.getElementById('managers').value) || 0,
            hide_privacy: parseInt(document.getElementById('hide_privacy').value) || 0,
            fcmatch_level: parseInt(document.getElementById('fcmatch_level').value) || 0,
            live_treshold: parseInt(document.getElementById('live_treshold').value) || 0,
            wear_mask: parseInt(document.getElementById('wear_mask').value) || 0,
            mask_treshold: parseInt(document.getElementById('mask_treshold').value) || 0,
            filllight_period: parseInt(document.getElementById('filllight_period').value) || 0,
            exposure_value: parseInt(document.getElementById('exposure_value').value) || 0,
            online_debug: parseInt(document.getElementById('online_debug').value) || 0,
            door_opentime: parseInt(document.getElementById('door_opentime').value) || 0,
            stranger_lock: parseInt(document.getElementById('stranger_lock').value) || 0,
            door_password: parseInt(document.getElementById('door_password').value) || 0,
            multiusers: parseInt(document.getElementById('multiusers').value) || 0,
            card_reversal: parseInt(document.getElementById('card_reversal').value) || 0,
            outwg_shot: parseInt(document.getElementById('outwg_shot').value) || 0,
            door_interlock: parseInt(document.getElementById('door_interlock').value) || 0,
            door_firealarmin: parseInt(document.getElementById('door_firealarmin').value) || 0,
            door_trycount: parseInt(document.getElementById('door_trycount').value) || 0,
            timezone_punchs: parseInt(document.getElementById('timezone_punchs').value) || 0,
            access_denied_nolog: parseInt(document.getElementById('access_denied_nolog').value) || 0,
            outof_notimzone_denied: parseInt(document.getElementById('outof_notimzone_denied').value) || 0,
            deviceid: parseInt(document.getElementById('deviceid').value) || 1,
            netportnum: parseInt(document.getElementById('netportnum').value) || 5005,
            use_bs: parseInt(document.getElementById('use_bs').value) || 0,
            use_domain_name: parseInt(document.getElementById('use_domain_name').value) || 0,
            bs_domain_name: document.getElementById('bs_domain_name').value,
            serverip: ip2long(document.getElementById('serverip_').value) || 0,
            serverport: parseInt(document.getElementById('serverport').value) || 0,
            server_response_time: parseInt(document.getElementById('server_response_time').value) || 0,
            use_eth_dhcp: parseInt(document.getElementById('use_eth_dhcp').value) || 0,
            netipaddress: ip2long(document.getElementById('netipaddress').value) || 0,
            netmask: ip2long(document.getElementById('netmask').value) || 0,
            netgateway: ip2long(document.getElementById('netgateway').value) || 0,
            dns_server_ip: ip2long(document.getElementById('dns_server_ip').value) || 0,
            use_wlan_dhcp: parseInt(document.getElementById('use_wlan_dhcp').value) || 0,
            wlan_ip_address: ip2long(document.getElementById('wlan_ip_address').value) || 0,
            wlan_net_mask: ip2long(document.getElementById('wlan_net_mask').value) || 0,
            wlan_gateway: ip2long(document.getElementById('wlan_gateway').value) || 0,
            line_notify: parseInt(document.getElementById('line_notify').value) || 0,
            app_token: document.getElementById('app_token').value,
            shift_weekend: parseInt(document.getElementById('shift_weekend').value) || 0,
            auto_sign: parseInt(document.getElementById('auto_sign').value) || 0,
            time_format: parseInt(document.getElementById('time_format').value) || 0,
            date_format: parseInt(document.getElementById('date_format').value) || 0,
            language: parseInt(document.getElementById('language').value) || 0,
            screensaver_wakeup: parseInt(document.getElementById('screensaver_wakeup').value) || 0,
            label_style: parseInt(document.getElementById('label_style').value) || 0,
            identify_distance: parseInt(document.getElementById('identify_distance').value) || 0,
            verifymode: parseInt(document.getElementById('verifymode').value) || 0,
            use_qrcode: parseInt(document.getElementById('use_qrcode').value) || 0,
            filllight: parseInt(document.getElementById('filllight').value) || 0,
            door_sensor_type: parseInt(document.getElementById('door_sensor_type').value) || 0,
            door_antipass: parseInt(document.getElementById('door_antipass').value) || 0,
            wiegand_output_mode: parseInt(document.getElementById('wiegand_output_mode').value) || 0,
            wiegand_output_bit: parseInt(document.getElementById('wiegand_output_bit').value) || 0,
            card_disp_format: parseInt(document.getElementById('card_disp_format').value) || 0,
            combaurate: parseInt(document.getElementById('combaurate').value) || 0,
            rs485_fun: parseInt(document.getElementById('rs485_fun').value) || 0,
            server_verify: parseInt(document.getElementById('server_verify').value) || 0,
            line_push_type: parseInt(document.getElementById('line_push_type').value) || 0,
            password: document.getElementById('password').value,
            cmd: "setdevinfo",
            nowtime: Math.floor(Date.now() / 1000)
          }
        };
      }

      async function saveDevSettings() {
        if (!currentDeviceSN) {
          showError();
          return;
        }
        clearMessages();
        showLoading();
        try {
          const bodyObj = collectSettingsForm();
          const resp = await fetch(currentDeviceServerIp + '/api/setdevinfo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyObj)
          });
          let result;
          try {
            result = await resp.json();
          } catch (e) {
            result = { message: await resp.text() };
          }

          if (!resp.ok) {
            throw new Error(result?.error || result?.message || "فشل حفظ الإعدادات");
          }
          showSuccess(result?.message || "تم حفظ الإعدادات بنجاح");
          closeSettingsModal();
        } catch (err) {
          showError(err.message);
        } finally {
          hideLoading();
        }
      }

      // --------------------------------------------------------------------------------
      //  إعدادات أوقات السماحية (dayzone/weekzone...) - كما في كودك السابق
      // --------------------------------------------------------------------------------
      let currentLockSN = null;
      let currentLockServerIp = null;
      let devLockData = null;

      async function openDevLockModal(serverip, serial) {
        clearMessages();
        currentLockSN = serial;
        currentLockServerIp = serverip;
        showLoading();
        try {
          const resp = await fetch(serverip + '/api/getdevlock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sn: serial }),
          });

          if (!resp.ok) {
            throw new Error("Failed to get dev lock data.");
          }

          const resJson = await resp.json();

          if (!resJson || !resJson.data) {
            throw new Error("No lock data found.");
          }

          devLockData = resJson.data;
          fillLockForm(devLockData);
          showSuccess("Lock data fetched.");
        } catch (err) {
          showError(err.message);
          devLockData = getEmptyLockData();
          fillLockForm(devLockData);
        } finally {
          hideLoading();
          document.getElementById('devLockModal').style.display = 'flex';
        }
      }
      function closeDevLockModal() {
        document.getElementById('devLockModal').style.display = 'none';
        currentLockSN = null;
        currentLockServerIp = null;
        devLockData = null;
      }

      function getEmptyLockData() {
        return {
          password: "aa",
          cmd: "setdevlock",
          dayzone: [
            { "day": [{ "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }] },
            { "day": [{ "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }] },
            { "day": [{ "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }] },
            { "day": [{ "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }] },
            { "day": [{ "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }] },
            { "day": [{ "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }] },
            { "day": [{ "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }] },
            { "day": [{ "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }, { "section": "00:00~00:00" }] },
          ],
          weekzone: [
            { "week": [{ "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }] },
            { "week": [{ "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }] },
            { "week": [{ "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }] },
            { "week": [{ "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }] },
            { "week": [{ "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }] },
            { "week": [{ "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }] },
            { "week": [{ "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }] },
            { "week": [{ "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }] },
          ],
          nopentime: [
            { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }
          ],
          visitortime: [
            { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }, { "day": 0 }
          ]
        };
      }

      function fillLockForm(d) {
        for (let i = 0; i < 8; i++) {
          for (let j = 0; j < 5; j++) {
            const fld = document.getElementById(`dayzone_${i}_${j}`);
            fld.value = d.dayzone[i]?.day[j]?.section || "00:00~00:00";
          }
        }
        for (let i = 0; i < 8; i++) {
          for (let j = 0; j < 7; j++) {
            const fld = document.getElementById(`weekzone_${i}_${j}`);
            fld.value = d.weekzone[i]?.week[j]?.day || 0;
          }
        }
        for (let i = 0; i < 7; i++) {
          document.getElementById(`nopentime_${i}`).value = d.nopentime[i]?.day || 0;
        }
        for (let i = 0; i < 7; i++) {
          document.getElementById(`visitortime_${i}`).value = d.visitortime[i]?.day || 0;
        }
      }

      function collectLockForm() {
        const res = {
          password: devLockData.password || "aa",
          cmd: "setdevlock",
          dayzone: [],
          weekzone: [],
          nopentime: [],
          visitortime: []
        };
        for (let i = 0; i < 8; i++) {
          let dayArr = [];
          for (let j = 0; j < 5; j++) {
            const val = document.getElementById(`dayzone_${i}_${j}`).value.trim();
            dayArr.push({ section: val });
          }
          res.dayzone.push({ day: dayArr });
        }
        for (let i = 0; i < 8; i++) {
          let wArr = [];
          for (let j = 0; j < 7; j++) {
            const val = parseInt(document.getElementById(`weekzone_${i}_${j}`).value) || 0;
            wArr.push({ day: val });
          }
          res.weekzone.push({ week: wArr });
        }
        for (let i = 0; i < 7; i++) {
          const val = parseInt(document.getElementById(`nopentime_${i}`).value) || 0;
          res.nopentime.push({ day: val });
        }
        for (let i = 0; i < 7; i++) {
          const val = parseInt(document.getElementById(`visitortime_${i}`).value) || 0;
          res.visitortime.push({ day: val });
        }
        return res;
      }

      async function saveDevLock() {
        if (!currentLockSN) {
          showError(getTranslate('noDevice'));
          return;
        }
        clearMessages();
        showLoading();
        try {
          const lockObj = collectLockForm();
          const bodyObj = {
            sn: currentLockSN,
            devLockInfo: lockObj
          };
          const resp = await fetch(currentLockServerIp + '/api/setdevlock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyObj)
          });
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error("فشل حفظ بيانات السماحية: " + txt);
          }
          showSuccess("تم حفظ بيانات السماحية بنجاح.");
          closeDevLockModal();
        } catch (err) {
          showError(err.message);
        } finally {
          hideLoading();
        }
      }

      // --------------------------------------------------------------------------------
      //  الاستبيان (Questionnaire)
      // --------------------------------------------------------------------------------
      let currentQuestionnaireSN = null;
      let currentQuestionnaireServerIp = null;

      function openQuestionnaireModal(serverip, serial) {
        clearMessages();
        currentQuestionnaireSN = serial;
        currentQuestionnaireServerIp = serverip
        const modal = document.getElementById('questionnaireModal')
        modal.style.display = 'flex';
        const dir = document.getElementById('langSelector').value == 'ar' ? 'rtl' : 'ltr'
        modal.style.direction = dir
      }

      function closeQuestionnaireModal() {
        document.getElementById('questionnaireModal').style.display = 'none';
        currentQuestionnaireSN = null;
        currentQuestionnaireServerIp = null
      }

      async function sendQuestionnaire() {
        clearMessages();
        if (!currentQuestionnaireSN) {
          showError(getTranslate('no_current_device'));
          return;
        }
        showLoading();
        try {
          const titleVal = document.getElementById('qn_title').value.trim() || "استبيان";
          const voiceVal = document.getElementById('qn_voice').value.trim() || "";
          const errmsgVal = document.getElementById('qn_errmsg').value.trim() || "";
          const radioVal = (document.getElementById('qn_radio').value === "yes");
          const usequestionVal = (document.getElementById('qn_usequestion').value === 'true');
          const usescheduleVal = (document.getElementById('qn_useschedule').value === 'true');

          let itemsArr = [];
          for (let i = 1; i <= 16; i++) {
            const val = document.getElementById('qn_item_' + i).value.trim();
            if (val !== "") itemsArr.push(val);
          }

          let schedulesArr = [];
          for (let i = 1; i <= 8; i++) {
            const startVal = document.getElementById('qn_start_' + i).value || "00:00";
            const endVal = document.getElementById('qn_end_' + i).value || "00:00";
            const evVal = document.getElementById('qn_event_' + i).value || "0";
            schedulesArr.push(`${startVal}-${endVal}*${evVal}`);
          }

          const payload = {
            title: titleVal,
            voice: voiceVal,
            errmsg: errmsgVal,
            radio: radioVal,
            optionflag: 0,
            usequestion: usequestionVal,
            useschedule: usescheduleVal,
            items: itemsArr,
            schedules: schedulesArr,
            password: "aa",
            cmd: "setquestionnaire"
          };

          const bodyObj = {
            sn: currentQuestionnaireSN,
            payload
          };

          const resp = await fetch(currentQuestionnaireServerIp + '/api/dynamic', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + authToken
            },
            body: JSON.stringify(bodyObj)
          });

          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error("فشل إرسال الاستبيان: " + txt);
          }
          showSuccess("تم إرسال الاستبيان بنجاح.");
          closeQuestionnaireModal();
        } catch (err) {
          showError(err.message);
        } finally {
          hideLoading();
        }
      }

      // --------------------------------------------------------------------------------
      //  جديد: عرض معلومات الجهاز (Information)
      // --------------------------------------------------------------------------------
      function openDeviceInfo(serverip, serial) {
        clearMessages();
        showLoading();
        // نأتي بمعلومات الجهاز من السيرفر الوسيط (مثال: /api/getdeviceinfo)
        fetch(serverip + '/api/getdeviceinfo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sn: serial })
        })
          .then(async (resp) => {
            if (!resp.ok) {
              const txt = await resp.text();
              throw new Error(getTranslate('get_device_info_error') + txt);
            }
            const data = await resp.json();
            fillDeviceInfoModal(data);
            document.getElementById('deviceInfoModal').style.display = 'flex';
          })
          .catch(err => {
            showError(err.message);
          })
          .finally(() => {
            hideLoading();
          });
      }

      function fillDeviceInfoModal(infoData) {
        // مثال بسيط لعرض البيانات في جدول
        const container = document.getElementById('deviceInfoBody');
        container.innerHTML = '';

        // إذا كان infoData بالشكل: { success: true, data: {...} } نحاول استخراج data
        const realData = infoData.data || infoData;

        let html = `
        <table>
          <thead>
            <tr><th>الحقل</th><th>القيمة</th></tr>
          </thead>
          <tbody>
      `;
        // نجول في حقول الكائن realData ونعرضها
        for (const key in realData) {
          html += `
          <tr>
            <td>${key}</td>
            <td>${realData[key] ?? ''}</td>
          </tr>
        `;
        }
        html += `</tbody></table>`;
        container.innerHTML = html;
      }

      function closeDeviceInfoModal() {
        document.getElementById('deviceInfoModal').style.display = 'none';
        document.getElementById('deviceInfoBody').innerHTML = '';
      }


      function loadSiebar() {
        fetch('sidebar.html')
          .then(response => response.text())
          .then(data => {
            document.querySelector('.sidebar').innerHTML = data;
            var submenus = document.querySelectorAll('.submenu');
            submenus.forEach(function (submenu) {
              if (submenu.querySelector('.navItem.active')) {
                submenu.style.display = "block";
              }
            });

            addActiveToSubmenuClass(1);
          })
          .catch(error => console.error('Error loading sidebar:', error));
      }

      async function loadSidebarLangFile(lang) {
        try {
          const response = await fetch(`${LANG_PATH}/${lang}_sidebar.json`);
          if (!response.ok) {
            throw new Error(`Error loading ${lang}_sidebar.json`);
          }
          sidebarLabels = await response.json();

        } catch (error) {
          console.error("Report translation file error:", error);
        }
      }

      function applySidebarTranslation() {
        document.querySelectorAll('.sidebar [data-lng]').forEach(el => {
          const key = el.getAttribute('data-lng');

          if (sidebarLabels[key]) {
            el.textContent = sidebarLabels[key];
          }
        });
      }

      loadSiebar();

      function addActiveToSubmenuClass(childIndex) {
        const submenu = document.getElementById('deviceManagementSubmenu');
        submenu.style.display = "block";
        const navItems = submenu.getElementsByClassName('navItem');
        if (childIndex >= 1 && childIndex <= navItems.length) {
          Array.from(navItems).forEach(item => item.classList.remove('active'));
          navItems[childIndex - 1].classList.add('active');
        } else {
          console.error('Child index out of bounds');
        }
      }


      document.addEventListener("DOMContentLoaded", function () {
        let acc = document.getElementsByClassName("accordion-header");
        for (let i = 0; i < acc.length; i++) {
          acc[i].addEventListener("click", function () {

            // Close all other accordion contents
            for (let j = 0; j < acc.length; j++) {
              if (acc[j] !== this) {
                acc[j].classList.remove("active");
                acc[j].nextElementSibling.style.display = "none";
              }
            }
            // Toggle this accordion's content
            this.classList.toggle("active");
            let panel = this.nextElementSibling;
            if (panel.style.display === "block") {
              panel.style.display = "none";
            } else {
              panel.style.display = "block";
            }
          });
        }
      });


    </script>
</body>

</html>