<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>الاعدادات العامة</title>

  <!-- مكتبة jQuery (إن احتجتها) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- مكتبة Select2 (اختياري) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- أيقونات Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- خط Tajawal من Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <style>
    html { animation: fadeIn .3s ease-in forwards; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* عند العربية: Tajawal + RTL */
    html[lang="ar"] body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }
    /* عند الإنجليزية: Open Sans + LTR */
    html[lang="en"] body {
      font-family: 'Open Sans', sans-serif;
      direction: ltr;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Tajawal', sans-serif;
      background: #f2f2f2;
      direction: rtl;
    }
    /* رأس الصفحة */
    header {
      background: linear-gradient(45deg, #0062cc, #004085);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    .lang-select {
      margin-left: 10px;
      padding: 5px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    header button {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }
    header button:hover {
      background: #c82333;
    }
    /* زر اختيار اللغة */
    #langSelector {
      margin: 10px;
      padding: 6px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }


    /* شاشة التحميل (Overlay) */
    .loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #00000080;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }


    /* الرسائل */
    .errorMsg,
    .successMsg {
      margin: 10px 0;
      font-size: 0.95rem;
      font-weight: 600;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .errorMsg {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .successMsg {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    /* الحاوية العامة بعكس الاتجاه لعرض الـSidebar يمينًا */
    .container {
      display: flex;
      flex-direction: row-reverse;
    }
    /* المحتوى الرئيسي */
    .mainContent {
      flex: 1;
      padding: 20px;
    }
    /* الشريط الجانبي (Sidebar) */
    .sidebar {
      width: 240px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      padding: 20px 10px;
    }
    .sidebar h2 {
      margin-bottom: 15px;
      font-size: 1rem;
      text-align: center;
      color: #444;
    }
    .navItem {
      padding: 12px 10px;
      margin: 6px 0;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      font-weight: 500;
      transition: background 0.3s, color 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .navItem i {
      font-size: 1.1rem;
      color: #666;
      transition: color 0.3s;
    }
    .navItem:hover {
      background: #f0f0f0;
    }
    .navItem.active {
      background: #007bff;
      color: #fff;
    }
    .navItem.active i {
      color: #fff;
    }

    /* start from here the content *//* start from here the content */
    /* start from here the content *//* start from here the content */
    /* start from here the content *//* start from here the content */

    /* حاوية البحث (Filters) */
    .topSection {
      background: #fff;padding: 10px;margin-bottom: 15px;
      border-radius: 6px;box-shadow: 0 2px 5px #0000001a;
    }
    .timezoneField {
      display: flex;flex-wrap: wrap;gap: 10px;align-items: center;
    }
    .timezoneField label { margin-right: 4px;font-weight: 500; }
    .timezoneField input{
      padding: 6px;font-size: 0.9rem;
      border: 1px solid #ccc;border-radius: 4px;
    }

    .sec2{
      display: flex;align-items: center;justify-content: space-between;
      margin-block: 62px 15px;
    }
    .sec2 p{
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .saveBtn{
      color: #fff;margin-block: 24px 6px;
      background: #007bff;
      border: none;
      border-radius: 4px;
      font-family: sans-serif;
      padding: 8px 30px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .saveBtn:hover{ background: #0d66c4; }

    .addBtn {
      background: #28a745;
      color: #fff;
      padding: 8px 14px;
      border-radius: 4px;
      transition: background 0.3s;
      font-size: .9rem;
      font-family: sans-serif;
      border: none;
      cursor: pointer;
    }

    .addBtn:hover {
      background: #218838;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    table thead {
      background: #007bff;
      color: #fff;
    }

    table th,
    table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    .actionIcon {
      color: #007bff;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 6px;
      transition: color 0.3s;
    }

    .actionIcon:hover {
      color: #0056b3;
    }




    .modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modalContent {
      width: 400px;
      max-width: 90%;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: fadeInModal 0.3s ease;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid #eee;
    }

    @keyframes fadeInModal {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modalHeader {
      background: #007bff;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modalHeader h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .modalCloseBtn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.3s;
    }

    .modalCloseBtn:hover {
      color: #ffdddd;
    }

    .modalBody {
      padding: 20px;
    }

    .modalBody label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .modalBody input,
    .modalBody select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .modalSaveBtn,.saveScheduleBtn {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px 14px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 0.9rem;
      transition: background 0.3s;
    }



    .modalSaveBtn:hover {
      background: #218838;
    }

    .saveScheduleBtn{ background: #007bff; }
    .saveScheduleBtn:hover{ background: #0756aa; }

    .modalContent.scheduleWidth {
      width: 600px;
      max-height: 90vh;
    }

    .restBtn{background: #17a2b8;}
    .restBtn:hover{ background: #12889b; }

    .scheduleTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .scheduleTable thead {
      background: #17a2b8;
      color: #fff;
    }

    .scheduleTable th,
    .scheduleTable td {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
      font-size: 0.85rem;
    }

    .btnSmall {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
      border: none;
    }

    .btnSmall:hover {
      opacity: 0.9;
    }

    .applyBtn{
      background: #17a2b8;margin: 0;
    }
    .applyBtn:hover{
      background: #12889b;
    }



  </style>
</head>

<body onload="initPage()">
  <!-- هيدر -->
  <header>
    <h1 data-lng="header_title">الاعدادات العامة</h1>
    <div>
      <button data-lng="logout" onclick="logout()">خروج</button>
      <!-- اختيار اللغة (مثل صفحة اللوجن) -->
      <select id="langSelector" id="langSelector">
        <option value="en">English</option>
        <option value="ar">العربية</option>
      </select>
    </div>
  </header>


  <!-- حاوية التحميل -->
  <div class="loadingOverlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>


  <div class="container">


    <div class="mainContent">
      <div class="errorMsg" id="errorMsg"></div>
      <div class="successMsg" id="successMsg"></div>

      <div class="topSection">
        <div class="timezoneField">
          <label for="timeZone" data-lng="time_zone">Time Zone: </label>
          <input list="timezones" id="timeZone" data-lng-placeholder="time_zone_place"/>
          <datalist id="timezones"></datalist>
        </div>
        <button class="saveBtn" data-lng="save" onclick="saveProfile()"></button>
      </div>

      <div class="sec2">
        <p data-lng="templates"></p>
        <button class="addBtn" onclick="openModalForAddTemplate()" data-lng="add_template"> </button>
      </div>

      <table id="templatesTable">
        <thead>
          <tr>
            <th>#</th>
            <th data-lng="table_header_name"></th>
            <th data-lng="table_header_actions"></th>
            <th data-lng="table_header_apply"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      

    </div>


    <!-- modals --> 
    <!-- مودال النموذج -->
    <div class="modalOverlay" id="templateModal">
      <div class="modalContent scheduleWidth">
        <div class="modalHeader">
          <h2 id="templateModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeTemplateModal()">×</button>
        </div>

        <div class="modalBody">

          <div class="nameDiv" style="display: flex;align-items: center;justify-content: flex-start;gap: 6px;margin-bottom: 22px;">
            <label for="templateNameInput" data-lng="template_name" style="margin: 0;font-weight: 500;"></label>
            <input type="text" id="templateNameInput" data-lng-placeholder="template_name_place" style="width: fit-content;padding: 6px;border: 1px solid #ccc;border-radius: 4px;font-size: 0.9rem;margin: 0;">
          </div>

          <table class="scheduleTable" id="scheduleTable">
            <thead>
              <tr>
                <th data-lng="schDay"></th>
                <th data-lng="schStart"></th>
                <th data-lng="schEnd"></th>
                <th data-lng="schOTStart"></th>
                <th data-lng="schOffset"></th>
                <th data-lng="schHourPrice"></th>
                <th data-lng="schOTPrice"></th>
                <th data-lng="schEdit"></th>
                <th data-lng="schDelete"></th>
                <th data-lng="schCopy"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div style="display: flex;justify-content: space-between;align-items: center;">
            <div style="margin-top:10px;">
              <button class="modalSaveBtn" data-lng="btnAddDay" onclick="addScheduleDay()"></button>
              <button class="modalSaveBtn restBtn" data-lng="btnAddRest" onclick="addScheduleDay(true)"></button>
            </div>
            <button class="saveScheduleBtn" id="saveScheduleBtn" data-lng="save" onclick="saveTemplate()"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- مودال تعديل/إضافة يوم في الجدول -->
    <div class="modalOverlay" id="dayModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="dayModalTitle" data-lng="lblDayModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeDayModal()">×</button>
        </div>
        <div class="modalBody">

          <label data-lng="lblDaySelect" for="daySelect"></label>
          <select id="daySelect">
            <option value="Sun">Sun</option>
            <option value="Mon">Mon</option>
            <option value="Tue">Tue</option>
            <option value="Wed">Wed</option>
            <option value="Thu">Thu</option>
            <option value="Fri">Fri</option>
            <option value="Sat">Sat</option>
          </select>

          <label data-lng="lblDayStart" for="dayStart"></label>
          <input type="time" id="dayStart" />

          <label data-lng="lblDayEnd" for="dayEnd"></label>
          <input type="time" id="dayEnd" />

          <label data-lng="lblDayOTStart" for="dayOTStart"></label>
          <input type="time" id="dayOTStart" />

          <label data-lng="lblDayOffset" for="dayOffset"></label>
          <input type="number" id="dayOffset" />

          <label data-lng="lblDayHourPrice" for="dayHourPrice"></label>
          <input type="number" id="dayHourPrice" />

          <label data-lng="lblDayOTPrice" for="dayOTPrice"></label>
          <input type="number" id="dayOTPrice" />

          <label data-lng="lblDayAllowedDelay" for="dayAllowedDelay"></label>
          <input type="number" id="dayAllowedDelay" />

          <label data-lng="lblDayAllowedExit" for="dayAllowedExit"></label>
          <input type="number" id="dayAllowedExit" />

          <label data-lng="lblDayOfficialHours" for="dayOfficialHours"></label>
          <input type="number" id="dayOfficialHours" />

          <label data-lng="lblDayLateCutCount" for="dayLateCutCount"></label>
          <input type="number" id="dayLateCutCount" />

          <label data-lng="lblDayAbsentCut" for="dayAbsentCut"></label>
          <input type="number" id="dayAbsentCut" />

          <label data-lng="lblDayDailySalary" for="dayDailySalary"></label>
          <input type="number" id="dayDailySalary" />

          <label data-lng="lblDayEarlyCutCount" for="dayEarlyCutCount"></label>
          <input type="number" id="dayEarlyCutCount" />

          <label data-lng="lblDayLateMinPrice" for="dayLateMinPrice"></label>
          <input type="number" id="dayLateMinPrice" />

          <label data-lng="lblDayEarlyMinPrice" for="dayEarlyMinPrice"></label>
          <input type="number" id="dayEarlyMinPrice" />

          <label data-lng="lblDayMinOTHours" for="dayMinOTHours"></label>
          <input type="number" id="dayMinOTHours" />

          <label data-lng="lblDayWrStart" for="dayWrStart"></label>
          <input type="time" id="dayWrStart" />

          <label data-lng="lblDayLastEntry" for="dayLastEntry"></label>
          <input type="time" id="dayLastEntry" />

          <label data-lng="lblDayFirstExit" for="dayFirstExit"></label>
          <input type="time" id="dayFirstExit" />

          <label data-lng="lblDayLastExit" for="dayLastExit"></label>
          <input type="time" id="dayLastExit" />

          <label data-lng="lblDayDailyWage" for="dayDailyWage"></label>
          <select id="dayDailyWage">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>

          <label data-lng="lblDayOTEligible" for="dayOTEligible"></label>
          <select id="dayOTEligible">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>

          <label data-lng="lblDayAllowedMinRest" for="dayAllowedMinRest"></label>
          <input type="number" id="dayAllowedMinRest" />

          <label data-lng="lblDayRestMinPrice" for="dayRestMinPrice"></label>
          <input type="number" id="dayRestMinPrice" />

          <button class="modalSaveBtn" data-lng="btnSaveDay" onclick="saveDay()"></button>
        </div>
      </div>
    </div>




    <!-- الشريط الجانبي -->
    <div class="sidebar">
      <h2 data-lng="sidebar_title">القائمة</h2>
      <div class="navItem" onclick="location.href='dashboard.html'">
        <i class="bi bi-house-fill"></i>
        <span data-lng="sidebar_overview">نظرة عامة</span>
      </div>
      <div class="navItem" onclick="location.href='employee.html'">
        <i class="bi bi-people-fill"></i>
        <span data-lng="sidebar_employees">الموظفين</span>
      </div>
      <div class="navItem" onclick="location.href='report.html'">
        <i class="bi bi-bar-chart-line-fill"></i>
        <span data-lng="sidebar_report">تقرير الحضور</span>
      </div>
      <div class="navItem" onclick="location.href='time-based-leaves.html'">
        <i class="bi bi-clock-fill"></i>
        <span data-lng="sidebar_time_leaves">إجازات زمنية</span>
      </div>
      <div class="navItem" onclick="location.href='holidays.html'">
        <i class="bi bi-calendar-event-fill"></i>
        <span data-lng="sidebar_holidays">العطل الرسمية</span>
      </div>
      <div class="navItem" onclick="location.href='leaves.html'">
        <i class="bi bi-calendar3"></i>
        <span data-lng="sidebar_leaves">أجازات</span>
      </div>
      <div class="navItem" onclick="location.href='attend.html'">
        <i class="bi bi-journal-check"></i>
        <span data-lng="sidebar_attend">سجل الحضور</span>
      </div>
      <div class="navItem" onclick="location.href='rewards.html'">
        <i class="bi bi-gift-fill"></i>
        <span data-lng="sidebar_rewards">مكافآت وعقوبات</span>
      </div>
      <div class="navItem" onclick="location.href='devices.html'">
        <i class="bi bi-device-hdd-fill"></i>
        <span data-lng="sidebar_devices">الأجهزة</span>
      </div>
      <div class="navItem" onclick="location.href='requests.html'">
        <i class="bi bi-list-check"></i>
        <span data-lng="sidebar_requests">الأوامر</span>
      </div>
      <div class="navItem" onclick="location.href='department.html'">
        <i class="bi bi-building"></i>
        <span data-lng="sidebar_departments">الأقسام</span>
      </div>
      <!-- <div class="navItem" onclick="location.href='settings.html'">
        <i class="bi bi-gear-fill"></i>
        <span data-lng="sidebar_settings">الإعدادات</span>
      </div> -->
      <div class="navItem" onclick="location.href='importemployee.html'">
        <i class="bi bi-person-exclamation"></i>
        <span data-lng="attend_sidebar_unregistered"></span>
      </div>
      <div class="navItem" onclick="location.href='employee-summary-report.html'">
        <i class="bi bi-people-fill"></i>
        <span data-lng="employee_summary_report"></span>
      </div>
      <div class="navItem" onclick="location.href='leaves-type.html'">
        <i class="bi bi-briefcase-fill"></i>
        <span data-lng="leaves_type">أنواع الإجازات</span>
      </div>
      <div class="navItem active" onclick="location.href='public-settings.html'">
        <i class="bi bi-gear"></i>
        <span data-lng="public_settings"></span>
      </div>
    </div>

  </div>
  <script>
    /////////////////////////////////////////////////
    /////////////////// start language and auth /////
    /////////////////////////////////////////////////
    let authToken = null;
    let translations = {};
    function getTranslate(str) { return translations[str] }
    const LANG_PATH = './lang';
    const LNG_KEY = 'lng';

    function initPage() {

      authToken = localStorage.getItem('authToken');
      if (!authToken) return window.location.href = 'login.html';

      let storedLang = localStorage.getItem(LNG_KEY);
      if (!storedLang) {
        storedLang = 'en';
        localStorage.setItem(LNG_KEY, storedLang);
      }
      document.getElementById('langSelector').value = storedLang;
      setLanguage(storedLang).then(() => {
        loadTemplates()
        getProfile()
      });
    }

    async function setLanguage(lang) {
      localStorage.setItem(LNG_KEY, lang);
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar'? 'rtl':'ltr'
      await loadLanguageFile(lang);
      applyTranslations(lang);
    }

    function applyTranslations(lang) {

      document.title = getTranslate('head_title')

      document.querySelectorAll('[data-lng]').forEach(el => {
        const key = el.getAttribute('data-lng');
        if(translations[key]) el.textContent = translations[key];
      });

      document.querySelectorAll('[data-lng-placeholder]').forEach(el => {
        const key = el.getAttribute('data-lng-placeholder');
        if(translations[key]) el.placeholder = translations[key];
      });

      document.querySelectorAll('[data-lng-hover-title]').forEach(el => {
        const key = el.getAttribute('data-lng-hover-title');
        if (translations[key]) el.setAttribute('title',translations[key])
      });

    }

    async function loadLanguageFile(lang) {
      try {
        const response = await fetch(`${LANG_PATH}/${lang}_public_settings.json`);
        if(!response.ok) throw new Error(`Error loading ${lang}_public_settings.json`);
        translations = await response.json();
      } catch (error) {
        console.error("Leaves translation file error:", error);
      }
    }

    function logout() {
      localStorage.removeItem('authToken');
      window.location.href = 'login.html';
    }

    document.getElementById('langSelector').addEventListener('change', (event) => {
      setLanguage(event.target.value);
      clearMessages()
    });
    /////////////////////////////////////////////////
    /////////////////// end language and auth /////
    /////////////////////////////////////////////////

    async function getProfile() {
      const resp = await fetch('https://timeattendhr.com/api/users/profile', {
        headers: { 'Authorization': 'Bearer ' + authToken }
      });
      const data = await resp.json();
      renderTimeZones(data.timeZone)
    }

    function renderTimeZones(currentVal) {

      currentTimeZone = currentVal || Intl.DateTimeFormat().resolvedOptions().timeZone
      const input = document.getElementById('timeZone');
      input.value = currentTimeZone

      const timeZones = Intl.supportedValuesOf("timeZone")
      const list = document.getElementById('timezones');
      timeZones.forEach(zone => {
        const opt = document.createElement('option');
        opt.value = zone;
        list.appendChild(opt);
      });

    }      

    async function saveProfile() {

      const timeZone = document.getElementById('timeZone').value.trim();
      if(!timeZone) return

      const body = { timeZone }

      try {

        showLoading()

        const resp = await fetch('https://timeattendhr.com/api/users/profile', {
          headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
          },
          method: 'PUT',
          body: JSON.stringify(body)
        });
        if (!resp.ok) throw new Error(getTranslate('err_saving_timeZone'));

        showSuccess(getTranslate('success_msg'))

      } catch (err) {
        showError(err.message);
      } finally {
        hideLoading();
      }

    }


    let templates = []

    async function loadTemplates() {
      try {
        const resp = await fetch('https://timeattendhr.com/api/weekSchedule-templates', {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) throw new Error(getTranslate('templates_msg_error_fetch'));
        const data = await resp.json();
        templates = data;
        renderTemplates(templates);
      } catch (err) {
        showError(err.message);
      } finally {
        hideLoading();
      }
    }

    function renderTemplates(templates) {
      const tb = document.querySelector('#templatesTable tbody');
      tb.innerHTML = '';

      templates.forEach((template, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${template.name || ''}</td>
          <td>
            <i class="bi bi-pencil-fill actionIcon" onclick="openModalForEditTemplate('${template._id}')" data-lng-hover-title='edit' title="${getTranslate('edit')}"></i>
            <i class="bi bi-trash-fill actionIcon" onclick="deleteTemplate('${template._id}')" data-lng-hover-title='delete' title="${getTranslate('delete')}"></i>
          </td>
          <td><button class="addBtn applyBtn" onclick="applyTemplate('${template._id}')" data-lng="table_header_apply">${getTranslate('table_header_apply')}</button></td>
        `;
        tb.appendChild(tr);
      });
    }




    let currentTemplate = null;
    let addOrEdit = 'add'
    let dayIndex = null;


    function openModalForAddTemplate() {
      currentTemplate = { name: '', weekSchedules: [] }
      addOrEdit = 'add'
      document.getElementById('templateModalTitle').innerText = getTranslate('add_template')
      document.getElementById('templateNameInput').value = ''
      renderSchedule([]);
      showTemplateModal();
    }

    function openModalForEditTemplate(template_id) {
      currentTemplate = templates.filter(el => el._id == template_id)[0]
      addOrEdit = 'edit'
      document.getElementById('templateModalTitle').innerText = getTranslate('edit_template')
      document.getElementById('templateNameInput').value = currentTemplate.name
      renderSchedule(currentTemplate.weekSchedules);
      showTemplateModal();
    }

    function renderSchedule(sch) {
      const tb = document.getElementById('scheduleTable').querySelector('tbody');
      tb.innerHTML = '';
      sch.forEach((dayObj, i) => {
        let row = document.createElement('tr');
        row.innerHTML = `
          <td>${dayObj.day || ''}</td>
          <td>${dayObj.startTime || ''}</td>
          <td>${dayObj.endTime || ''}</td>
          <td>${dayObj.overtimeStart || ''}</td>
          <td>${dayObj.endDayOffset || 0}</td>
          <td>${dayObj.hourPrice || 0}</td>
          <td>${dayObj.overtimePrice || 0}</td>
          <td><button class="btnSmall" style="background:#007bff;color:#fff;" onclick="openDayModal(${i})">${getTranslate('edit')}</button></td>
          <td><button class="btnSmall" style="background:#dc3545;color:#fff;" onclick="deleteDay(${i})">${getTranslate('delete')}</button></td>
          <td><button class="btnSmall" style="background:#17a2b8;color:#fff;" onclick="copyDay(${i})">${getTranslate('copy')}</button></td>
        `;
        tb.appendChild(row);
      });
    }

    function addScheduleDay(isRest = false) {

      if(!isRest && currentTemplate.weekSchedules.length) return copyDay(currentTemplate.weekSchedules.length - 1)

      const dayOrder = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      if (currentTemplate.weekSchedules.length == 0) {
        currentTemplate.weekSchedules.push({
          day: 'Sun',
          startTime: isRest ? '00:00:00' : '09:00:00',
          endTime: isRest ? '00:00:00' : '17:00:00',
          overtimeStart: isRest ? '00:00:00' : '17:30:00',
          endDayOffset: 0,
          hourPrice: 0,
          overtimePrice: 0,
          allowed_delay_minutes: 0,
          allowed_exit_minutes: 0,
          official_working_hours: 8,
          late_cutting_by_count: 0,
          absent_cutting: 0,
          daily_salary: 0,
          early_cutting_by_count: 0,
          late_min_prices: 0,
          early_min_prices: 0,
          minimum_working_hours_overtime: 10,
          work_registration_start_time: '00:00:00',
          last_entry_prevention_time: '23:59:00',
          first_exit_allowed_time: '00:00:00',
          last_exit_allowed_time: '23:59:00',
          works_for_daily_wage: false,
          overtime_eligible: false,
          allowed_min_rest: 0,
          rest_min_prices: 0
        });
      } else {
        const lastDayObj = currentTemplate.weekSchedules[currentTemplate.weekSchedules.length - 1];
        const dayOrderIndex = dayOrder.indexOf(lastDayObj.day);
        if(dayOrderIndex < 0) return alert(getTranslate('unknown_day'));
        if(dayOrderIndex == 6) return alert(getTranslate("last_day"));
        let newDayObj = { ...lastDayObj };
        newDayObj.day = dayOrder[dayOrderIndex + 1];

        newDayObj.startTime = isRest? '00:00:00' : '09:00:00'
        newDayObj.endTime = isRest? '00:00:00' : '17:00:00'
        newDayObj.overtimeStart = isRest? '00:00:00' : '17:30:00'
        
        currentTemplate.weekSchedules.push(newDayObj);
      }
      renderSchedule(currentTemplate.weekSchedules);
    }

    function deleteDay(i) {
      if (!confirm(getTranslate("delete_day"))) return;
      currentTemplate.weekSchedules.splice(i, 1);
      renderSchedule(currentTemplate.weekSchedules);
    }

    function openDayModal(i) {
      dayIndex = i;
      const dayObj = currentTemplate.weekSchedules[i];
      document.getElementById('dayModalTitle').setAttribute('data-lng', 'lblDayModalTitle');
      document.getElementById('daySelect').value = dayObj.day || 'Sun';
      document.getElementById('dayStart').value = dayObj.startTime || '09:00:00';
      document.getElementById('dayEnd').value = dayObj.endTime || '17:00:00';
      document.getElementById('dayOTStart').value = dayObj.overtimeStart || '17:30:00';
      document.getElementById('dayOffset').value = dayObj.endDayOffset || 0;
      document.getElementById('dayHourPrice').value = dayObj.hourPrice || 0;
      document.getElementById('dayOTPrice').value = dayObj.overtimePrice || 0;
      document.getElementById('dayAllowedDelay').value = dayObj.allowed_delay_minutes || 0;
      document.getElementById('dayAllowedExit').value = dayObj.allowed_exit_minutes || 0;
      document.getElementById('dayOfficialHours').value = dayObj.official_working_hours || 8;
      document.getElementById('dayLateCutCount').value = dayObj.late_cutting_by_count || 0;
      document.getElementById('dayAbsentCut').value = dayObj.absent_cutting || 0;
      document.getElementById('dayDailySalary').value = dayObj.daily_salary || 0;
      document.getElementById('dayEarlyCutCount').value = dayObj.early_cutting_by_count || 0;
      document.getElementById('dayLateMinPrice').value = dayObj.late_min_prices || 0;
      document.getElementById('dayEarlyMinPrice').value = dayObj.early_min_prices || 0;
      document.getElementById('dayMinOTHours').value = dayObj.minimum_working_hours_overtime || 10;
      document.getElementById('dayWrStart').value = dayObj.work_registration_start_time || '00:00:00';
      document.getElementById('dayLastEntry').value = dayObj.last_entry_prevention_time || '23:59:00';
      document.getElementById('dayFirstExit').value = dayObj.first_exit_allowed_time || '00:00:00';
      document.getElementById('dayLastExit').value = dayObj.last_exit_allowed_time || '23:59:00';
      document.getElementById('dayDailyWage').value = dayObj.works_for_daily_wage ? 'true' : 'false';
      document.getElementById('dayOTEligible').value = dayObj.overtime_eligible ? 'true' : 'false';
      document.getElementById('dayAllowedMinRest').value = dayObj.allowed_min_rest || 0;
      document.getElementById('dayRestMinPrice').value = dayObj.rest_min_prices || 0;
      showDayModal();
    }
    function saveDay() {
      const dayObj = currentTemplate.weekSchedules[dayIndex];
      dayObj.day = document.getElementById('daySelect').value;
      dayObj.startTime = document.getElementById('dayStart').value;
      dayObj.endTime = document.getElementById('dayEnd').value;
      dayObj.overtimeStart = document.getElementById('dayOTStart').value;
      dayObj.endDayOffset = +document.getElementById('dayOffset').value;
      dayObj.hourPrice = +document.getElementById('dayHourPrice').value;
      dayObj.overtimePrice = +document.getElementById('dayOTPrice').value;
      dayObj.allowed_delay_minutes = +document.getElementById('dayAllowedDelay').value;
      dayObj.allowed_exit_minutes = +document.getElementById('dayAllowedExit').value;
      dayObj.official_working_hours = +document.getElementById('dayOfficialHours').value;
      dayObj.late_cutting_by_count = +document.getElementById('dayLateCutCount').value;
      dayObj.absent_cutting = +document.getElementById('dayAbsentCut').value;
      dayObj.daily_salary = +document.getElementById('dayDailySalary').value;
      dayObj.early_cutting_by_count = +document.getElementById('dayEarlyCutCount').value;
      dayObj.late_min_prices = +document.getElementById('dayLateMinPrice').value;
      dayObj.early_min_prices = +document.getElementById('dayEarlyMinPrice').value;
      dayObj.minimum_working_hours_overtime = +document.getElementById('dayMinOTHours').value;
      dayObj.work_registration_start_time = document.getElementById('dayWrStart').value;
      dayObj.last_entry_prevention_time = document.getElementById('dayLastEntry').value;
      dayObj.first_exit_allowed_time = document.getElementById('dayFirstExit').value;
      dayObj.last_exit_allowed_time = document.getElementById('dayLastExit').value;
      dayObj.works_for_daily_wage = (document.getElementById('dayDailyWage').value === 'true');
      dayObj.overtime_eligible = (document.getElementById('dayOTEligible').value === 'true');
      dayObj.allowed_min_rest = +document.getElementById('dayAllowedMinRest').value;
      dayObj.rest_min_prices = +document.getElementById('dayRestMinPrice').value;
      renderSchedule(currentTemplate.weekSchedules);
      closeDayModal();
    }

    function copyDay(i) {
      const dayOrder = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      let currentDayObj = currentTemplate.weekSchedules[i];
      let currentDayIndex = dayOrder.indexOf(currentDayObj.day);
      if(currentDayIndex < 0) return alert(getTranslate(can_not_copy));
      if(currentDayIndex === 6) return alert(getTranslate('can_not_copy_sat'));
      let newDayObj = { ...currentTemplate.weekSchedules[i] };
      newDayObj.day = dayOrder[currentDayIndex + 1];
      currentTemplate.weekSchedules.splice(i + 1, 0, newDayObj);
      renderSchedule(currentTemplate.weekSchedules);
    }




    async function saveTemplate() {

      const body = {
        name: document.getElementById('templateNameInput').value,
        weekSchedules: currentTemplate.weekSchedules
      }
      if(!body.name?.trim()) return

      showLoading()

      try {

        let endPoint = `https://timeattendhr.com/api/weekSchedule-templates`
        let method = 'POST'
        if(addOrEdit == 'edit') {
          endPoint += `/${currentTemplate._id}`
          method = 'PUT'
        }

        const resp = await fetch(endPoint, {
          method,
          headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (!resp.ok) throw new Error(getTranslate('failed_to_save_template'));
        showSuccess(getTranslate("success_msg"))
        closeTemplateModal()
        await loadTemplates()

      } catch (err) {
        showError(err.message)
      } finally {
        hideLoading()
      }

    }


    async function deleteTemplate(id) {

      if (!confirm(translations['delete_template'])) return;

      showLoading()

      try {
        
        const resp = await fetch(`https://timeattendhr.com/api/weekSchedule-templates/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (!resp.ok) throw new Error(translations['err_delete_template']);

        showSuccess(getTranslate("success_msg"))
        await loadTemplates()

      } catch (err) {
        showError(err.message)
      } finally {
        hideLoading()
      }

    }

    async function applyTemplate(id) {

      if (!confirm(translations['aplly_template'])) return;

      showLoading()

      try {
        
        const resp = await fetch(`https://timeattendhr.com/api/weekSchedule-templates/${id}/apply`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (!resp.ok) throw new Error(translations['err_apply_template']);

        showSuccess(getTranslate("success_msg"))

      } catch (err) {
        showError(err.message)
      } finally {
        hideLoading()
      }

    }




    function showTemplateModal() { document.getElementById('templateModal').style.display = 'flex'; }
    function closeTemplateModal() { document.getElementById('templateModal').style.display = 'none'; }

    function showDayModal() { document.getElementById('dayModal').style.display = 'flex'; }
    function closeDayModal() { document.getElementById('dayModal').style.display = 'none'; }


    /////////////////////////////////////////////////
    /////////////////// helpers /////////////////////
    /////////////////////////////////////////////////
    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    function showError(msg) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = msg;
      errorMsg.style.display = 'block';
      document.getElementById('successMsg').style.display = 'none';
    }

    function showSuccess(msg) {
      const successMsg = document.getElementById('successMsg');
      successMsg.textContent = msg;
      successMsg.style.display = 'block';
      document.getElementById('errorMsg').style.display = 'none';
    }

    function clearMessages() {
      document.getElementById('errorMsg').style.display = 'none';
      document.getElementById('successMsg').style.display = 'none';
    }

  </script>

</body>

</html>