<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title></title>
  <style>
    html {
      animation: fadeIn .3s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* زر اختيار اللغة */
    #langSelector {
      margin: 10px;
      padding: 6px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* إذا كانت الصفحة lang="ar" => اتجاه RTL وخط تاجوال */
    html[lang="ar"] body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }

    /* إذا كانت الصفحة lang="en" => اتجاه LTR وخط أوبن سانس */
    html[lang="en"] body {
      font-family: 'Open Sans', sans-serif;
      direction: ltr;
    }

    body {
      font-family: sans-serif;
      margin: 20px;
      padding: 0;
      background: #f2f2f2;
    }

    .form {
      >div {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }
    }

    label,
    button {
      display: block;
      margin: 0;
    }

    input {
      padding: 5px;
      width: 250px;
    }
  </style>
</head>

<body onload="initPage()">

  <div class="top" style="display: flex;align-items: center;justify-content: space-between;">

    <h1 data-lng="top"></h1>

    <!-- اختيار اللغة (مثل صفحة اللوجن) -->
    <select id="langSelector">
      <option value="en">English</option>
      <option value="ar">العربية</option>
    </select>

  </div>

  <!-- نموذج الإدخال -->
  <div class="form">
    <div>
      <label data-lng="username"></label>
      <input type="text" id="username" data-lng-placeholder="username" />
    </div>
    <div>
      <label data-lng="password"></label>
      <input type="password" id="password" data-lng-placeholder="password" />
    </div>
    <div>
      <label data-lng="from"></label>
      <input type="date" id="startDate" />
    </div>
    <div>
      <label data-lng="to"></label>
      <input type="date" id="endDate" />
    </div>
    <button data-lng="getData" id="fetchBtn"></button>
  </div>

  <div id="result"></div>

  <script>
    /***************************************************
 * 1) آلية اللغة الموحدة (كما في صفحة اللوجن)
 ***************************************************/
    const LANG_PATH = './lang';        // مجلد ملفات JSON
    const LANG_KEY = 'attendance_lang';
    let translations = {};

    async function loadLanguageFile(lang) {
      try {
        const response = await fetch(`${LANG_PATH}/${lang}_settings.json`);
        if (!response.ok) {
          throw new Error(`Error loading ${lang}.json`);
        }
        translations = await response.json();
      } catch (error) {
        console.error("Error loading translation file:", error);
      }
    }

    function applyTranslations(lang) {
      // تغيير اتجاه الصفحة ولغتها
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';

      document.title = translations.title;


      // طبيق النصوص على العناصر data-lng="..."
      document.querySelectorAll('[data-lng]').forEach(el => {
        const key = el.getAttribute('data-lng');
        if (translations[key]) {
          el.textContent = translations[key];
        }
      });

      // تطبيق placeholder
      document.querySelectorAll('[data-lng-placeholder]').forEach(el => {
        const key = el.getAttribute('data-lng-placeholder');
        if (translations[key]) {
          el.placeholder = translations[key];
        }
      });

      // تطبيق نص للأوبشن
      document.querySelectorAll('[data-lng-option]').forEach(el => {
        const key = el.getAttribute('data-lng-option');
        if (translations[key]) {
          el.textContent = translations[key];
        }
      });
    }

    async function setLanguage(lang) {
      await loadLanguageFile(lang);
      localStorage.setItem('lng', lang);
      applyTranslations(lang);
    }

    // تغيير اللغة من الـselect
    document.getElementById('langSelector').addEventListener('change', function () {
      setLanguage(this.value);
      document.getElementById('result').innerText = ''
    });

    function initPage() {
      // (أ) إعداد اللغة أولاً
      let storedLang = localStorage.getItem('lng');
      if (!storedLang) {
        storedLang = 'en'; // افتراضي إنجليزي
      }
      document.getElementById('langSelector').value = storedLang;
      setLanguage(storedLang)
    }


    // نقاط النهاية (EndPoints)
    const apiGetEndpoint = 'https://mawjood.iraqsapp.com/original-fingerprints';
    const apiPostEndpoint = 'https://timeattendhr.com/api/fingerprints';

    // التوكن المطلوب للـAPI الثاني
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NzhjOTg1MjRhMDJmYTMwNjgyZjRjYjkiLCJ1c2VyTmFtZSI6Im1vIiwiaWF0IjoxNzM3NjczNDc0LCJleHAiOjE3Mzc3MDIyNzR9.QKYdRziTUtKPUBow-saIby6YiAfMD_ym6r_Lo31JZNo'; // ضع التوكن الصحيح هنا

    // مصفوفة للاحتفاظ بالمدخلات (enrollId + time) المرسلة لتجنب التكرار في نفس الجلسة
    const sentFingerprints = new Set();

    document.getElementById('fetchBtn').addEventListener('click', async () => {
      // الحصول على قيم الحقول
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const startDateValue = document.getElementById('startDate').value;
      const endDateValue = document.getElementById('endDate').value;
      const resultDiv = document.getElementById('result');

      // التحقق من وجود تواريخ
      if (!startDateValue || !endDateValue) {
        alert(translations['define_date']);
        return;
      }

      // تحويل التاريخين إلى رقم (تايم ستامب بالميلي ثانية)
      const startTimestamp = new Date(startDateValue).getTime();
      const endTimestamp = new Date(endDateValue).getTime();

      // يمكن تعديل limit كما تحب
      const limit = 20;
      let skip = 0;
      let totalFetched = 0;
      let totalSent = 0;

      // مسح محتوى النتيجة
      resultDiv.innerText = translations['getting_data'];

      try {
        while (true) {
          // بناء الرابط مع إضافة skip و limit في كل مرة
          const url = `${apiGetEndpoint}?company=5f1312ad8a3ede0994f574bc&startDate=${startTimestamp}&endDate=${endTimestamp}&skip=${skip}`;

          // جلب بيانات الصفحة الحالية
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error('خطأ في جلب البيانات من السيرفر الأول');
          }

          const fingerprints = await response.json();

          // إذا كانت المصفوفة فارغة، يعني انتهينا
          if (!fingerprints.length) {
            console.log('انتهى الجلب: لم تعد هناك سجلات جديدة.');
            break;
          }

          // تحديث العدد الإجمالي للجلب
          totalFetched += fingerprints.length;

          // إرسال كل بصمة للـAPI الثاني
          for (const fp of fingerprints) {
            const enrollId = fp.enrollId;
            const time = fp.time; // تاريخ البصمة

            // تكوين مفتاح فريد للتحقق من عدم التكرار
            const uniqueKey = enrollId + '_' + time;
            if (sentFingerprints.has(uniqueKey)) {
              // تم إرساله من قبل في نفس الجلسة
              console.log('تخطي بصمة مكررة:', uniqueKey);
              continue;
            }

            // بيانات الـBody للـAPI الثاني
            const dataToSend = {
              enrollid: enrollId,
              name: 'mawjoodapp',  // ضع الاسم المناسب
              time: time,          // تأكد أنه بالتنسيق الذي يقبله الـAPI
              event: 1             // يمكنك تعديله حسب احتياجاتك
            };

            // إرسال البصمة للـAPI الثاني
            try {
              const postRes = await fetch(apiPostEndpoint, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
              });

              if (postRes.ok) {
                sentFingerprints.add(uniqueKey);
                totalSent++;
                console.log(`تم إرسال البصمة بنجاح: enrollId=${enrollId}, time=${time}`);
              } else {
                console.error('فشل في إرسال البصمة:', enrollId, await postRes.text());
              }
            } catch (err) {
              console.error('حدث خطأ أثناء إرسال البصمة:', err);
            }
          }

          // زيادة قيمة skip للانتقال إلى الصفحة التالية
          skip += limit;
        }

        // انتهت عملية التصفح (Pagination)
        const msg = document.getElementById('langSelector').value == 'ar'?
        `انتهى الجلب والإرسال. تم جلب ${totalFetched} بصمة وإرسال ${totalSent} بنجاح.`:
        `get ${totalFetched} and sent ${totalSent} fingerprint successfully`;
        resultDiv.innerText = msg
      } catch (error) {
        console.error(error);
        resultDiv.innerText = translations['error_happened'];
      }
    });
  </script>
</body>

</html>