<!DOCTYPE html>
<html>
<!-- نجعل الافتراضي الإنجليزية -->

<head>
  <meta charset="UTF-8">
  <title data-lng="pageTitle"></title>

  <!-- 1) مكتبة jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- 2) مكتبة Select2 (CSS ثم JS) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- 3) أيقونات Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- 4) خطوط (تاجوال للعربية، وأوبن سانس للإنجليزية) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">

  <!-- 5) مكتبة XLSX لتصدير/استيراد إكسل -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    html {
      animation: fadeIn .3s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* إذا كانت الصفحة lang="ar" => اتجاه RTL وخط تاجوال */

    html[lang="ar"] body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }

    /* إذا كانت الصفحة lang="en" => اتجاه LTR وخط أوبن سانس */

    html[lang="en"] body {
      font-family: 'Open Sans', sans-serif;
      direction: ltr;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }

    header {
      background: linear-gradient(45deg, #0062cc, #004085);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    header button {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    header button:hover {
      background: #c82333;
    }

    #langSelector {
      margin: 10px;
      padding: 6px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .container {
      display: flex;
      flex-direction: row-reverse;
    }

    .mainContent {
      flex: 1;
      padding: 20px;
    }

    .sidebar {
      width: 240px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      padding: 20px 10px;
    }

    .sidebar h2 {
      margin-bottom: 15px;
      font-size: 1rem;
      text-align: center;
      color: #444;
    }

    .navItem {
      padding: 12px 10px;
      margin: 6px 0;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      font-weight: 500;
      transition: background 0.3s, color 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navItem i {
      font-size: 1.1rem;
      color: #666;
      transition: color 0.3s;
    }

    .navItem:hover {
      background: #f0f0f0;
    }

    .navItem.active {
      background: #007bff;
      color: #fff;
    }

    .navItem.active i {
      color: #fff;
    }

    .errorMsg,
    .successMsg {
      margin: 10px 0;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .errorMsg {
      color: red;
    }

    .successMsg {
      color: green;
    }

    .searchFilters {
      background: #fff;
      padding: 10px;
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .searchFilters label {
      margin-right: 4px;
      font-weight: 500;
    }

    .searchFilters select,
    .searchFilters input[type="text"] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    table thead {
      background: #007bff;
      color: #fff;
    }

    table th,
    table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    .btns {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .addEmployeeBtn,
    .selectedBtn,
    .allSelectedBtn {
      background: #28a745;
      color: #fff;
      padding: 8px 14px;
      border-radius: 4px;
      margin-bottom: 15px;
      transition: background 0.3s;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
    }

    html[lang="ar"] .addEmployeeBtn,
    html[lang="ar"] .selectedBtn,
    html[lang="ar"] .allSelectedBtn,
    html[lang="ar"] select,
    html[lang="ar"] .modalSaveBtn,
    html[lang="ar"] input {
      font-family: "Tajawal";
    }

    .addEmployeeBtn:hover {
      background: #218838;
    }

    .selectedBtn {
      background: #17a2b8;
      display: none;
    }

    .selectedBtn:hover {
      background: #167c8b;
    }

    .allSelectedBtn {
      background: #007bff;
    }

    .allSelectedBtn:hover {
      background: #0851a0;
    }

    input[type="checkbox"] {
      margin: 0;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    img.employeeImage {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
    }

    .iconBtn {
      background: none;
      border: none;
      cursor: pointer;
      margin: 0 3px;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.3s;
    }

    .iconBtn:hover {
      background: #f0f0f0;
    }

    .iconBtn i {
      font-size: 1.1rem;
      color: #007bff;
    }

    .iconBtn.edit i {
      color: #007bff;
    }

    .iconBtn.delete i {
      color: #dc3545;
    }

    .iconBtn.schedule i {
      color: #17a2b8;
    }

    .iconBtn.devices i {
      color: #6f42c1;
    }

    .iconBtn.send i {
      color: #28a745;
    }

    .iconBtn.sendFingerprint i {
      color: #4628a7;
    }

    .iconBtn.face i {
      color: #fd7e14;
    }

    .iconBtn.finger i {
      color: #8a2be2;
    }

    .iconBtn.card i {
      color: #343a40;
    }

    .modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modalContent {
      width: 900px;
      max-width: 100%;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: fadeInModal 0.3s ease;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid #eee;
    }

    #fingerModal  .modalContent {
      width: 400px;
    }
    @keyframes fadeInModal {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modalHeader {
      background: #007bff;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modalHeader h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .modalCloseBtn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.3s;
    }

    .modalCloseBtn:hover {
      color: #ffdddd;
    }

    .modalBody {
      padding: 20px;
    }

    .modalSaveBtn,
    .saveScheduleBtn {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px 14px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .modalSaveBtn:hover {
      background: #218838;
    }

    .saveScheduleBtn {
      background: #007bff;
    }

    .saveScheduleBtn:hover {
      background: #0756aa;
    }

    .modalContent.scheduleWidth {
      width: 650px;
      max-height: 90vh;
    }

    .restBtn {
      background: #17a2b8;
    }

    .restBtn:hover {
      background: #12889b;
    }

    .scheduleTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .scheduleTable thead {
      background: #17a2b8;
      color: #fff;
    }

    .scheduleTable th,
    .scheduleTable td {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
      font-size: 0.85rem;
    }

    .btnSmall {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
      border: none;
    }

    /* تنسيق للقوائم الفرعية لتظهر كفرع */

    .submenu {
      border-left: 2px solid #dee2e6;
      margin-left: 15px;
      padding-left: 10px;
      margin-bottom: 5px;
    }

    html[lang="ar"] .submenu {
      border-right: 2px solid #dee2e6;
      border-left: none;
      margin-right: 15px;
      padding-right: 10px;
      margin-bottom: 5px;
      margin-left: 0;
      padding-left: 0;
    }

    .menu-group-header {
      font-weight: bold;
      background: #dee2e6;
    }

    .btnSmall:hover {
      opacity: 0.9;
    }

    #devicesModal .modalContent,
    #departmentsModal .modalContent,
    #branchesModal .modalContent {
      width: 400px;
      max-width: 95%;
      max-height: none;
      min-height: 300px;
      background: linear-gradient(to bottom right, #fff, #f8f8f8);
    }

    .loaderOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99999;
      justify-content: center;
      align-items: center;
    }

    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .paginationContainer {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    .paginationContainer .pageBtn {
      background: #fff;
      border: 1px solid #ccc;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.3s;
      margin: 0 3px;
      min-width: 35px;
      text-align: center;
    }

    .paginationContainer .pageBtn:hover {
      background: #f0f0f0;
    }

    .paginationContainer .pageBtn.active {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }

    .paginationContainer select {
      padding: 5px;
      border-radius: 4px;
    }

    #faceModal .modalContent {
      width: 400px;
    }

    #faceAdminLabel {
      display: flex;
      align-items: center;
      gap: 5px;
      margin: 8px 0;
    }
  
    .frm-group{
      margin-bottom: 16px;
    }
    .frm-group select{
      height: 43px;
      border-radius: 13px;
      background-color: #cccccc2b;
      padding-right: 10px;
      padding-left: 10px;
      box-sizing: border-box;
      width: 100%;
    }
    .frm-group label{
      margin-bottom: 12px;
      display: block;
    }

    #cardModal .modalContent {
      width: 400px;
    }

    #templateSelect {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      min-width: 120px;
    }

    /* 
     *=======================================================
     *     تعديل تصميم مودال إضافة/تعديل الموظف بشكل احترافي
     *=======================================================
     */

    /* نجعل المودال أوسع قليلاً لاستيعاب التصميم */

    #employeeModal .modalContent {
      width: 960px;
      max-width: 95%;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: fadeInModal 0.3s ease;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid #eee;
    }

    #employeeModal .modalHeader {
      background: #007bff;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* تصميم شبيه بالصورة: نجعل أقسام المودال في Tabs */

    #emp_tabs {
      display: none;
    }

    .employeeModalTabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-top: 34px;
      margin-bottom: 10px;
    }

    .employeeModalTab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid transparent;
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      margin-right: 5px;
      background: #f1f1f1;
      font-weight: 500;
    }

    .employeeModalTab.active {
      background: #fff;
      border: 1px solid #ccc;
      border-bottom: 1px solid #fff;
    }

    .employeeModalTabContent {
      display: none;
    }

    .employeeModalTabContent.active {
      display: block;
    }

    /* تنسيق قسم الـ Profile */

    .profile-section {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .profile-left {
      flex: 1;
      min-width: 300px;
    }

    .profile-right {
      width: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      background: #fafafa;
      position: relative;
    }

    .profile-right .imagePlaceholder {
      width: 100%;
      height: 180px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .profile-right .imagePlaceholder img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 4px;
      object-fit: cover;
    }

    .profile-fields {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .profile-fields label {
      font-weight: 600;
      margin-bottom: 3px;
      display: block;
    }

    .profile-fields input,
    .profile-fields select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* تنسيق أقسام أخرى */

    .modalTabPanel {
      margin-top: 15px;
    }

    .modalTabPanel .fieldsGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .modalTabPanel label {
      font-weight: 600;
      display: block;
      margin-bottom: 3px;
    }

    .modalTabPanel input,
    .modalTabPanel select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* تنسيق الأزرار في ذيل المودال */

    #employeeModalFooter {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
      padding-bottom: 15px;
    }

    .form-group {
      padding: 0 15px;
      box-sizing: border-box;
    }

    .form-group input,
    .form-group select {
      height: 43px;
      border-radius: 13px;
      background-color: #cccccc2b;
      padding-right: 10px;
      padding-left: 10px;
      box-sizing: border-box;
    }

    .form-group .select2-selection {
      height: 43px;
      border-radius: 13px;
      background-color: #cccccc2b;
      padding-right: 10px;
      padding-left: 10px;
      padding-top: 8px;
    }

    .form-group .select2-selection__arrow {
      height: 26px;
      position: absolute;
      top: 9px;
      right: 6px;
      width: 20px;
    }

    .form-group input[type="checkbox"] {
      height: 28px;
    }

    .form-wrapper,
    .form-wrapper .form-inner-row {
      display: flex;
      flex-wrap: wrap;
    }

    .form-wrapper .form-row {
      flex-basis: 33.3%;
      max-width: 33.3%;
      box-sizing: border-box;
      padding: 0 10px;
      margin-bottom: 10px;
    }

    .form-wrapper .form-row input,
    .form-wrapper .form-row select {
      width: 100%;
      box-sizing: border-box;
      height: 40px;
      background-color: #cccccc2b;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0 6px;
    }

    .form-wrapper .form-inner-row .col-8 {
      flex-basis: 70%;
      max-width: 70%;
    }

    .form-wrapper .form-inner-row .col-4 {
      flex-basis: 30%;
      max-width: 30%;
      margin-top: 22px;
    }

    html[lang="ar"] .select2-container--open .select2-dropdown {
      left: -19px;
    }
    html[lang="ar"] #departmentsModal .select2-container--open .select2-dropdown,
    html[lang="ar"] #branchesModal .select2-container--open .select2-dropdown{
    left: -2px;
  }
  </style>
</head>

<body onload="initPage()">
  <!-- هيدر -->
  <header>
    <h1 data-lng="headerTitle"></h1>
    <div>
      <button data-lng="headerLogout" onclick="logout()"></button>
      <select id="langSelector">
        <option value="en">English</option>
        <option value="ar">العربية</option>
      </select>
    </div>
  </header>

  <div class="container">
    <!-- المحتوى الرئيسي -->
    <div class="mainContent">
      <div class="errorMsg" id="errorMsg"></div>
      <div class="successMsg" id="successMsg"></div>

      <!-- حاوية البحث أعلى الجدول -->
      <div class="searchFilters">
        <label data-lng="searchNameLabel" for="searchName"></label>
        <input type="text" id="searchName" oninput="filterEmployeesLocally()" data-lng-placeholder="searchNamePlaceholder" />

        <label data-lng="searchDeptLabel" for="searchDept"></label>
        <select id="searchDept" onchange="filterEmployeesLocally()">
          <option value="" data-lng-option="searchDeptAllOption"></option>
        </select>
      </div>

      <!-- الأزرار العلوية: إضافة موظف، تصدير/استيراد إكسل،... -->
      <div class="btns">
        <div style="display: flex; gap: 8px;">
          <button class="addEmployeeBtn" data-lng="addEmployeeBtn" onclick="openModalForAdd()"></button>
          <button class="addEmployeeBtn" id="exportExcelBtn" style="background:#6f42c1;" onclick="exportEmployeesToExcel()" data-lng="exportexcel">
            Export Excel
          </button>

          <label for="importExcelInput" class="addEmployeeBtn" style="background:#fd7e14; cursor:pointer;" data-lng="importexcel">
            Import Excel
          </label>
          <input type="file" id="importExcelInput" accept=".xlsx,.xls" style="display:none" onchange="importEmployeesFromExcel(event)"
          />
        </div>

        <div style="display: flex; gap: 8px;">
          <button class="selectedBtn" id="selectedBtn" data-lng="sellectedSchedule"></button>
          <button class="allSelectedBtn" id="allSelectedBtn" data-lng="allSchedule"></button>
          <!-- زر تعيين الأجهزة للموظفين المحددين -->
          <button data-lng="lblDevicesModalTitle" class="selectedBtn" id="devicesSelectedBtn" style="background:#6f42c1; display:none;"
            onclick="openDevicesModalForSelected()"></button>
          <!-- زر حذف المحددين -->
          <button data-lng="deleteSelectedBtn" class="selectedBtn" id="deleteSelectedBtn" style="background:#dc3545; display:none;"
            onclick="deleteSelectedEmployees()"></button>

            <button data-lng="lblDepartmentsModalTitle" class="selectedBtn" id="departmentSelectedBtn" style="background:#28a745; display:none;"
            onclick="openDepartmentsModalForSelected()"></button>

            <button data-lng="lblBranchesModalTitle" class="selectedBtn" id="branchSelectedBtn" style="background:#6f42c1; display:none;"
            onclick="openBranchesModalForSelected()"></button>

          <!-- زر لتحديد كل الموظفين في الصفحة -->
          <button data-lng="selectAllBtn" class="allSelectedBtn" style="background:#6c757d;" onclick="selectAllInPage()"></button>


        </div>
      </div>

      <!-- جدول الموظفين -->
      <table id="employeeTable">
        <thead>
          <tr>
            <th data-lng="tableHead1"></th>
            <th data-lng="tableHead2"></th>
            <th data-lng="tableHead3"></th>
            <th data-lng="tableHead11"></th>
            <th data-lng="tableHead4"></th>
            <th data-lng="tableHead5"></th>
            <th data-lng="tableHead6"></th>
            <th data-lng="tableHead7"></th>
            <th data-lng="tableHead8"></th>
            <th data-lng="tableHead9"></th>
            <th data-lng="tableHead10"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- أدوات التصفح بالصفحات -->
      <div class="paginationContainer" id="paginationControls"></div>
    </div>

    <!-- الشريط الجانبي -->
    <div class="sidebar"></div>

    <script>
      // دالة لتبديل عرض وإخفاء القائمة الفرعية
      function toggleSubMenu(id) {
        var submenu = document.getElementById(id);
        if (submenu.style.display === "none" || submenu.style.display === "") {
          submenu.style.display = "block";
        } else {
          submenu.style.display = "none";
        }
      }

      // عند تحميل الصفحة، نقوم بفحص إذا كان أي عنصر ضمن القائمة الفرعية يحمل الكلاس "active"
      // وفي حال وجوده، نقوم بفتح القائمة الفرعية تلقائياً.
      // document.addEventListener("DOMContentLoaded", function () {
      //   var submenus = document.querySelectorAll('.submenu');
      //   submenus.forEach(function (submenu) {
      //     if (submenu.querySelector('.navItem.active')) {
      //       submenu.style.display = "block";
      //     }
      //   });
      // });
    </script>

    <!-- مودال تغيير كلمة المرور -->
    <div class="modalOverlay" id="resetModal">
      <div class="modalContent reset">
        <div class="modalHeader">
          <h2 data-lng="reset"></h2>
          <button class="modalCloseBtn" onclick="closeResetModal()">×</button>
        </div>
        <div class="modalBody">
          <label data-lng="newPassword" for="resetInput"></label>
          <input type="text" id="resetInput" data-lng-placeholder="newPasswordPlac" />
          <button class="modalSaveBtn" style="margin-top:10px;" data-lng="btnSaveEmployee" onclick="resetPassword()"></button>
        </div>
      </div>
    </div>

    <!-- 
         ==============================================
         مودال إضافة/تعديل الموظف (بتصميم جديد احترافي)
         ==============================================
    -->
    <div class="modalOverlay" id="employeeModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="employeeModalTitle" data-lng="employeeModalTitleAdd"></h2>
          <button class="modalCloseBtn" onclick="closeEmployeeModal()">×</button>
        </div>
        <div class="modalBody">

          <!-- قسم الـ Profile الأساسي -->
          <div class="profile-section">
            <!-- الحقول الأساسية على اليسار -->
            <div class="profile-left">
              <div class="profile-fields">
                <!-- عمودين من الحقول -->
                <div class="form-group">
                  <label data-lng="lblEnrollId" for="enrollId"></label>
                  <input id="enrollId" data-lng-placeholder="phEnrollId" />
                </div>
                <div class="form-group">
                  <label data-lng="lblEmpName" for="empName"></label>
                  <input id="empName" data-lng-placeholder="phEmpName" />
                </div>

                <div style="display:none;" class="form-group">
                  <!-- نخفي حقل ID من أجل عدم تغيير المنطق -->
                  <input type="hidden" id="employeeDbId" />
                </div>

                <!-- خيار القسم -->
                <div class="form-group">
                  <label data-lng="lblEmpDept" for="empDepartment"></label>
                  <select id="empDepartment"></select>
                </div>

                <!-- الفرع -->
                <div class="form-group">
                  <label data-lng="lblEmpBranch" for="empBranch"></label>
                  <select id="empBranch"></select>
                </div>

                <div class="form-group">
                  <label data-lng="lblEmpJoinDate" for="empJoinDate"></label>
                  <input type="date" id="empJoinDate" />
                </div>

                <div class="form-group">
                  <label data-lng="lblEmpLeaveDate" for="empLeaveDate"></label>
                  <input type="date" id="empLeaveDate" />
                </div>

                <!-- اسم المستخدم + كلمة مرور (تظهر فقط عند الإضافة) -->
                <div id="passUsernameContainer" class="form-group">
                  <label data-lng="username" for="username"></label>
                  <input id="username" data-lng-placeholder="username_plac" oninput="checkUsername()" />
                  <p id="err_msg" style="font-size: 13px;color: red; display: none;" data-lng="username_used"></p>

                  <label data-lng="password" for="password"></label>
                  <input id="password" data-lng-placeholder="password_plac" />
                </div>



                <div class="form-group">
                  <label data-lng="lblMainSalary" for="mainSalary"></label>
                  <input type="number" id="mainSalary" data-lng-placeholder="phMainSalary" />
                </div>

                <div class="form-group">
                  <label data-lng="lblWeekZone" for="weekZone"></label>
                  <select id="weekZone">
                    <option value="">--</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                  </select>
                </div>

                <div style="display:flex; align-items:center; gap: 5px;" class="form-group">
                  <label for="worksForSegmentedTime" style="white-space:nowrap;">
                    <span data-lng="lb_work_segment_time"></span>
                  </label>
                  <input type="checkbox" id="worksForSegmentedTime">
                </div>

                <div class="form-group">
                  <label data-lng="schedule_mode_label" for="scheduleModeSel"></label>
                  <select id="scheduleModeSel" onchange="onScheduleModeChange()">
                    <option value="fixed" data-lng="schedule_mode_shift"></option>
                    <option value="shift" data-lng="schedule_mode_fixed"></option>
                  </select>
                </div>

                <!-- حاوية اختيار الشفت تظهر عند اختيار وضع الشفت -->
                <div id="shiftSelectContainer" style="display: none;" class="form-group">
                  <label data-lng="select_shift_label" for="empShiftSelect"></label>
                  <select id="empShiftSelect"></select>
                </div>
                <div class="form-group">
                  <label for="empTagSelect">Tags</label>
                  <select id="empTagSelect" multiple></select>
                </div>

                <!-- كارت -->
                <div class="form-group">
                  <label data-lng="lblEmpCard" for="empCard"></label>
                  <input type="text" id="empCard" data-lng-placeholder="phEmpCard" />
                </div>
              </div>
            </div>

            <!-- جزء الصورة على اليمين -->
            <div class="profile-right" class="form-group">
              <div class="imagePlaceholder">
                <!-- مجرد عرض توضيحي، سنرفع الصورة عبر المدخل أدناه -->
                <img id="previewEmpImage" src="./images/no_image.png" alt="">
              </div>
              <label data-lng="lblEmpImage" for="empImage">dfdfdf</label>

              <input style="width:100%;" type="file" id="empImage" accept="image/*" onchange="document.getElementById('previewEmpImage').src = window.URL.createObjectURL(this.files[0])"
              />
            </div>
          </div>

          <div id="emp_tabs">
            <!-- تبويبات باقي المعلومات -->
            <div class="employeeModalTabs">


              <div class="employeeModalTab active" onclick="switchEmployeeModalTab(event, 'devicesTab')" id="devices_tab_item">
                <span data-lng="lb_list_of_devices"></span>
              </div>

              <!--
            <div class="employeeModalTab active" onclick="switchEmployeeModalTab(event, 'privateInfoTab')">
              Private Information
            </div>
          -->

              <div class="employeeModalTab" onclick="switchEmployeeModalTab(event, 'scheduleTab')">
                <span data-lng="lb_schedules"></span>
              </div>
              <!--
            <div class="employeeModalTab" onclick="switchEmployeeModalTab(event, 'deviceAccessTab')">
              Device Access Settings
            </div>
            <div class="employeeModalTab" onclick="switchEmployeeModalTab(event, 'attendanceTab')">
              Attendance Settings
            </div>
            <div class="employeeModalTab" onclick="switchEmployeeModalTab(event, 'appTab')">
              App Settings
            </div>
            <div class="employeeModalTab" onclick="switchEmployeeModalTab(event, 'payrollTab')">
              Payroll Settings
            </div>
            <div class="employeeModalTab" onclick="switchEmployeeModalTab(event, 'customAttrTab')">
              Custom Attribute
            </div>
            <div class="employeeModalTab" onclick="switchEmployeeModalTab(event, 'leaveGroupTab')">
              Leave Group
            </div>
          -->
            </div>

            <!-- محتوى كل تبويب -->
            <div class="employeeModalTabContent" id="privateInfoTab">
              <div class="modalTabPanel">
                <p style="color:#999;">
                  (يمكنك وضع معلومات إضافية خاصة بالموظف هنا إن أردت)
                </p>
              </div>
            </div>

            <div class="employeeModalTabContent active" id="devicesTab">
              <div class="modalTabPanel">
                <div class="employee_devices_tab" style="position: relative;">

                  <label data-lng="lblChooseDevices" for="emp_modal_devices_select"></label>

                  <select id="emp_modal_devices_select" multiple></select>

                  <button class="modalSaveBtn" style="background:#fd7e14;" data-lng="btnAllDevices" onclick="selectAllDevicesInEmployeeModal()">All Devices</button>

                  <button class="modalSaveBtn" data-lng="btnSaveDevices" onclick="saveEmployeeDevicesInEmpModal()"></button>

                </div>

              </div>
            </div>

            <div class="employeeModalTabContent" id="scheduleTab">
              <div class="modalTabPanel">
                <table class="emp_modal_scheduleTable" id="emp_modal_scheduleTable">
                  <thead>
                    <tr>
                      <th data-lng="schDay"></th>
                      <th data-lng="schStart"></th>
                      <th data-lng="schEnd"></th>
                      <th data-lng="schOTStart"></th>
                      <th data-lng="schOffset"></th>
                      <th data-lng="schHourPrice"></th>
                      <th data-lng="schOTPrice"></th>
                      <th data-lng="schEdit"></th>
                      <th data-lng="schDelete"></th>
                      <th data-lng="schCopy"></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div style="display: flex;justify-content: space-between;align-items: center;">
                  <div style="margin-top:10px;">
                    <button class="modalSaveBtn restBtn" data-lng="btnAddRest" onclick="addScheduleDay(true)"></button>
                    <button class="modalSaveBtn" data-lng="btnAddDay" onclick="addScheduleDay(false)"></button>
                  </div>
                  <button class="saveScheduleBtn" id="saveScheduleBtn" data-lng="btnSaveEmployee" onclick="saveScheduleToEmployeeModal()"></button>
                </div>
              </div>
            </div>

            <div class="employeeModalTabContent" id="deviceAccessTab">
              <div class="modalTabPanel">
                <p style="color:#999;">(إعدادات وصول الأجهزة... يمكنك تخصيصها لاحقًا)</p>
              </div>
            </div>

            <div class="employeeModalTabContent" id="attendanceTab">
              <div class="modalTabPanel">
                <p style="color:#999;">(إعدادات الحضور...)</p>
              </div>
            </div>

            <div class="employeeModalTabContent" id="appTab">
              <div class="modalTabPanel">
                <p style="color:#999;">(إعدادات التطبيق...)</p>
              </div>
            </div>

            <div class="employeeModalTabContent" id="payrollTab">
              <div class="modalTabPanel">
                <p style="color:#999;">(إعدادات الرواتب...)</p>
              </div>
            </div>

            <div class="employeeModalTabContent" id="customAttrTab">
              <div class="modalTabPanel">
                <p style="color:#999;">(حقول مخصصة...) </p>
              </div>
            </div>

            <div class="employeeModalTabContent" id="leaveGroupTab">
              <div class="modalTabPanel">
                <p style="color:#999;">(مجموعات الإجازات...)</p>
              </div>
            </div>
          </div>

          <!-- أزرار الحفظ -->
          <hr>
          <div id="employeeModalFooter">

            <button class="modalSaveBtn" id="saveEmployeeBtn" data-lng="btnSaveEmployee" onclick="saveEmployee()"></button>
            <!-- يمكن إضافة زر إلغاء إن أردت -->
            <!-- <button class="modalSaveBtn" style="background:#dc3545;" onclick="closeEmployeeModal()">Cancel</button> -->
          </div>
        </div>
      </div>
    </div>

    <!-- مودال جدول الدوام -->
    <div class="modalOverlay" id="scheduleModal">
      <div class="modalContent scheduleWidth">
        <div class="modalHeader">
          <h2 id="scheduleModalTitle" data-lng="lblScheduleTitle"></h2>
          <select id="templateSelect" onchange="applyTemplate(event)">
            <option value="" data-lng="choose_template"></option>
          </select>
          <button class="modalCloseBtn" onclick="closeScheduleModal()">×</button>
        </div>
        <div class="modalBody">
          <table class="scheduleTable" id="scheduleTable">
            <thead>
              <tr>
                <th data-lng="schDay"></th>
                <th data-lng="schStart"></th>
                <th data-lng="schEnd"></th>
                <th data-lng="schOTStart"></th>
                <th data-lng="schOffset"></th>
                <th data-lng="schHourPrice"></th>
                <th data-lng="schOTPrice"></th>
                <th data-lng="schEdit"></th>
                <th data-lng="schDelete"></th>
                <th data-lng="schCopy"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div style="display: flex;justify-content: space-between;align-items: center;">
            <div style="margin-top:10px;">
              <button class="modalSaveBtn restBtn" data-lng="btnAddRest" onclick="addScheduleDay(true)"></button>
              <button class="modalSaveBtn" data-lng="btnAddDay" onclick="addScheduleDay(false)"></button>
            </div>
            <button class="saveScheduleBtn" id="saveScheduleBtn" data-lng="btnSaveEmployee" onclick="saveScheduleToEmployee()"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- مودال تعديل/إضافة يوم في الجدول -->
    <div class="modalOverlay" id="dayModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="dayModalTitle" data-lng="lblDayModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeDayModal()">×</button>
        </div>
        <div class="modalBody form-wrapper">


          <div class="form-row">
            <div class="form-inner-row">
              <div class="col-8">
                <label data-lng="lblDayStart" for="dayStart"></label>
                <input type="time" id="dayStart" />
              </div>
              <div class="col-4">
                <!-- Dropdown for startTime_Offset -->
                <label data-lng="lblStartTimeOffset" for="startTime_Offset"></label>
                <select id="startTime_Offset">
                  <option value="-6">-6</option>
                  <option value="-5">-5</option>
                  <option value="-4">-4</option>
                  <option value="-3">-3</option>
                  <option value="-2">-2</option>
                  <option value="-1">-1</option>
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-inner-row">
              <div class="col-8">
                <label data-lng="lblDayWrStart" for="dayWrStart"></label>
                <input type="time" id="dayWrStart" />
              </div>
              <div class="col-4">
                <!-- Dropdown for work_registration_start_time_Offset -->
                <label data-lng="lblWorkRegStartOffset" for="work_registration_start_time_Offset"></label>
                <select id="work_registration_start_time_Offset">
                  <option value="-6">-6</option>
                  <option value="-5">-5</option>
                  <option value="-4">-4</option>
                  <option value="-3">-3</option>
                  <option value="-2">-2</option>
                  <option value="-1">-1</option>
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-inner-row">
              <div class="col-8">
                <label data-lng="lblDayLastEntry" for="dayLastEntry"></label>
                <input type="time" id="dayLastEntry" />
              </div>
              <div class="col-4">
                <!-- Dropdown for last_entry_prevention_time_Offset -->
                <label data-lng="lblLastEntryOffset" for="last_entry_prevention_time_Offset"></label>
                <select id="last_entry_prevention_time_Offset">
                  <option value="-6">-6</option>
                  <option value="-5">-5</option>
                  <option value="-4">-4</option>
                  <option value="-3">-3</option>
                  <option value="-2">-2</option>
                  <option value="-1">-1</option>
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-inner-row">
              <div class="col-8">
                <label data-lng="lblDayEnd" for="dayEnd"></label>
                <input type="time" id="dayEnd" />
              </div>
              <div class="col-4">
                <!-- Dropdown for endTime_Offset -->
                <label data-lng="lblEndTimeOffset" for="endTime_Offset"></label>
                <select id="endTime_Offset">
                  <option value="-6">-6</option>
                  <option value="-5">-5</option>
                  <option value="-4">-4</option>
                  <option value="-3">-3</option>
                  <option value="-2">-2</option>
                  <option value="-1">-1</option>
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-inner-row">
              <div class="col-8">
                <label data-lng="lblDayFirstExit" for="dayFirstExit"></label>
                <input type="time" id="dayFirstExit" />
              </div>
              <div class="col-4">
                <!-- Dropdown for first_exit_allowed_time_Offset -->
                <label data-lng="lblFirstExitOffset" for="first_exit_allowed_time_Offset"></label>
                <select id="first_exit_allowed_time_Offset">
                  <option value="-6">-6</option>
                  <option value="-5">-5</option>
                  <option value="-4">-4</option>
                  <option value="-3">-3</option>
                  <option value="-2">-2</option>
                  <option value="-1">-1</option>
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-inner-row">
              <div class="col-8">
                <label data-lng="lblDayLastExit" for="dayLastExit"></label>
                <input type="time" id="dayLastExit" />
              </div>
              <div class="col-4">
                <!-- Dropdown for last_exit_allowed_time_Offset -->
                <label data-lng="lblLastExitOffset" for="last_exit_allowed_time_Offset"></label>
                <select id="last_exit_allowed_time_Offset">
                  <option value="-6">-6</option>
                  <option value="-5">-5</option>
                  <option value="-4">-4</option>
                  <option value="-3">-3</option>
                  <option value="-2">-2</option>
                  <option value="-1">-1</option>
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-row">
            <label data-lng="lblDayAllowedDelay" for="dayAllowedDelay"></label>
            <input type="number" id="dayAllowedDelay" />
          </div>
          <div class="form-row">
            <label data-lng="lblDayAllowedExit" for="dayAllowedExit"></label>
            <input type="number" id="dayAllowedExit" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayOfficialHours" for="dayOfficialHours"></label>
            <input type="number" id="dayOfficialHours" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayDailySalary" for="dayDailySalary"></label>
            <input type="number" id="dayDailySalary" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayLateCutCount" for="dayLateCutCount"></label>
            <input type="number" id="dayLateCutCount" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayLateMinPrice" for="dayLateMinPrice"></label>
            <input type="number" id="dayLateMinPrice" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayEarlyCutCount" for="dayEarlyCutCount"></label>
            <input type="number" id="dayEarlyCutCount" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayEarlyMinPrice" for="dayEarlyMinPrice"></label>
            <input type="number" id="dayEarlyMinPrice" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayMinOTHours" for="dayMinOTHours"></label>
            <input type="number" id="dayMinOTHours" />
          </div>

          <div class="form-row">
            <div class="form-inner-row">
              <div class="col-8">
                <label data-lng="lblDayOTStart" for="dayOTStart"></label>
                <input type="time" id="dayOTStart" />
              </div>
              <div class="col-4">
                <!-- Dropdown for overtimeStart_Offset -->
                <label data-lng="lblOvertimeStartOffset" for="overtimeStart_Offset"></label>
                <select id="overtimeStart_Offset">
                  <option value="-6">-6</option>
                  <option value="-5">-5</option>
                  <option value="-4">-4</option>
                  <option value="-3">-3</option>
                  <option value="-2">-2</option>
                  <option value="-1">-1</option>
                  <option value="0" selected>0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-row">
            <label data-lng="lblDayOTEligible" for="dayOTEligible"></label>
            <select id="dayOTEligible">
              <option value="false">false</option>
              <option value="true">true</option>
            </select>
          </div>

          <div class="form-row">
            <input type="hidden" id="dayIndex" />

            <label data-lng="lblDaySelect" for="daySelect"></label>
            <select id="daySelect">
              <option value="Sun">Sun</option>
              <option value="Mon">Mon</option>
              <option value="Tue">Tue</option>
              <option value="Wed">Wed</option>
              <option value="Thu">Thu</option>
              <option value="Fri">Fri</option>
              <option value="Sat">Sat</option>
            </select>
          </div>

          <div class="form-row">
            <label data-lng="lblDayDailyWage" for="dayDailyWage"></label>
            <select id="dayDailyWage">
              <option value="false">false</option>
              <option value="true">true</option>
            </select>
          </div>

          <div class="form-row">
            <label data-lng="lblDayAllowedMinRest" for="dayAllowedMinRest"></label>
            <input type="number" id="dayAllowedMinRest" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayRestMinPrice" for="dayRestMinPrice"></label>
            <input type="number" id="dayRestMinPrice" />
          </div>

          <div class="form-row">
            <label data-lng="lblDayAbsentCut" for="dayAbsentCut"></label>
            <input type="number" id="dayAbsentCut" />
          </div>

          <div class="form-row" style="display: none;">
            <label data-lng="lblDayOffset" for="dayOffset"></label>
            <input type="number" id="dayOffset" />
          </div>
          <div class="form-row">
            <label data-lng="lblDayHourPrice" for="dayHourPrice"></label>
            <input type="number" id="dayHourPrice" />
          </div>
          <div class="form-row">
            <label data-lng="lblDayOTPrice" for="dayOTPrice"></label>
            <input type="number" id="dayOTPrice" />
          </div>





          <button class="modalSaveBtn" data-lng="btnSaveDay" onclick="saveDay()"></button>
        </div>
      </div>
    </div>

    <!-- مودال تعيين الأجهزة -->
    <div class="modalOverlay" id="devicesModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="devicesModalTitle" data-lng="lblDevicesModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeDevicesModal()">×</button>
        </div>
        <div class="modalBody">
          <label data-lng="lblChooseDevices" for="devicesSelect"></label>
          <select id="devicesSelect" multiple></select>

          <button class="modalSaveBtn" style="background:#fd7e14;" data-lng="btnAllDevices" onclick="selectAllDevicesInModal()">All Devices</button>
          <button class="modalSaveBtn" data-lng="btnSaveDevices" onclick="saveEmployeeDevices()"></button>
        </div>
      </div>
    </div>

    <div class="modalOverlay" id="departmentsModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="departmentsModalTitle" data-lng="lblDepartmentsModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeDepartmentsModal()">×</button>
        </div>

        <div class="modalBody">
          <div class="frm-group">
            <label data-lng="lblChooseDepartment" for="departmentsSelect"></label>
            <select id="departmentsSelect"></select>
          </div>
          <button class="modalSaveBtn" data-lng="btnSaveDepartment" onclick="saveEmployeeDepartment()"></button>
        </div>
      </div>
    </div>

    <div class="modalOverlay" id="branchesModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 id="branchesModalTitle" data-lng="lblBranchesModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeBranchesModal()">×</button>
        </div>

        <div class="modalBody">
          <div class="frm-group">
            <label data-lng="lblChooseBranch" for="branchesSelect"></label>
            <select id="branchesSelect"></select>
          </div>
          <button class="modalSaveBtn" data-lng="btnSaveBranch" onclick="saveEmployeeBranch()"></button>
        </div>
      </div>
    </div>

    <!-- مودال سحب بصمة الوجه -->
    <div class="modalOverlay" id="faceModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 data-lng="lblFaceModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeFaceModal()">×</button>
        </div>
        <div class="modalBody">

          <div class="frm-group">
            <label data-lng="lblFaceDeviceSelect" for="faceDeviceSelect"></label>
            <select id="faceDeviceSelect"></select>
          </div>
          <div class="frm-group">
            <label id="faceAdminLabel">
              <input type="checkbox" id="faceAdminCheckbox" />
              <span data-lng="lblFaceAdminCheck"></span>
            </label>
          </div>
          <button class="modalSaveBtn" data-lng="btnCaptureFace" onclick="captureFace()"></button>
        </div>
      </div>
    </div>

    <!-- مودال سحب بصمة الإصبع -->
    <div class="modalOverlay" id="fingerModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 data-lng="lblFingerModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeFingerModal()">×</button>
        </div>
        <div class="modalBody">
          <div class="frm-group">
            <label data-lng="devices" for="fingerDeviceSelect"></label>
            <select id="fingerDeviceSelect"></select>
          </div>
          

          <button class="modalSaveBtn" data-lng="save" onclick="captureFinger()"></button>
        </div>
      </div>
    </div>

    <!-- مودال سحب رقم الكارت -->
    <div class="modalOverlay" id="cardModal">
      <div class="modalContent">
        <div class="modalHeader">
          <h2 data-lng="lblCardModalTitle"></h2>
          <button class="modalCloseBtn" onclick="closeCardModal()">×</button>
        </div>
        <div class="modalBody">
          <div class="frm-group">
            <label data-lng="lblCardDeviceSelect" for="cardDeviceSelect"></label>
            <select id="cardDeviceSelect"></select>
          </div>
          <button class="modalSaveBtn" data-lng="btnCaptureCard" onclick="captureCard()"></button>
        </div>
      </div>
    </div>

    <!-- لودر -->
    <div class="loaderOverlay" id="loaderOverlay">
      <div class="loader"></div>
    </div>


    <!-- سكربت الصفحة -->
    <script>
      /***************************************************
       * 1) آلية اللغة الموحدة
       ***************************************************/
      const LANG_PATH = './lang';
      const LANG_KEY = 'lng';
      let translations = {};
      function getTranslate(key) { return translations[key] || "" }

      async function loadLanguageFile(lang) {
        try {
          const response = await fetch(`${LANG_PATH}/employee_${lang}.json`);
          if (!response.ok) {
            throw new Error(`Error loading ${lang}.json`);
          }
          translations = await response.json();
        } catch (error) {
          console.error("Error loading translation file:", error);
        }
      }

      function applyTranslations(lang) {
        document.documentElement.lang = lang;
        document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
        document.querySelectorAll('[data-lng]').forEach(el => {
          const key = el.getAttribute('data-lng');
          if (translations[key]) {
            el.textContent = translations[key];
          }
        });
        document.querySelectorAll('[data-lng-placeholder]').forEach(el => {
          const key = el.getAttribute('data-lng-placeholder');
          if (translations[key]) {
            el.placeholder = translations[key];
          }
        });
        document.querySelectorAll('[data-lng-option]').forEach(el => {
          const key = el.getAttribute('data-lng-option');
          if (translations[key]) {
            el.textContent = translations[key];
          }
        });
        document.querySelectorAll('[data-lng-hover-title]').forEach(el => {
          const key = el.getAttribute('data-lng-hover-title');
          if (translations[key]) {
            el.setAttribute('title', translations[key])
          }
        });
      }

      async function setLanguage(lang) {
        await loadLanguageFile(lang);
        localStorage.setItem(LANG_KEY, lang);
        applyTranslations(lang);

        await loadSidebarLangFile(lang);
        applySidebarTranslation();

      }

      /********************************************************
       * 2) بقية الدوال الخاصة بالصفحة (إدارة الموظفين)
       ********************************************************/
      let authToken = null;
      let allEmployees = [];
      let allDepartments = [];
      let filteredEmployees = [];
      let currentSchedules = [];
      let currentEmployeeIndex = null;
      let dayIndex = null;
      let allDevices = [];
      let allTagEmployees = [];
      let currentPage = 1;
      let pageSize = 10;

      let templates = []
      // لعرض قائمة الشفتات
      let allShifts = [];

      // وضعية أجهزة لعدة موظفين
      let multiDevices = false;
      let selectedEmployeesForDevices = [];
      let selectedEmployeesForDepartments = [];
      let selectedEmployeesForBranches = [];

      // أقسام
      let firstDepartmentId = null;
      let firstDepartmentName = null;

      function initPage() {
        let storedLang = localStorage.getItem(LANG_KEY);
        if (!storedLang) storedLang = 'en';
        document.getElementById('langSelector').value = storedLang;
        setLanguage(storedLang).then(() => {
          authToken = localStorage.getItem('authToken');
          if (!authToken) {
            window.location.href = 'login.html';
            return;
          }
          loadEmployees();
          loadBranches();
          loadDepartments();
          loadAllDevices();
          loadTemplates();
          loadTagEmployees();
          loadShifts(); // نستدعي لجلب قائمة الشفتات

          $('#devicesSelect').select2({
            width: '100%',
            placeholder: 'Choose devices',
            dropdownParent: $('#devicesModal .modalBody'),
            closeOnSelect: false
          });

          $('#departmentsSelect').select2({
              width: '100%',
              placeholder: "----",
              dropdownParent: $('#departmentsModal .modalBody'),
              closeOnSelect: false
          });

          $('#branchesSelect').select2({
              width: '100%',
              placeholder: "----",
              dropdownParent: $('#branchesModal .modalBody'),
              closeOnSelect: false
          });

          $('#empTagSelect').select2({
            width: '100%',
            placeholder: 'Select Tagemployee',
            allowClear: true,
            dropdownParent: $('#employeeModal .modalBody')
          });

          $('#emp_modal_devices_select').select2({
            width: '100%',
            placeholder: 'Choose devices',
            dropdownParent: $('.employee_devices_tab'),
            closeOnSelect: false
          });

        });
      }

      document.getElementById('langSelector').addEventListener('change', function () {
        setLanguage(this.value);
      });

      function logout() {
        localStorage.removeItem('authToken');
        window.location.href = 'login.html';
      }

      // جلب الشفتات لعرضها في select
      async function loadShifts() {
        try {
          const resp = await fetch('/api/shifts', {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error('Failed to fetch shifts');
          const data = await resp.json();
          allShifts = data || [];

          // احجز select
          const empShiftSelect = document.getElementById('empShiftSelect');
          empShiftSelect.innerHTML = '<option value="">-- Select Shift --</option>';
          allShifts.forEach(sh => {
            const opt = document.createElement('option');
            opt.value = sh._id;
            opt.textContent = sh.shiftName;
            empShiftSelect.appendChild(opt);
          });
        } catch (err) {
          console.error("Failed to load shifts", err);
        }
      }

      // جلب الموظفين
      async function loadEmployees() {
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        try {
          const resp = await fetch('/api/employees?page=1&limit=9999999', {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error('Failed to fetch employees');
          const data = await resp.json();
          allEmployees = data.data || data;
          filteredEmployees = [...allEmployees];
          currentPage = 1;
          renderEmployees(filteredEmployees);
          renderPaginationControls();
        } catch (err) {
          errorMsg.textContent = err.message;
        }
      }

      // جلب الأقسام
      async function loadDepartments() {
        try {
          const resp = await fetch('/api/departments', {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error('Failed to fetch departments');
          const data = await resp.json();
          allDepartments = data;

          // حفظ أول قسم
          if (allDepartments.length > 0) {
            firstDepartmentId = allDepartments[0]._id;
            firstDepartmentName = allDepartments[0].department_name;
          }

          const searchDeptSel = document.getElementById('searchDept');
          allDepartments.forEach(dep => {
            const opt = document.createElement('option');
            opt.value = dep._id;
            opt.textContent = dep.department_name || ('Dept ' + dep._id);
            searchDeptSel.appendChild(opt);
          });

          const empDeptSel = document.getElementById('empDepartment');
          empDeptSel.innerHTML = '';
          // const emptyOption = document.createElement('option');
          // emptyOption.value = '';
          // emptyOption.textContent = '';
          // empDeptSel.appendChild(emptyOption);

          allDepartments.forEach(dep => {
            const opt = document.createElement('option');
            opt.value = dep._id;
            opt.textContent = dep.department_name;
            empDeptSel.appendChild(opt);
          });

          initSelect2Department();

          const departmentsSelect = document.getElementById('departmentsSelect');
          departmentsSelect.innerHTML = '';

            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = "----";
            emptyOption.setAttribute("selected", "selected");
            departmentsSelect.appendChild(emptyOption);

          allDepartments.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d._id;
            opt.textContent = d.department_name;
            departmentsSelect.appendChild(opt);
          });
          

        } catch (err) {
          console.error(err);
        }
      }

      async function loadAllDevices() {

        try {
          const resp = await fetch('/api/devices', {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error('Failed to fetch devices');
          const data = await resp.json();
          allDevices = data;

          const devicesSelect = document.getElementById('devicesSelect');
          devicesSelect.innerHTML = '';
          allDevices.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d._id;
            opt.textContent = d.name || `Device ${d._id}`;
            devicesSelect.appendChild(opt);
          });

          const emp_modal_devices_select = document.getElementById('emp_modal_devices_select');
          emp_modal_devices_select.innerHTML = '';
          allDevices.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d._id;
            opt.textContent = d.name || `Device ${d._id}`;
            emp_modal_devices_select.appendChild(opt);
          });

        } catch (err) {
          console.error(err);
        }
      }

      function initSelect2Department() {

        $('#empDepartment').select2({
          width: '100%',
          placeholder: 'Choose Department',
          allowClear: true,
          dropdownParent: $('#employeeModal .modalBody')
        });

      }

      let sellectedEmployees = []
      let openModalFromSellection = false
      let openModalFromAllSellection = false

      const selectedBtn = document.getElementById('selectedBtn')
      selectedBtn.addEventListener('click', _ => {
        openModalFromSellection = true
        openScheduleModal(-1)
      })

      document.getElementById('allSelectedBtn').addEventListener('click', _ => {
        openModalFromSellection = true
        openModalFromAllSellection = true
        openScheduleModal(-1)
      })

      const devicesSelectedBtn = document.getElementById('devicesSelectedBtn');

      const departmentSelectedBtn = document.getElementById('departmentSelectedBtn');
      
      const branchSelectedBtn = document.getElementById('branchSelectedBtn');

      function renderEmployees(empArr) {
        selectedBtn.style.display = 'none'
        devicesSelectedBtn.style.display = 'none'
        departmentSelectedBtn.style.display = 'none'
        branchSelectedBtn.style.display = 'none'
        const tb = document.getElementById('employeeTable').querySelector('tbody');
        tb.innerHTML = '';
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageEmployees = empArr.slice(startIndex, endIndex);

        pageEmployees.forEach((emp, i) => {
          const globalIndex = startIndex + i;
          const dateJoin = emp.joining_date ? emp.joining_date.split('T')[0] : '';
          const dateLeave = emp.leave_date ? emp.leave_date.split('T')[0] : '';
          const departmentName = emp.department || '';

          let imgTag = `<img src="${emp.image || './images/no_image.png'}" alt="" class="employeeImage" />`

          const devicesCount = Array.isArray(emp.devices) ? emp.devices.length : 0;

          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td>${globalIndex + 1}</td>
          <td>${imgTag}</td>
          <td>${emp.enroll_id || ''}</td>
          <td>${emp.username || ''}</td>
          <td>${emp.name || ''}</td>
          <td>${departmentName}</td>
          <td>${dateJoin}</td>
          <td>${dateLeave}</td>
          <td>${emp.main_salary || 0}</td>
          <td>
            <button class="iconBtn" onclick="openModalForReset(${globalIndex})" data-lng-hover-title='reset' title="${getTranslate('reset')}">
              <i style='color: #6f42c1;' class="bi bi-lock"></i>
            </button>
            <button class="iconBtn edit" onclick="openModalForEdit(${globalIndex})" data-lng-hover-title='edit' title="${getTranslate('edit')}">
              <i class="bi bi-pencil-square"></i>
            </button>
            <button class="iconBtn delete" onclick="deleteEmployee('${emp._id}')" data-lng-hover-title='delete' title="${getTranslate('delete')}">
              <i class="bi bi-trash-fill"></i>
            </button>
            <button class="iconBtn schedule" onclick="openScheduleModal(${globalIndex})" data-lng-hover-title='schedule' title="${getTranslate('schedule')}">
              <i class="bi bi-calendar3"></i>
            </button>
            <button class="iconBtn devices" onclick="openDevicesModal(${globalIndex})" data-lng-hover-title='devices' title="${getTranslate('devices')}" (${devicesCount})">
              <i class="bi bi-hdd-network"></i>
            </button>
            <button class="iconBtn send" onclick="sendUserToDevices(${globalIndex})" data-lng-hover-title='send_to_devices' title="${getTranslate('send_to_devices')}">
              <i class="bi bi-send"></i>
            </button>
            <!-- الزر الجديد لإرسال بصمة اليد -->
            <button class="iconBtn sendFingerprint" onclick="sendFingerprintToDevices(${globalIndex})" data-lng-hover-title='send_fingerprint' title="${getTranslate('send_fingerprint')}">
              <i class="bi bi-person-fill-up"></i>
            </button>
            <button class="iconBtn face" onclick="openFaceModal(${globalIndex})" data-lng-hover-title='face' title="${getTranslate('face')}">
              <i class="bi bi-person-bounding-box"></i>
            </button>
            <button class="iconBtn finger" onclick="openFingerModal(${globalIndex})" data-lng-hover-title='fingerprint' title="${getTranslate('fingerprint')}">
              <i class="bi bi-fingerprint"></i>
            </button>
            <button class="iconBtn card" onclick="openCardModal(${globalIndex})" data-lng-hover-title='card_number' title="${getTranslate('card_number')}">
              <i class="bi bi-credit-card-2-front"></i>
            </button>
          </td>
          <td>
            <input type="checkbox" class="em_checkbox" value='${emp._id}'>
          </td>
        `;
          tb.appendChild(tr);
        });

        const checkboxes = Array.from(document.querySelectorAll('.em_checkbox'))
        checkboxes.forEach(checkbox => {
          checkbox.addEventListener('change', _ => {
            sellectedEmployees = checkboxes.filter(item => item.checked).map(item => item.value)
            selectedBtn.style.display = sellectedEmployees.length ? 'block' : 'none'
            devicesSelectedBtn.style.display = sellectedEmployees.length ? 'block' : 'none';
            departmentSelectedBtn.style.display = sellectedEmployees.length ? 'block' : 'none';
            branchSelectedBtn.style.display = sellectedEmployees.length ? 'block' : 'none';
          })
        })
      }

      function isNumber(str) {
        return /^\d+$/.test(str);
      }

      async function saveCommand(bodyObj = {}) {
        const resp = await fetch('/api/requests', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authToken
          },
          body: JSON.stringify(bodyObj)
        });
        if (!resp.ok) {
          const errText = await resp.text();
          throw new Error(`Fail to send data to device:  ${errText}`);
        }
      }

      // (1) إرسال معلومات الوجه
      async function sendUserToDevices(indexInFiltered) {
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        showLoader();
        try {
          const emp = filteredEmployees[indexInFiltered];
          if (!emp.devices || emp.devices.length === 0) {
            throw new Error('No assigned devices for this employee.');
          }
          const recordBase64 = emp.image || '';
          const userInfoTemplate = {
            enrollid: isNumber(emp.enroll_id) ? +emp.enroll_id : emp.enroll_id,
            name: emp.name || '',
            backupnum: 50,
            admin: 0,
            record: recordBase64.replace(/^data:image\/[a-zA-Z]+;base64,/, ''),
            zoneid: emp.week_zone || 0,
            departmant: emp.department || '',
            card: emp.card || ''
          };

          for (const devId of emp.devices) {
            const dev = allDevices.find(d => d._id === devId);
            if (!dev) {
              console.warn(`No device data found ID=${devId}`);
              continue;
            }
            const sn = dev.serial;
            const serverIp = dev.serverip;
            const bodyObj = { sn: sn, userInfo: userInfoTemplate };
            const url = `${serverIp}/api/setuserinfo`;
            const resp = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(bodyObj)
            });
            if (!resp.ok) {
              const commandBody = {
                url: url,
                body: bodyObj,
                ActionType: "FaceId",
                device_name: dev.name || sn,
                operation_type: "setUserInfo"
              };

              await saveCommand(commandBody);
            }
          }
          successMsg.textContent = getTranslate("success_msg");
        } catch (err) {
          errorMsg.textContent = err.message;
        } finally {
          hideLoader();
        }
      }

      // (2) إرسال بصمة اليد
      async function sendFingerprintToDevices(indexInFiltered) {
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        showLoader();
        try {
          const emp = filteredEmployees[indexInFiltered];
          if (!emp.devices || emp.devices.length === 0) {
            throw new Error(getTranslate('noAssignedD_err'));
          }
          const fingerprintData = emp.fingerprint || '';
          if (!fingerprintData) {
            throw new Error(getTranslate('no_fingerprint_data'));
          }
          const userInfoTemplate = {
            enrollid: isNumber(emp.enroll_id) ? +emp.enroll_id : emp.enroll_id,
            name: emp.name || '',
            backupnum: 0,
            admin: 0,
            record: fingerprintData,
            zoneid: emp.week_zone || 0,
            departmant: emp.department || '',
            card: emp.card || ''
          };

          for (const devId of emp.devices) {
            const dev = allDevices.find(d => d._id === devId);
            if (!dev) {
              console.warn(`No device data found ID=${devId}`);
              continue;
            }
            const sn = dev.serial;
            const serverIp = dev.serverip;
            const bodyObj = { sn: sn, userInfo: userInfoTemplate };
            const url = `${serverIp}/api/setuserinfo`;
            const resp = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(bodyObj)
            });
            if (!resp.ok) {
              const commandBody = {
                url: url,
                body: bodyObj,
                ActionType: "Fingerprint",
                device_name: dev.name || sn,
                operation_type: "setUserInfo"
              };

              await saveCommand(commandBody);
            }
          }
          successMsg.textContent = getTranslate("success_msg");
        } catch (err) {
          errorMsg.textContent = err.message;
        } finally {
          hideLoader();
        }
      }

      function renderPaginationControls() {
        const paginationDiv = document.getElementById('paginationControls');
        paginationDiv.innerHTML = '';
        const totalPages = Math.ceil(filteredEmployees.length / pageSize);
        if (totalPages <= 0) return;

        const prevBtn = document.createElement('button');
        prevBtn.textContent = getTranslate('prev');
        prevBtn.setAttribute('data-lng', 'prev')
        prevBtn.className = 'pageBtn';
        prevBtn.disabled = (currentPage === 1);
        prevBtn.onclick = () => goToPrevPage();
        paginationDiv.appendChild(prevBtn);

        const maxPagesToShow = 6;
        let startPage = Math.max(1, currentPage - 2);
        let endPage = startPage + maxPagesToShow - 1;
        if (endPage > totalPages) {
          endPage = totalPages;
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }
        for (let p = startPage; p <= endPage; p++) {
          const pageBtn = document.createElement('button');
          pageBtn.textContent = p;
          pageBtn.className = 'pageBtn' + (p === currentPage ? ' active' : '');
          pageBtn.onclick = () => goToPage(p);
          paginationDiv.appendChild(pageBtn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.textContent = getTranslate('next');
        nextBtn.setAttribute('data-lng', 'next')
        nextBtn.className = 'pageBtn';
        nextBtn.disabled = (currentPage === totalPages);
        nextBtn.onclick = () => goToNextPage();
        paginationDiv.appendChild(nextBtn);

        const selectPageSize = document.createElement('select');
        [10, 25, 50, 100].forEach(size => {
          const opt = document.createElement('option');
          opt.value = size;
          opt.textContent = size;
          if (size === pageSize) opt.selected = true;
          selectPageSize.appendChild(opt);
        });
        selectPageSize.onchange = (e) => changePageSize(+e.target.value);
        paginationDiv.appendChild(selectPageSize);
      }

      function goToPage(page) {
        currentPage = page;
        renderEmployees(filteredEmployees);
        renderPaginationControls();
      }

      function goToPrevPage() {
        if (currentPage > 1) {
          currentPage--;
          renderEmployees(filteredEmployees);
          renderPaginationControls();
        }
      }

      function goToNextPage() {
        const totalPages = Math.ceil(filteredEmployees.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          renderEmployees(filteredEmployees);
          renderPaginationControls();
        }
      }

      function changePageSize(newSize) {
        pageSize = newSize;
        currentPage = 1;
        renderEmployees(filteredEmployees);
        renderPaginationControls();
      }

      function filterEmployeesLocally() {
        const nameVal = document.getElementById('searchName').value.toLowerCase();
        const deptVal = document.getElementById('searchDept').value;
        filteredEmployees = allEmployees.filter(e => {
          if (nameVal) {
            if (!(e.name || '').toLowerCase().includes(nameVal)) return false;
          }
          if (deptVal) {
            if (e.department_id !== deptVal) return false;
          }
          return true;
        });
        currentPage = 1;
        renderEmployees(filteredEmployees);
        renderPaginationControls();
      }
      //جلب التاكات 
      async function loadTagEmployees() {
        try {
          const resp = await fetch('/api/tagemployee', {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error('Failed to fetch tagemployee');
          const data = await resp.json();

          // نخزّنهم في المتغير العالمي
          allTagEmployees = data; // مصفوفة من التاكات

          // بعد أن حصلنا عليها، نضيفها إلى الـ <select id="empTagSelect">
          const empTagSelect = document.getElementById('empTagSelect');
          empTagSelect.innerHTML = ''; // تفريغ القديم

          allTagEmployees.forEach(tagObj => {
            const opt = document.createElement('option');
            opt.value = tagObj._id;    // القيمة هي الـID
            opt.textContent = tagObj.name;  // الاسم
            empTagSelect.appendChild(opt);
          });

          // تهيئة الـ select2 لهذا الحقل
          // initSelect2TagEmployee();

        } catch (err) {
          console.error(err);
        }
      }

      // جلب الفروع
      let allBranches = [];
      async function loadBranches() {
        try {
          const resp = await fetch('/api/branches', {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error('Failed to fetch branches');
          const data = await resp.json();
          allBranches = data;

          const empBranchSel = document.getElementById('empBranch');
          empBranchSel.innerHTML = '';

          allBranches.forEach(branch => {
            const opt = document.createElement('option');
            opt.value = branch._id;
            opt.textContent = branch.name;
            empBranchSel.appendChild(opt);
          });

          const branchesSelect = document.getElementById('branchesSelect');
          branchesSelect.innerHTML = '';

            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = "----";
            emptyOption.setAttribute("selected", "selected");
            branchesSelect.appendChild(emptyOption);

            allBranches.forEach(branch => {
            const opt = document.createElement('option');
            opt.value = branch._id;
            opt.textContent = branch.name;
            branchesSelect.appendChild(opt);
          });

        } catch (err) {
          console.error('Error loading branches', err);
        }
      }

      // reset password
      let currentEmployeeForReset = {}
      function openModalForReset(index) {
        const emp = filteredEmployees[index];
        currentEmployeeForReset = emp;
        document.getElementById('resetModal').style.display = 'flex';
      }

      async function resetPassword() {
        const input = document.getElementById('resetInput')
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';

        const newPass = input.value
        if (!newPass ?.trim()) return input.value = ''

        const body = {
          employee: currentEmployeeForReset._id,
          password: newPass
        }

        try {
          let url = '/api/employees/reset-password';
          let method = 'PUT';
          const resp = await fetch(url, {
            method,
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });
          if (!resp.ok) throw new Error(getTranslate('reset_err'))
          successMsg.textContent = getTranslate('success_msg');
        } catch (err) {
          errorMsg.textContent = err.message;
        }

        input.value = ''
        closeResetModal()
      }

      function closeResetModal() {
        document.getElementById('resetModal').style.display = 'none';
      }

      function openModalForAdd() {
        document.getElementById('emp_tabs').style.display = 'none';

        document.getElementById('err_msg').style.display = 'none'

        const saveBtn = document.getElementById('saveEmployeeBtn')
        saveBtn.style.pointerEvents = 'auto'
        saveBtn.style.opacity = 1
        document.getElementById('employeeModalTitle').innerText = getTranslate('employeeModalTitleAdd')
        document.getElementById('employeeDbId').value = '';
        document.getElementById('enrollId').value = '';
        document.getElementById('empName').value = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('passUsernameContainer').style.display = 'block';
        $('#empDepartment').val($('#empDepartment option:first-child').val()).trigger('change');

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('empJoinDate').value = today;
        document.getElementById('empLeaveDate').value = 'NULL';
        document.getElementById('mainSalary').value = '0';

        document.getElementById('weekZone').value = '';
        document.getElementById('empImage').value = '';
        document.getElementById('previewEmpImage').src = './images/no_image.png';
        document.getElementById('empCard').value = '';

        // الوضع الافتراضي للدوام = fixed
        document.getElementById('scheduleModeSel').value = 'fixed';
        document.getElementById('shiftSelectContainer').style.display = 'none';
        $('#empShiftSelect').val('').trigger('change');
        document.getElementById('worksForSegmentedTime').checked = false;
        $('#empTagSelect').val([]).trigger('change');
        showEmployeeModal();
      }

      function openModalForEdit(indexInFiltered) {

        document.getElementById("emp_tabs").style.display = "block";

        const saveBtn = document.getElementById('saveEmployeeBtn')
        saveBtn.style.pointerEvents = 'auto'
        saveBtn.style.opacity = 1

        document.getElementById('employeeModalTitle').innerText = getTranslate("employeeModalTitleEdit")
        const emp = filteredEmployees[indexInFiltered];
        document.getElementById('employeeDbId').value = emp._id || '';
        document.getElementById('enrollId').value = emp.enroll_id || '';
        document.getElementById('empName').value = emp.name || '';
        document.getElementById('passUsernameContainer').style.display = 'none';
        if (emp.department_id) {
          $('#empDepartment').val(emp.department_id).trigger('change');
        } else {
          $('#empDepartment').val('').trigger('change');
        }
        if (emp.branch) {
          document.getElementById('empBranch').value = typeof emp.branch === 'object' && emp.branch._id ? emp.branch._id : emp.branch;
        } else {
          document.getElementById('empBranch').value = '';
        }

        if (emp.joining_date) {
          document.getElementById('empJoinDate').value = emp.joining_date.split('T')[0];
        }
        if (emp.leave_date) {
          document.getElementById('empLeaveDate').value = emp.leave_date.split('T')[0];
        } else {
          document.getElementById('empLeaveDate').value = 'NULL';
        }
        document.getElementById('mainSalary').value = emp.main_salary || 0;
        document.getElementById('weekZone').value = emp.week_zone || '';
        document.getElementById('empImage').value = '';
        document.getElementById('previewEmpImage').src = emp.image || './images/no_image.png';
        document.getElementById('empCard').value = emp.card || '';

        // تحديد الوضع (scheduleMode)
        const modeSel = document.getElementById('scheduleModeSel');
        if (emp.scheduleMode === 'shift') {
          modeSel.value = 'shift';
          document.getElementById('shiftSelectContainer').style.display = 'block';
          // لو وجد shift_id => نعكسه للواجهة
          if (emp.shift_id) {
            $('#empShiftSelect').val(emp.shift_id).trigger('change');
          } else {
            $('#empShiftSelect').val('').trigger('change');
          }
        } else {
          // افتراضي fixed
          modeSel.value = 'fixed';
          document.getElementById('shiftSelectContainer').style.display = 'none';
          $('#empShiftSelect').val('').trigger('change');
        }
        document.getElementById('worksForSegmentedTime').checked = !!emp.works_for_segmented_time;

        // تعيين حقل التاكات (tagemployee) إن وجد
        // إذا كان emp.tagemployee يأتي كمصفوفة IDs فقط: نضعها مباشرة
        // إذا كان يأتي كمصفوفة كائنات [{_id, name}, ...]: نستخلص الـ _id
        if (Array.isArray(emp.tagemployee)) {
          const tagsIds = emp.tagemployee.map(t => (typeof t === 'object' ? t._id : t));
          $('#empTagSelect').val(tagsIds).trigger('change');
        } else {
          $('#empTagSelect').val([]).trigger('change');
        }
        showEmployeeModal();
      }

      // إظهار/إخفاء اختيار الشفت
      function onScheduleModeChange() {
        const scheduleMode = document.getElementById('scheduleModeSel').value;
        if (scheduleMode === 'shift') {
          document.getElementById('shiftSelectContainer').style.display = 'block';
        } else {
          document.getElementById('shiftSelectContainer').style.display = 'none';
        }
      }

      async function saveEmployee() {
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        const dbId = document.getElementById('employeeDbId').value;
        let enrollId = document.getElementById('enrollId').value.trim();
        const empName = document.getElementById('empName').value.trim();
        const departmentId = document.getElementById('empDepartment').value;
        const selectedBranch = document.getElementById('empBranch').value;
        const depObj = allDepartments.find(d => d._id === departmentId);
        const depName = depObj ? depObj.department_name : '';
        const joinD = document.getElementById('empJoinDate').value || null;
        const leaveD = document.getElementById('empLeaveDate').value || null;
        const mainSal = +document.getElementById('mainSalary').value || 0;
        const weekZoneVal = document.getElementById('weekZone').value;
        let weekZoneNum = weekZoneVal ? +weekZoneVal : 0;
        const worksForSegmentedTime = document.getElementById('worksForSegmentedTime').checked;
        const empCard = document.getElementById('empCard').value.trim();
        const selectedTags = $('#empTagSelect').val() || [];
        // الجديد
        const scheduleMode = document.getElementById('scheduleModeSel').value;
        const selectedShiftId = document.getElementById('empShiftSelect').value || null;

        if (!enrollId) {
          enrollId = generateUniqueEnrollId();
        }
        let imageBase64 = '';
        const fileInput = document.getElementById('empImage');
        if (fileInput.files && fileInput.files.length > 0) {
          const file = fileInput.files[0];
          imageBase64 = await fileToBase64(file);
        }
        const bodyObj = {
          enroll_id: enrollId,
          name: empName,
          department_id: departmentId,
          department: depName,
          joining_date: joinD,
          branch: selectedBranch,
          leave_date: leaveD,
          main_salary: mainSal,
          week_zone: weekZoneNum,
          card: empCard
        };
        bodyObj.works_for_segmented_time = worksForSegmentedTime;

        if (!dbId) {
          const password = document.getElementById('password').value.trim();
          const username = document.getElementById('username').value.trim();
          bodyObj.password = password;
          bodyObj.username = username;
        }

        if (imageBase64) {
          bodyObj.image = await resizeImg(imageBase64, 480, 640);
        }

        bodyObj.scheduleMode = scheduleMode;
        if (scheduleMode === 'shift' && selectedShiftId) {
          bodyObj.shift_id = selectedShiftId;
        } else {
          bodyObj.shift_id = null;
        }

        // هنا الجزء الجديد: نجلب قيم التاكات المحددة من الـ select المتعدد
        bodyObj.tagemployee = selectedTags;
        // (مصفوفة IDs فقط)


        try {
          let url = '/api/employees';
          let method = 'POST';
          
          if (dbId) {
           

            url = `/api/employees/${dbId}`;
            method = 'PUT';
          }
          const resp = await fetch(url, {
            method,
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(bodyObj)
          });
          if (!resp.ok) throw new Error(getTranslate(dbId ? "edit_emp_err" : "add_emp_err"));
          successMsg.textContent = getTranslate('success_msg');
          closeEmployeeModal();
          loadEmployees();
        } catch (err) {
          errorMsg.textContent = err.message;
        }
      }

      async function checkUsername() {
        const errMsg = document.getElementById('err_msg')
        const saveBtn = document.getElementById('saveEmployeeBtn')
        const errorMsg = document.getElementById('errorMsg');

        const input = document.getElementById('username')
        input.value = input.value.trim()
        const inputValue = input.value

        if (!inputValue) {
          errMsg.style.display = 'none'
          saveBtn.style.pointerEvents = 'auto'
          return saveBtn.style.opacity = 1
        }

        try {
          const resp = await fetch(`/api/employees/check-username?username=${inputValue}`, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          const respons = await resp.json()
          if (respons.exists) {
            errMsg.style.display = 'block'
            saveBtn.style.pointerEvents = 'none'
            return saveBtn.style.opacity = .5
          } else {
            errMsg.style.display = 'none'
            saveBtn.style.pointerEvents = 'auto'
            return saveBtn.style.opacity = 1
          }
        } catch (err) {
          errorMsg.textContent = err.message;
        }
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = (err) => reject(err);
          reader.readAsDataURL(file);
        });
      }

      async function resizeImg(base64, width, height) {
        return new Promise((resolve, reject) => {
          const img = new Image()
          img.src = base64
          img.onload = function () {
            const canvas = document.createElement('canvas')
            const ctx = canvas.getContext('2d')
            canvas.width = width
            canvas.height = height
            ctx.drawImage(img, 0, 0, width, height)
            const resizedBase64 = canvas.toDataURL('image/jpeg', 1)
            resolve(resizedBase64)
          }
        })
      }

      function generateUniqueEnrollId() {
        while (true) {
          let randId = Math.floor(Math.random() * 90000) + 10000;
          let used = allEmployees.some(e => +e.enroll_id === randId);
          if (!used) return randId.toString();
        }
      }

      // حذف الموظف
      async function deleteEmployee(dbId) {
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';

        if (!confirm(getTranslate("confirm_delete_employee"))) return;

        const emp = allEmployees.find(e => e._id === dbId);
        if (!emp) {
          errorMsg.textContent = "Employee not found.";
          return;
        }

        const deleteFromDevices = confirm("هل تريد حذف الموظف أيضاً من الأجهزة؟");

        showLoader();
        try {
          const resp = await fetch(`/api/employees/${dbId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error(getTranslate('delete_emp_err'));

          if (deleteFromDevices && emp.devices && emp.devices.length) {
            for (const devId of emp.devices) {
              const dev = allDevices.find(d => d._id === devId);
              if (!dev) continue;
              const sn = dev.serial;
              const serverIp = dev.serverip;
              const enrollid = isNumber(emp.enroll_id) ? +emp.enroll_id : emp.enroll_id;

              const bodyObj = {
                sn: sn,
                enrollid: enrollid,
                backupnum: 50
              };
              const url = `${serverIp}/events/deleteuser`;

              const delResp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyObj)
              });

              if (!delResp.ok) {
                const commandBody = {
                  url: url,
                  body: bodyObj,
                  ActionType: "DeleteUser",
                  device_name: dev.name || sn,
                  operation_type: "deleteuser"
                };
                await saveCommand(commandBody);
              }
            }
          }

          successMsg.textContent = "تم الحذف";
          loadEmployees();
        } catch (err) {
          errorMsg.textContent = err.message;
        } finally {
          hideLoader();
        }
      }

      function openScheduleModal(indexInFiltered) {
        document.getElementById('templateSelect').value = ''
        if (indexInFiltered != -1) {
          const emp = filteredEmployees[indexInFiltered];
          if (emp.weekSchedulesId) document.getElementById('templateSelect').value = emp.weekSchedulesId
          currentEmployeeIndex = findEmployeeIndexInAll(emp._id);
          currentSchedules = emp.weekSchedules || [];
          renderSchedule(currentSchedules);
          return showScheduleModal();
        }
        currentSchedules = []
        renderSchedule([]);
        showScheduleModal();
      }

      function findEmployeeIndexInAll(id) {
        return allEmployees.findIndex(e => e._id === id);
      }

      function emp_modal_renderSchedule(sch) {
        const tb = document.getElementById('emp_modal_scheduleTable').querySelector('tbody');
        tb.innerHTML = '';
        sch.forEach((dayObj, i) => {
          let row = document.createElement('tr');
          row.innerHTML =
            `<td>${dayObj.day || ''}</td>
          <td>${dayObj.startTime || ''}</td>
          <td>${dayObj.endTime || ''}</td>
          <td>${dayObj.overtimeStart || ''}</td>
          <td>${dayObj.endDayOffset || 0}</td>
          <td>${dayObj.hourPrice || 0}</td>
          <td>${dayObj.overtimePrice || 0}</td>
          <td><button class="btnSmall" style="background:#007bff;color:#fff;" onclick="openDayModal(${i})">Edit</button></td>
          <td><button class="btnSmall" style="background:#dc3545;color:#fff;" onclick="deleteDay(${i})">Del</button></td>
          <td><button class="btnSmall" style="background:#17a2b8;color:#fff;" onclick="copyDay(${i})">Copy</button></td>`;
          tb.appendChild(row);
        });
      }

      function renderSchedule(sch) {
        const tb = document.getElementById('scheduleTable').querySelector('tbody');
        tb.innerHTML = '';
        sch.forEach((dayObj, i) => {
          let row = document.createElement('tr');
          row.innerHTML =
            `<td>${dayObj.day || ''}</td>
          <td>${dayObj.startTime || ''}</td>
          <td>${dayObj.endTime || ''}</td>
          <td>${dayObj.overtimeStart || ''}</td>
          <td>${dayObj.endDayOffset || 0}</td>
          <td>${dayObj.hourPrice || 0}</td>
          <td>${dayObj.overtimePrice || 0}</td>
          <td><button class="btnSmall" style="background:#007bff;color:#fff;" onclick="openDayModal(${i})">Edit</button></td>
          <td><button class="btnSmall" style="background:#dc3545;color:#fff;" onclick="deleteDay(${i})">Del</button></td>
          <td><button class="btnSmall" style="background:#17a2b8;color:#fff;" onclick="copyDay(${i})">Copy</button></td>`;
          tb.appendChild(row);
        });
      }

      function addScheduleDay(isRest = false) {
        const dayOrder = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        if (!isRest && currentSchedules.length) return copyDay(currentSchedules.length - 1)

        if (currentSchedules.length === 0) {
          currentSchedules.push({
            day: 'Sun',
            startTime: isRest ? '00:00:00' : '09:00:00',
            endTime: isRest ? '00:00:00' : '17:00:00',
            overtimeStart: isRest ? '00:00:00' : '17:30:00',
            endDayOffset: 0,
            hourPrice: 0,
            overtimePrice: 0,
            allowed_delay_minutes: 0,
            allowed_exit_minutes: 0,
            official_working_hours: 8,
            late_cutting_by_count: 0,
            absent_cutting: 0,
            daily_salary: 0,
            early_cutting_by_count: 0,
            late_min_prices: 0,
            early_min_prices: 0,
            minimum_working_hours_overtime: 10,
            work_registration_start_time: '00:00:00',
            last_entry_prevention_time: '23:59:00',
            first_exit_allowed_time: '00:00:00',
            last_exit_allowed_time: '23:59:00',
            works_for_daily_wage: false,
            overtime_eligible: false,
            allowed_min_rest: 0,
            rest_min_prices: 0,
            startTime_Offset: 0,
            endTime_Offset: 0,
            overtimeStart_Offset: 0,
            work_registration_start_time_Offset: 0,
            last_entry_prevention_time_Offset: 0,
            first_exit_allowed_time_Offset: 0,
            last_exit_allowed_time_Offset: 0
          });
        } else {
          const lastDayObj = currentSchedules[currentSchedules.length - 1];
          const dayOrderIndex = dayOrder.indexOf(lastDayObj.day);
          if (dayOrderIndex < 0) {
            alert('Unknown day');
            return;
          }
          if (dayOrderIndex === 6) {
            alert(getTranslate("last_day"));
            return;
          }
          let newDayObj = { ...lastDayObj };
          newDayObj.day = dayOrder[dayOrderIndex + 1];
          newDayObj.startTime = isRest ? '00:00:00' : '09:00:00'
          newDayObj.endTime = isRest ? '00:00:00' : '17:00:00'
          newDayObj.overtimeStart = isRest ? '00:00:00' : '17:30:00'
          currentSchedules.push(newDayObj);
        }
        renderSchedule(currentSchedules);
        emp_modal_renderSchedule(currentSchedules);
      }

      function deleteDay(i) {
        if (!confirm(getTranslate("delete_day"))) return;
        currentSchedules.splice(i, 1);
        renderSchedule(currentSchedules);
        emp_modal_renderSchedule(currentSchedules);
      }

      function openDayModal(i) {
        dayIndex = i;
        const dayObj = currentSchedules[i];
        document.getElementById('dayModalTitle').setAttribute('data-lng', 'lblDayModalTitle');
        document.getElementById('dayIndex').value = i;
        document.getElementById('daySelect').value = dayObj.day || 'Sun';
        document.getElementById('dayStart').value = dayObj.startTime || '09:00:00';
        document.getElementById('dayEnd').value = dayObj.endTime || '17:00:00';
        document.getElementById('dayOTStart').value = dayObj.overtimeStart || '17:30:00';
        document.getElementById('dayOffset').value = dayObj.endDayOffset || 0;
        document.getElementById('dayHourPrice').value = dayObj.hourPrice || 0;
        document.getElementById('dayOTPrice').value = dayObj.overtimePrice || 0;
        document.getElementById('dayAllowedDelay').value = dayObj.allowed_delay_minutes || 0;
        document.getElementById('dayAllowedExit').value = dayObj.allowed_exit_minutes || 0;
        document.getElementById('dayOfficialHours').value = dayObj.official_working_hours || 8;
        document.getElementById('dayLateCutCount').value = dayObj.late_cutting_by_count || 0;
        document.getElementById('dayAbsentCut').value = dayObj.absent_cutting || 0;
        document.getElementById('dayDailySalary').value = dayObj.daily_salary || 0;
        document.getElementById('dayEarlyCutCount').value = dayObj.early_cutting_by_count || 0;
        document.getElementById('dayLateMinPrice').value = dayObj.late_min_prices || 0;
        document.getElementById('dayEarlyMinPrice').value = dayObj.early_min_prices || 0;
        document.getElementById('dayMinOTHours').value = dayObj.minimum_working_hours_overtime || 10;
        document.getElementById('dayWrStart').value = dayObj.work_registration_start_time || '00:00:00';
        document.getElementById('dayLastEntry').value = dayObj.last_entry_prevention_time || '23:59:00';
        document.getElementById('dayFirstExit').value = dayObj.first_exit_allowed_time || '00:00:00';
        document.getElementById('dayLastExit').value = dayObj.last_exit_allowed_time || '23:59:00';
        document.getElementById('dayDailyWage').value = dayObj.works_for_daily_wage ? 'true' : 'false';
        document.getElementById('dayOTEligible').value = dayObj.overtime_eligible ? 'true' : 'false';
        document.getElementById('dayAllowedMinRest').value = dayObj.allowed_min_rest || 0;
        document.getElementById('dayRestMinPrice').value = dayObj.rest_min_prices || 0;
        document.getElementById('startTime_Offset').value = dayObj.startTime_Offset || 0;
        document.getElementById('endTime_Offset').value = dayObj.endTime_Offset || 0;
        document.getElementById('overtimeStart_Offset').value = dayObj.overtimeStart_Offset || 0;
        document.getElementById('work_registration_start_time_Offset').value = dayObj.work_registration_start_time_Offset || 0;
        document.getElementById('last_entry_prevention_time_Offset').value = dayObj.last_entry_prevention_time_Offset || 0;
        document.getElementById('first_exit_allowed_time_Offset').value = dayObj.first_exit_allowed_time_Offset || 0;
        document.getElementById('last_exit_allowed_time_Offset').value = dayObj.last_exit_allowed_time_Offset || 0;
        showDayModal();
      }

      function saveDay() {
        const i = +document.getElementById('dayIndex').value;
        const dayObj = currentSchedules[i];
        dayObj.day = document.getElementById('daySelect').value;
        dayObj.startTime = document.getElementById('dayStart').value;
        dayObj.endTime = document.getElementById('dayEnd').value;
        dayObj.overtimeStart = document.getElementById('dayOTStart').value;
        dayObj.endDayOffset = +document.getElementById('dayOffset').value;
        dayObj.hourPrice = +document.getElementById('dayHourPrice').value;
        dayObj.overtimePrice = +document.getElementById('dayOTPrice').value;
        dayObj.allowed_delay_minutes = +document.getElementById('dayAllowedDelay').value;
        dayObj.allowed_exit_minutes = +document.getElementById('dayAllowedExit').value;
        dayObj.official_working_hours = +document.getElementById('dayOfficialHours').value;
        dayObj.late_cutting_by_count = +document.getElementById('dayLateCutCount').value;
        dayObj.absent_cutting = +document.getElementById('dayAbsentCut').value;
        dayObj.daily_salary = +document.getElementById('dayDailySalary').value;
        dayObj.early_cutting_by_count = +document.getElementById('dayEarlyCutCount').value;
        dayObj.late_min_prices = +document.getElementById('dayLateMinPrice').value;
        dayObj.early_min_prices = +document.getElementById('dayEarlyMinPrice').value;
        dayObj.minimum_working_hours_overtime = +document.getElementById('dayMinOTHours').value;
        dayObj.work_registration_start_time = document.getElementById('dayWrStart').value;
        dayObj.last_entry_prevention_time = document.getElementById('dayLastEntry').value;
        dayObj.first_exit_allowed_time = document.getElementById('dayFirstExit').value;
        dayObj.last_exit_allowed_time = document.getElementById('dayLastExit').value;
        dayObj.works_for_daily_wage = (document.getElementById('dayDailyWage').value === 'true');
        dayObj.overtime_eligible = (document.getElementById('dayOTEligible').value === 'true');
        dayObj.allowed_min_rest = +document.getElementById('dayAllowedMinRest').value;
        dayObj.rest_min_prices = +document.getElementById('dayRestMinPrice').value;

        dayObj.startTime_Offset = +document.getElementById('startTime_Offset').value;
        dayObj.endTime_Offset = +document.getElementById('endTime_Offset').value;
        dayObj.overtimeStart_Offset = +document.getElementById('overtimeStart_Offset').value;
        dayObj.work_registration_start_time_Offset = +document.getElementById('work_registration_start_time_Offset').value;
        dayObj.last_entry_prevention_time_Offset = +document.getElementById('last_entry_prevention_time_Offset').value;
        dayObj.first_exit_allowed_time_Offset = +document.getElementById('first_exit_allowed_time_Offset').value;
        dayObj.last_exit_allowed_time_Offset = +document.getElementById('last_exit_allowed_time_Offset').value;
        renderSchedule(currentSchedules);
        emp_modal_renderSchedule(currentSchedules);
        closeDayModal();
      }

      function copyDay(i) {
        const dayOrder = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        let currentDayObj = currentSchedules[i];
        let currentDayIndex = dayOrder.indexOf(currentDayObj.day);
        if (currentDayIndex < 0) {
          alert(getTranslate("can_not_copy"));
          return;
        }
        if (currentDayIndex === 6) {
          alert(getTranslate('can_not_copy_sat'));
          return;
        }
        let newDayObj = { ...currentSchedules[i] };
        newDayObj.day = dayOrder[currentDayIndex + 1];
        currentSchedules.splice(i + 1, 0, newDayObj);
        renderSchedule(currentSchedules);
        emp_modal_renderSchedule(currentSchedules);
      }

      function closeScheduleModal() {
        document.getElementById('scheduleModal').style.display = 'none';
        openModalFromSellection = false
        openModalFromAllSellection = false
        loadEmployees()
      }

      async function saveScheduleToEmployeeModal() {
        const emp = allEmployees[currentEmployeeIndex];
        emp.weekSchedules = currentSchedules;

        try {
          const resp = await fetch(`/api/employees/${emp._id}`, {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(emp)
          });
          if (!resp.ok) throw new Error('Failed to save schedule');
          alert(getTranslate("success_msg"))
        } catch (err) {
          alert(err.message)
        }
      }

      async function saveScheduleToEmployee() {
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        if (openModalFromSellection) {
          await saveScheduleToMultiEmployee(errorMsg, successMsg)
        } else {
          const emp = allEmployees[currentEmployeeIndex];
          emp.weekSchedules = currentSchedules;
          const weekSchedulesId = document.getElementById('templateSelect').value
          if (weekSchedulesId) emp.weekSchedulesId = weekSchedulesId

          try {
            const resp = await fetch(`/api/employees/${emp._id}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(emp)
            });
            if (!resp.ok) throw new Error('Failed to save schedule');
            successMsg.textContent = getTranslate("success_msg");
          } catch (err) {
            errorMsg.textContent = err.message;
          }
        }
        closeScheduleModal()
      }

      async function saveScheduleToMultiEmployee(errMsgEl, successMsgEl) {
        const body = { update: { weekSchedules: currentSchedules } }
        openModalFromAllSellection ? body.all = true : body.ids = sellectedEmployees
        const weekSchedulesId = document.getElementById('templateSelect').value
        if (weekSchedulesId) body.weekSchedulesId = weekSchedulesId

        try {
          const resp = await fetch(`/api/employees/multi-update`, {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });
          if (!resp.ok) throw new Error('Failed to save schedule');
          successMsgEl.textContent = getTranslate("success_msg");
        } catch (err) {
          errMsgEl.textContent = err.message;
        }
      }

      async function loadTemplates() {
        try {
          const resp = await fetch('/api/weekSchedule-templates', {
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!resp.ok) throw new Error(getTranslate('templates_msg_error_fetch'));
          const data = await resp.json();
          templates = data;
          renderTemplates();
        } catch (err) {
          const errorMsg = document.getElementById('errorMsg');
          const successMsg = document.getElementById('successMsg');
          errorMsg.style.display = 'block'
          errorMsg.textContent = err.message;
          successMsg.style.display = 'none';
        }
      }

      function renderTemplates() {
        const templatesSelect = document.getElementById('templateSelect');
        templatesSelect.innerHTML = '';
        const optEmpty = document.createElement('option');
        optEmpty.value = '';
        optEmpty.textContent = translations["choose_template"] || 'Choose Template';
        templatesSelect.appendChild(optEmpty);

        templates.forEach(tem => {
          const opt = document.createElement('option');
          opt.value = tem._id;
          opt.textContent = tem.name;
          templatesSelect.appendChild(opt);
        });
      }

      function applyTemplate(ev) {
        const choosedTemplate = templates.filter(tem => tem._id == ev.target.value)[0]
        if (!choosedTemplate) return
        currentSchedules = [...choosedTemplate.weekSchedules]
        renderSchedule(currentSchedules)
      }

      function showLoader() { document.getElementById('loaderOverlay').style.display = 'flex'; }
      function hideLoader() { document.getElementById('loaderOverlay').style.display = 'none'; }

      function openDevicesModal(indexInFiltered) {
        multiDevices = false;
        const emp = filteredEmployees[indexInFiltered];
        currentEmployeeIndex = findEmployeeIndexInAll(emp._id);
        document.getElementById('devicesModalTitle').setAttribute('data-lng', 'lblDevicesModalTitle');
        const chosenDevices = emp.devices || [];
        $('#devicesSelect').val(chosenDevices).trigger('change');
        showDevicesModal();
      }

      function openDevicesModalForSelected() {
        if (!sellectedEmployees.length) return;
        multiDevices = true;
        selectedEmployeesForDevices = [...sellectedEmployees];
        document.getElementById('devicesModalTitle').innerText = 'Assign Devices';
        $('#devicesSelect').val([]).trigger('change');
        showDevicesModal();
      }

      function openDepartmentsModalForSelected() {
        if (!sellectedEmployees.length) return;
        selectedEmployeesForDepartments = [...sellectedEmployees];
        $('#departmentsSelect').val([]).trigger('change');
        showDepartmentsModal();
      }

      function openBranchesModalForSelected() {
        if (!sellectedEmployees.length) return;
        selectedEmployeesForBranches = [...sellectedEmployees];
        $('#branchesSelect').val([]).trigger('change');
        showBranchesModal();
      }

      function showBranchesModal() {
        document.getElementById('branchesModal').style.display = 'flex';
      }

      function showDepartmentsModal() {
        document.getElementById('departmentsModal').style.display = 'flex';
      }


      function closeBranchesModal() {
        document.getElementById('branchesModal').style.display = 'none';
        selectedEmployeesForBranches = [];
      }

      function closeDepartmentsModal() {
        document.getElementById('departmentsModal').style.display = 'none';
        selectedEmployeesForDepartments = [];
      }

      function showDevicesModal() {
        document.getElementById('devicesModal').style.display = 'flex';
      }
      function closeDevicesModal() {
        document.getElementById('devicesModal').style.display = 'none';
        multiDevices = false;
        selectedEmployeesForDevices = [];
      }

      function selectAllDevicesInModal() {
        const allDeviceIds = allDevices.map(d => d._id);
        $('#devicesSelect').val(allDeviceIds).trigger('change');
      }

      function selectAllDevicesInEmployeeModal() {
        const allDeviceIds = allDevices.map(d => d._id);
        $('#emp_modal_devices_select').val(allDeviceIds).trigger('change');
      }

      async function saveEmployeeDevices() {
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        const selectedDevices = $('#devicesSelect').val() || [];

        if (multiDevices) {
          showLoader();
          try {
            for (const empId of selectedEmployeesForDevices) {
              const empObj = allEmployees.find(e => e._id === empId);
              if (!empObj) continue;
              empObj.devices = selectedDevices;
              await fetch(`/api/employees/${empObj._id}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'Bearer ' + authToken,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(empObj)
              });
            }
            successMsg.textContent = getTranslate("success_msg");
          } catch (err) {
            errorMsg.textContent = err.message;
          } finally {
            hideLoader();
            closeDevicesModal();
            loadEmployees();
          }
        } else {
          const emp = allEmployees[currentEmployeeIndex];
          emp.devices = selectedDevices;
          try {
            const resp = await fetch(`/api/employees/${emp._id}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(emp)
            });
            if (!resp.ok) throw new Error('Failed to save devices');
            successMsg.textContent = getTranslate("success_msg");
            closeDevicesModal();
            loadEmployees();
          } catch (err) {
            errorMsg.textContent = err.message;
          }
        }
      }

      async function saveEmployeeDepartment() {

        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';

        const selectedDepartment = $('#departmentsSelect').val() || "";
        if(selectedDepartment!=""){
           const depObj = allDepartments.find(d => d._id === selectedDepartment);
           const depName = depObj ? depObj.department_name : '';
           
           const bodyObj = {
                      department_id: selectedDepartment,
                      department: depName,
              };

              await saveDepartmentToEmployees(selectedEmployeesForDepartments, bodyObj);
              closeDepartmentsModal();
              loadEmployees();
            }
      }

      async function saveEmployeeBranch() {

          const errorMsg = document.getElementById('errorMsg');
          const successMsg = document.getElementById('successMsg');
          errorMsg.textContent = '';
          successMsg.textContent = '';

          const selectedBranch = $('#branchesSelect').val() || "";

          if(selectedBranch!=""){
            
            const bodyObj = {
                        branch: selectedBranch,
                };

                await saveBranchToEmployees(selectedEmployeesForBranches, bodyObj);
                closeBranchesModal();
                loadEmployees();
              }
          }


      async function saveDepartmentToEmployees(selectedEmployeesForDepartments, bodyObj){
        for(let i=0; i<selectedEmployeesForDepartments.length; i++){
          try {
              const url = `/api/employees/${selectedEmployeesForDepartments[i]}`;
              const method = 'PUT';
              const resp = await fetch(url, {
                            method,
                            headers: {
                              'Authorization': 'Bearer ' + authToken,
                              'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(bodyObj)
                });
            if (!resp.ok) throw new Error('Failed to save department');
              successMsg.textContent = getTranslate("success_msg");
                
              } catch (err) {
                errorMsg.textContent = err.message;
              }            
        }
      }

      async function saveBranchToEmployees(selectedBranchesForDepartments, bodyObj){
        for(let i=0; i<selectedBranchesForDepartments.length; i++){
          try {
              const url = `/api/employees/${selectedBranchesForDepartments[i]}`;
              const method = 'PUT';
              const resp = await fetch(url, {
                            method,
                            headers: {
                              'Authorization': 'Bearer ' + authToken,
                              'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(bodyObj)
                });
            if (!resp.ok) throw new Error('Failed to save department');
              successMsg.textContent = getTranslate("success_msg");
                
              } catch (err) {
                errorMsg.textContent = err.message;
              }            
        }
      }

      async function saveEmployeeDevicesInEmpModal() {

        const selectedDevices = $('#emp_modal_devices_select').val() || [];

        try {

          const empId = document.getElementById('employeeDbId').value;

          const empObj = allEmployees.find(e => e._id === empId);

          empObj.devices = selectedDevices;

          await fetch(`/api/employees/${empObj._id}`, {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(empObj)

          });

          alert("Device Saved Successfully");

        } catch (err) {
          alert(err.message)
        }
      }

      let faceModalIndex = null;
      function openFaceModal(indexInFiltered) {
        faceModalIndex = indexInFiltered;
        const faceSelect = document.getElementById('faceDeviceSelect');
        faceSelect.innerHTML = '';
        allDevices.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d._id;
          opt.textContent = d.name || `Device ${d._id}`;
          faceSelect.appendChild(opt);
        });
        document.getElementById('faceAdminCheckbox').checked = false;
        document.getElementById('faceModal').style.display = 'flex';
      }

      function closeFaceModal() {
        document.getElementById('faceModal').style.display = 'none';
        faceModalIndex = null;
      }

      async function captureFace() {
        if (faceModalIndex == null) return;
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        showLoader();
        try {
          const emp = filteredEmployees[faceModalIndex];
          const selectedDeviceId = document.getElementById('faceDeviceSelect').value;
          const faceAdmin = document.getElementById('faceAdminCheckbox').checked;
          if (!selectedDeviceId) {
            throw new Error('Select device first');
          }
          const dev = allDevices.find(d => d._id === selectedDeviceId);
          if (!dev) throw new Error('Device not found');
          const sn = dev.serial;
          const bodyObj = {
            sn: sn,
            userInfo: {
              enrollid: isNumber(emp.enroll_id) ? +emp.enroll_id : emp.enroll_id,
              name: emp.name || '',
              backupnum: 50,
              admin: faceAdmin ? 1 : 0
            }
          };
          const resp = await fetch('http://127.0.0.1:3087/api/adduserinfo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyObj)
          });
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('Capture request failed: ' + txt);
          }
          const result = await resp.json();
          if (!result.success) {
            throw new Error('Operation failed on device');
          }
          const recordBase64 = result.data ?.record;
          if (!recordBase64) {
            throw new Error('No face image received from device');
          }
          const newImage = 'data:image/jpeg;base64,' + recordBase64;
          const updateBody = { image: newImage };
          const updateResp = await fetch(`/api/employees/${emp._id}`, {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateBody)
          });
          if (!updateResp.ok) throw new Error('DB update fail');

          successMsg.textContent = getTranslate("success_msg");
          closeFaceModal();
          loadEmployees();
        } catch (err) {
          errorMsg.textContent = err.message;
        } finally {
          hideLoader();
        }
      }

      let fingerModalIndex = null;
      function openFingerModal(indexInFiltered) {
        fingerModalIndex = indexInFiltered;
        const fingerSelect = document.getElementById('fingerDeviceSelect');
        fingerSelect.innerHTML = '';
        allDevices.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d._id;
          opt.textContent = d.name || `Device ${d._id}`;
          fingerSelect.appendChild(opt);
        });
        document.getElementById('fingerModal').style.display = 'flex';
      }

      function closeFingerModal() {
        document.getElementById('fingerModal').style.display = 'none';
        fingerModalIndex = null;
      }

      async function captureFinger() {
        if (fingerModalIndex == null) return;
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        showLoader();
        try {
          const emp = filteredEmployees[fingerModalIndex];
          const selectedDeviceId = document.getElementById('fingerDeviceSelect').value;
          if (!selectedDeviceId) {
            throw new Error('Select device first');
          }
          const dev = allDevices.find(d => d._id === selectedDeviceId);
          if (!dev) throw new Error('Device not found');
          const sn = dev.serial;
          const bodyObj = {
            sn: sn,
            userInfo: {
              enrollid: isNumber(emp.enroll_id) ? +emp.enroll_id : emp.enroll_id,
              name: emp.name || '',
              backupnum: 0
            }
          };
          const resp = await fetch('http://127.0.0.1:3087/api/adduserinfo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyObj)
          });
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('Capture request failed: ' + txt);
          }
          const result = await resp.json();
          if (!result.success) {
            throw new Error('Operation failed on device');
          }
          const recordData = result.data ?.record;
          if (!recordData) {
            throw new Error('No fingerprint data received from device');
          }
          const updateBody = { fingerprint: recordData };
          const updateResp = await fetch(`/api/employees/${emp._id}`, {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateBody)
          });
          if (!updateResp.ok) throw new Error('DB update fail');

          successMsg.textContent = getTranslate("success_msg");
          closeFingerModal();
          loadEmployees();
        } catch (err) {
          errorMsg.textContent = err.message;
        } finally {
          hideLoader();
        }
      }

      let cardModalIndex = null;
      function openCardModal(indexInFiltered) {
        cardModalIndex = indexInFiltered;
        const cardSelect = document.getElementById('cardDeviceSelect');
        cardSelect.innerHTML = '';
        allDevices.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d._id;
          opt.textContent = d.name || `Device ${d._id}`;
          cardSelect.appendChild(opt);
        });
        document.getElementById('cardModal').style.display = 'flex';
      }

      function closeCardModal() {
        document.getElementById('cardModal').style.display = 'none';
        cardModalIndex = null;
      }

      async function captureCard() {
        if (cardModalIndex == null) return;
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';
        showLoader();
        try {
          const emp = filteredEmployees[cardModalIndex];
          const selectedDeviceId = document.getElementById('cardDeviceSelect').value;
          if (!selectedDeviceId) throw new Error('Select device first');
          const dev = allDevices.find(d => d._id === selectedDeviceId);
          if (!dev) throw new Error('Device not found');
          const sn = dev.serial;
          const bodyObj = {
            sn: sn,
            userInfo: {
              enrollid: isNumber(emp.enroll_id) ? +emp.enroll_id : emp.enroll_id,
              name: emp.name || '',
              backupnum: 11
            }
          };
          const resp = await fetch('http://127.0.0.1:3087/api/adduserinfo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyObj)
          });
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('Card read request failed: ' + txt);
          }
          const result = await resp.json();
          if (!result.success) {
            throw new Error('Operation failed on device');
          }
          const cardNum = result.data ?.record;
          if (!cardNum) {
            throw new Error('No card number received from device');
          }
          const updateBody = { card: cardNum };
          const updateResp = await fetch(`/api/employees/${emp._id}`, {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + authToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateBody)
          });
          if (!updateResp.ok) throw new Error('Fail to save card in DB');

          successMsg.textContent = getTranslate("success_msg");
          closeCardModal();
          loadEmployees();
        } catch (err) {
          errorMsg.textContent = err.message;
        } finally {
          hideLoader();
        }
      }

      function showEmployeeModal() {
        document.getElementById('employeeModal').style.display = 'flex';
        // افتراضًا نجعل الـ Private Info Tab هو المفتوح افتراضيًا
        // switchEmployeeModalTab(null, 'privateInfoTab');
        switchEmployeeModalTab(null, 'devicesTab');
      }

      function closeEmployeeModal() {
        document.getElementById('employeeModal').style.display = 'none';
        document.getElementById('employeeDbId').value = '';
        document.getElementById('enrollId').value = '';
        document.getElementById('empName').value = '';
        $('#empDepartment').val('').trigger('change');
        document.getElementById('empJoinDate').value = '';
        document.getElementById('empLeaveDate').value = '';
        document.getElementById('mainSalary').value = '0';
        document.getElementById('weekZone').value = '';
        document.getElementById('empImage').value = '';
        document.getElementById('previewEmpImage').src = './images/no_image.png';
        document.getElementById('empCard').value = '';
      }

      // التبويبات داخل مودال الموظف
      function switchEmployeeModalTab(evt, tabId) {
        const allTabs = document.querySelectorAll('.employeeModalTab');
        const allContents = document.querySelectorAll('.employeeModalTabContent');
        allTabs.forEach(t => t.classList.remove('active'));
        allContents.forEach(c => c.classList.remove('active'));

        if (tabId) {
          document.getElementById(tabId).classList.add('active');

        }
        if (evt && evt.currentTarget) {
          evt.currentTarget.classList.add('active');
          // console.log(evt.currentTarget.classList)
        }


        if (tabId === "devicesTab") {
          let chosenDevices = [];


          document.getElementById("devices_tab_item").classList.add('active')

          const dbId = document.getElementById('employeeDbId').value;
          if (dbId != "") {
            const emp = filteredEmployees[findEmployeeIndexInAll(dbId)];
            currentEmployeeIndex = findEmployeeIndexInAll(emp._id);

            chosenDevices = emp.devices || [];

          } else {
            chosenDevices = [];
          }

          $('#emp_modal_devices_select').val(chosenDevices).trigger('change');

        }
        if (tabId === "scheduleTab") {
          const dbId = document.getElementById('employeeDbId').value;

          currentEmployeeIndex = findEmployeeIndexInAll(dbId);

          const emp = filteredEmployees[currentEmployeeIndex];

          currentSchedules = emp.weekSchedules || [];

          emp_modal_renderSchedule(currentSchedules);


        }
      }

      function showScheduleModal() {
        document.getElementById('scheduleModal').style.display = 'flex';
      }

      function showDayModal() {
        document.getElementById('dayModal').style.display = 'flex';
      }

      function closeDayModal() {
        document.getElementById('dayModal').style.display = 'none';
        dayIndex = null;
        document.getElementById('dayIndex').value = '';
      }

      function exportEmployeesToExcel() {
        try {
          const sheetData = [];
          sheetData.push([
            "enroll_id",
            "name",
            "department_id",
            "department",
            "joining_date",
            "leave_date",
            "main_salary",
            "week_zone",
            "card"
          ]);

          allEmployees.forEach(emp => {
            sheetData.push([
              emp.enroll_id || '',
              emp.name || '',
              emp.department_id || '',
              emp.department || '',
              emp.joining_date ? emp.joining_date.split('T')[0] : '',
              emp.leave_date ? emp.leave_date.split('T')[0] : '',
              emp.main_salary || 0,
              emp.week_zone || 0,
              emp.card || ''
            ]);
          });

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(sheetData);
          XLSX.utils.book_append_sheet(wb, ws, "Employees");
          XLSX.writeFile(wb, "employees.xlsx");
        } catch (err) {
          console.error("Export error:", err);
          alert("Error exporting to Excel");
        }
      }

      async function importEmployeesFromExcel(event) {
        const file = event.target.files[0];
        if (!file) return;
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';

        showLoader();
        try {
          const reader = new FileReader();
          reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            const header = rows[0];
            const needed = ["enroll_id", "name", "department_id", "department", "joining_date", "leave_date", "main_salary", "week_zone", "card"];
            const sameHeader = JSON.stringify(header) === JSON.stringify(needed);
            if (!sameHeader) {
              alert("صيغة الملف غير مطابقة. يرجى استخدام الملف الذي تم تصديره.");
              hideLoader();
              return;
            }

            const toProcess = rows.slice(1).map(r => {
              return {
                enroll_id: r[0],
                name: r[1],
                department_id: r[2],
                department: r[3],
                joining_date: r[4],
                leave_date: r[5],
                main_salary: r[6],
                week_zone: r[7],
                card: r[8]
              };
            });

            await processImportedEmployees(toProcess);
            successMsg.textContent = "تم الاستيراد بنجاح";
            loadEmployees();
            hideLoader();
          };
          reader.readAsArrayBuffer(file);
        } catch (err) {
          errorMsg.textContent = err.message;
          hideLoader();
        } finally {
          event.target.value = '';
        }
      }

      async function processImportedEmployees(importList) {
        for (let i = 0; i < importList.length; i++) {
          const row = importList[i];
          if (!row.enroll_id) {
            continue;
          }

          let depId = row.department_id;
          let depName = row.department;
          if (!depId && firstDepartmentId) {
            depId = firstDepartmentId;
            depName = firstDepartmentName;
          }

          const existingEmp = allEmployees.find(e => e.enroll_id == row.enroll_id);
          const body = {
            enroll_id: row.enroll_id,
            name: row.name || '',
            department_id: depId || '',
            department: depName || '',
            joining_date: row.joining_date || null,
            leave_date: row.leave_date || null,
            main_salary: +row.main_salary || 0,
            week_zone: +row.week_zone || 0,
            card: row.card || ''
          };

          try {
            let method = 'POST';
            let url = '/api/employees';
            if (existingEmp) {
              method = 'PUT';
              url = `/api/employees/${existingEmp._id}`;
            }
            await fetch(url, {
              method,
              headers: {
                'Authorization': 'Bearer ' + authToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });
          } catch (err) {
            console.error("Error in row", i, err);
          }
        }
      }

      function selectAllInPage() {
        const checkboxes = Array.from(document.querySelectorAll('.em_checkbox'));
        checkboxes.forEach(ch => {
          ch.checked = true;
        });
        sellectedEmployees = checkboxes.map(ch => ch.value);
        document.getElementById('selectedBtn').style.display = 'block';
        document.getElementById('devicesSelectedBtn').style.display = 'block';
        document.getElementById('deleteSelectedBtn').style.display = 'block';
        document.getElementById('departmentSelectedBtn').style.display = 'block';
        document.getElementById('branchSelectedBtn').style.display = 'block';
      }

      async function deleteSelectedEmployees() {
        if (!sellectedEmployees.length) return;
        if (!confirm("Are U Sure From Delete ?")) return;

        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        errorMsg.textContent = '';
        successMsg.textContent = '';

        showLoader();

        try {
          for (const empId of sellectedEmployees) {
            const resp = await fetch(`/api/employees/${empId}`, {
              method: 'DELETE',
              headers: { 'Authorization': 'Bearer ' + authToken }
            });
            if (!resp.ok) {
              const txt = await resp.text();
              console.error("Error deleting", empId, txt);
            }
          }
          successMsg.textContent = "تم الحذف بنجاح";
        } catch (err) {
          errorMsg.textContent = err.message;
        } finally {
          sellectedEmployees = [];
          hideLoader();
          loadEmployees();
        }
      }

      function loadSiebar(){
        fetch('sidebar.html')
              .then(response => response.text())
              .then(data => {
                  document.querySelector('.sidebar').innerHTML = data;
                    var submenus = document.querySelectorAll('.submenu');
                    submenus.forEach(function (submenu) {
                      if (submenu.querySelector('.navItem.active')) {
                        submenu.style.display = "block";
                      }
                    });
                    addActiveToSubmenuClass(1);
              })
              .catch(error => console.error('Error loading sidebar:', error));
      }
  
      async function loadSidebarLangFile(lang) {
        try {
          const response = await fetch(`${LANG_PATH}/${lang}_sidebar.json`);
          if (!response.ok) {
            throw new Error(`Error loading ${lang}_sidebar.json`);
          }
          sidebarLabels = await response.json();

        } catch (error) {
          console.error("Report translation file error:", error);
        }
      }

      function applySidebarTranslation(){
          document.querySelectorAll('.sidebar [data-lng]').forEach(el => {
              const key = el.getAttribute('data-lng');
              
              if (sidebarLabels[key]) {
                el.textContent = sidebarLabels[key];
              }
          });
      }

      loadSiebar();

      function addActiveToSubmenuClass(childIndex) {
          const submenu = document.getElementById('staffManagementSubmenu');
          submenu.style.display = "block";
          const navItems = submenu.getElementsByClassName('navItem');
          if (childIndex >= 1 && childIndex <= navItems.length) {
              Array.from(navItems).forEach(item => item.classList.remove('active'));
              navItems[childIndex - 1].classList.add('active');
          } else {
              console.error('Child index out of bounds');
          }
      }

    </script>
</body>

</html>