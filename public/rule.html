<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <title data-lng="rules_page_title">نظام إدارة الحضور - إدارة القواعد (Rules)</title>

  <!-- خطوط Tajawal (للعربية) وOpen Sans (للإنجليزية) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Open+Sans:wght@400;700&display=swap"
    rel="stylesheet">

  <!-- أيقونات Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    html {
      animation: fadeIn .3s ease-in forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* عند العربية: الخط Tajawal + RTL */
    html[lang="ar"] body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
    }

    /* عند الإنجليزية: الخط Open Sans + LTR */
    html[lang="en"] body {
      font-family: 'Open Sans', sans-serif;
      direction: ltr;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }

    header {
      background: linear-gradient(45deg, #0062cc, #004085);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    header button {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    header button:hover {
      background: #c82333;
    }

    /* اختيار اللغة */
    #langSelector {
      margin-left: 10px;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .container {
      display: flex;
      flex-direction: row-reverse;
      /* عند العربية */
    }

    /* الشريط الجانبي */
    .sidebar {
      width: 240px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      padding: 20px 10px;
    }

    .sidebar h2 {
      margin-bottom: 15px;
      font-size: 1rem;
      text-align: center;
      color: #444;
    }

    .navItem {
      padding: 12px 10px;
      margin: 6px 0;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      font-weight: 500;
      transition: background 0.3s, color 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navItem i {
      font-size: 1.1rem;
      color: #666;
      transition: color 0.3s;
    }

    .navItem:hover {
      background: #f0f0f0;
    }

    .navItem.active {
      background: #007bff;
      color: #fff;
    }

    .navItem.active i {
      color: #fff;
    }

    /* المحتوى الرئيسي */
    .mainContent {
      flex: 1;
      padding: 20px;
    }

    /* رسائل الخطأ والنجاح */
    .errorMsg,
    .successMsg {
      margin: 10px 0;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .errorMsg {
      color: red;
    }

    .successMsg {
      color: green;
    }

    /* زر إضافة قاعدة جديدة */
    .addBtn {
      background: #28a745;
      color: #fff;
      padding: 8px 14px;
      border-radius: 4px;
      margin-bottom: 15px;
      transition: background 0.3s;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
    }

    .addBtn:hover {
      background: #218838;
    }

    /* الجدول */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    table thead {
      background: #007bff;
      color: #fff;
    }

    table th,
    table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    table tbody tr:hover {
      background: #f9f9f9;
    }

    .actionIcon {
      color: #007bff;
      cursor: pointer;
      font-size: 1.1rem;
      margin: 0 6px;
      transition: color 0.3s;
    }

    .actionIcon:hover {
      color: #0056b3;
    }

    /* المودال Overlay */
    .modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modalContent {
      width: 600px;
      max-width: 90%;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: fadeInModal 0.3s ease;
      position: relative;
    }

    @keyframes fadeInModal {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modalHeader {
      background: #007bff;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modalHeader h2 {
      margin: 0;
      font-size: 1rem;
    }

    .modalCloseBtn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.3s;
    }

    .modalCloseBtn:hover {
      color: #ffdddd;
    }

    .modalBody {
      padding: 20px;
    }

    .modalBody label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 500;
    }

    .modalBody input,
    .modalBody select,
    .modalBody textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    .modalActions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 10px 20px;
    }

    .modalSaveBtn,
    .modalCancelBtn {
      border: none;
      border-radius: 4px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s;
    }

    .modalSaveBtn {
      background: #28a745;
      color: #fff;
    }

    .modalSaveBtn:hover {
      background: #218838;
    }

    .modalCancelBtn {
      background: #6c757d;
      color: #fff;
    }

    .modalCancelBtn:hover {
      background: #5a6268;
    }

    /* جداول الشروط والإجراءات */
    .conditionsTable,
    .actionsTable {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
      width: 100%;
    }

    .conditionsTable th,
    .actionsTable th {
      background: #e9ecef;
      text-align: center;
      padding: 8px;
    }

    .conditionsTable td,
    .actionsTable td {
      padding: 6px;
      vertical-align: middle;
      text-align: center;
    }

    .conditionsTable select,
    .actionsTable select {
      width: 100%;
      font-size: 0.85rem;
    }

    .conditionsTable input,
    .actionsTable input {
      width: 100%;
      font-size: 0.85rem;
      padding: 4px;
    }
  </style>
</head>

<body onload="initPage()">

  <header>
    <h1 data-lng="rules_header_title">نظام إدارة الحضور - إدارة القواعد (Rules)</h1>
    <div>
      <button onclick="logout()" data-lng="rules_logout">خروج</button>
      <select id="langSelector">
        <option value="en">English</option>
        <option value="ar">العربية</option>
      </select>
    </div>
  </header>

  <div class="container">
    <!-- المحتوى الرئيسي -->
    <div class="mainContent">
      <div class="errorMsg" id="errorMsg"></div>
      <div class="successMsg" id="successMsg"></div>

      <button class="addBtn" onclick="openModalForAdd()" data-lng="rules_button_add">إضافة قاعدة جديدة</button>

      <!-- الجدول -->
      <table id="rulesTable">
        <thead>
          <tr>
            <th data-lng="rules_table_index">#</th>
            <th data-lng="rules_table_ruleName">اسم القاعدة</th>
            <th data-lng="rules_table_priority">الأولوية</th>
            <th data-lng="rules_table_stopOnMatch">StopOnMatch?</th>
            <th data-lng="rules_table_control">تحكم</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- الشريط الجانبي -->
    <div class="sidebar">
      <h2 data-lng="sidebarTitle"></h2>
      <div class="navItem" onclick="location.href='dashboard.html'">
        <i class="bi bi-house-fill"></i>
        <span data-lng="navOverview"></span>
      </div>
      <div class="navItem" onclick="location.href='employee.html'">
        <i class="bi bi-people-fill"></i>
        <span data-lng="navEmployees"></span>
      </div>
      <div class="navItem" onclick="location.href='report.html'">
        <i class="bi bi-bar-chart-line-fill"></i>
        <span data-lng="navReport"></span>
      </div>
      <div class="navItem" onclick="location.href='time-based-leaves.html'">
        <i class="bi bi-clock-fill"></i>
        <span data-lng="navTimeLeaves"></span>
      </div>
      <div class="navItem" onclick="location.href='holidays.html'">
        <i class="bi bi-calendar-event-fill"></i>
        <span data-lng="navHolidays"></span>
      </div>
      <div class="navItem" onclick="location.href='leaves.html'">
        <i class="bi bi-calendar3"></i>
        <span data-lng="navLeaves"></span>
      </div>
      <div class="navItem" onclick="location.href='attend.html'">
        <i class="bi bi-journal-check"></i>
        <span data-lng="navAttend"></span>
      </div>
      <div class="navItem" onclick="location.href='rewards.html'">
        <i class="bi bi-gift-fill"></i>
        <span data-lng="navRewards"></span>
      </div>
      <div class="navItem" onclick="location.href='devices.html'">
        <i class="bi bi-device-hdd-fill"></i>
        <span data-lng="navDevices"></span>
      </div>
      <div class="navItem" onclick="location.href='requests.html'">
        <i class="bi bi-list-check"></i>
        <span data-lng="navRequests"></span>
      </div>
      <div class="navItem" onclick="location.href='department.html'">
        <i class="bi bi-building"></i>
        <span data-lng="navDepartment"></span>
      </div>
      <!-- <div class="navItem" onclick="location.href='settings.html'">
        <i class="bi bi-gear-fill"></i>
        <span data-lng="navSettings"></span>
      </div> -->
      <div class="navItem" onclick="location.href='importemployee.html'">
        <i class="bi bi-person-exclamation"></i>
        <span data-lng="attend_sidebar_unregistered"></span>
      </div>
      <div class="navItem" onclick="location.href='employee-summary-report.html'">
        <i class="bi bi-people-fill"></i>
        <span data-lng="employee_summary_report"></span>
      </div>
      <div class="navItem" onclick="location.href='leaves-type.html'">
        <i class="bi bi-briefcase-fill"></i>
        <span data-lng="leaves_type">أنواع الإجازات</span>
      </div>
      <div class="navItem" onclick="location.href='public-settings.html'">
        <i class="bi bi-gear"></i>
        <span data-lng="public_settings"></span>
      </div>
      <div class="navItem " onclick="location.href='shifts.html'">
        <i class="bi bi-hourglass-split"></i>
        <span data-lng="navshift"></span>
      </div>
      <div class="navItem " onclick="location.href='TimeSlot.html'">
        <i class="bi bi-watch"></i>
        <span data-lng="navSlot"></span>
      </div>
      <div class="navItem active" onclick="location.href='rules.html'">
        <i class="bi bi-braces"></i>
        <span data-lng="navRules">القواعد (Rules)</span>
      </div>

    </div>
  </div>
  <!-- مودال إضافة/تعديل قاعدة -->
  <div class="modalOverlay" id="ruleModal">
    <div class="modalContent">
      <div class="modalHeader">
        <h2 id="modalTitle" data-lng="rules_modal_title_add">إضافة قاعدة</h2>
        <button class="modalCloseBtn" onclick="closeModal()">×</button>
      </div>
      <div class="modalBody">
        <input type="hidden" id="ruleId" />

        <label for="ruleName" data-lng="modal_label_ruleName">اسم القاعدة:</label>
        <input type="text" id="ruleName" data-lng-placeholder="modal_placeholder_ruleName"
          placeholder="مثال: Late Condition" />

        <label for="rulePriority" data-lng="modal_label_rulePriority">الأولوية (priority):</label>
        <input type="number" id="rulePriority" value="0" />

        <div style="margin-bottom: 10px;">
          <input type="checkbox" id="ruleStopOnMatch" />
          <label for="ruleStopOnMatch" data-lng="modal_label_ruleStopOnMatch">إيقاف عند أول تطابق؟</label>
        </div>

        <label for="ruleValidFrom" data-lng="modal_label_validFrom">تاريخ البداية (Valid From):</label>
        <input type="date" id="ruleValidFrom" />

        <label for="ruleValidTo" data-lng="modal_label_validTo">تاريخ النهاية (Valid To):</label>
        <input type="date" id="ruleValidTo" />

        <h5 data-lng="modal_heading_conditions">الشروط (conditions)</h5>
        <table class="conditionsTable" id="conditionsTable">
          <thead>
            <tr>
              <th data-lng="modal_conditions_field">Field</th>
              <th data-lng="modal_conditions_operator">Operator</th>
              <th data-lng="modal_conditions_value">Value</th>
              <th data-lng="modal_conditions_delete">حذف</th>
            </tr>
          </thead>
          <tbody id="conditionsTableBody"></tbody>
        </table>
        <button style="margin-bottom: 10px;" onclick="addConditionRow()" data-lng="modal_button_add_condition">إضافة
          شرط</button>

        <h5 data-lng="modal_heading_actions">الإجراءات (actions)</h5>
        <table class="actionsTable" id="actionsTable">
          <thead>
            <tr>
              <th data-lng="modal_actions_field">Field</th>
              <th data-lng="modal_actions_type">Type</th>
              <th data-lng="modal_actions_value">Value</th>
              <th data-lng="modal_actions_delete">حذف</th>
            </tr>
          </thead>
          <tbody id="actionsTableBody"></tbody>
        </table>
        <button onclick="addActionRow()" data-lng="modal_button_add_action">إضافة إجراء</button>
      </div>
      <div class="modalActions">
        <button class="modalCancelBtn" onclick="closeModal()" data-lng="modal_button_cancel">إلغاء</button>
        <button class="modalSaveBtn" onclick="saveRule()" data-lng="modal_button_save_rule">حفظ</button>
      </div>
    </div>
  </div>

  <script>
    /* ----------------------------------------
     *   1) إعداد اللغة - الترجمة الديناميكية
     * ---------------------------------------- */
    const LANG_KEY = 'lng';
    const RULES_LANG_PATH = './lang';
    let translations = {};

    function getTranslate(key) {
      return translations[key] || "";
    }

    async function loadLanguageFile(lang) {
      try {
        const response = await fetch(`${RULES_LANG_PATH}/${lang}_rules.json`);
        if (!response.ok) {
          throw new Error(`Error loading ${lang}_rules.json`);
        }
        translations = await response.json();
      } catch (error) {
        console.error("Rules translation file error:", error);
      }
    }

    function applyTranslations(lang) {
      document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-lng]').forEach(el => {
        const key = el.getAttribute('data-lng');
        if (translations[key]) {
          el.textContent = translations[key];
        }
      });
      document.querySelectorAll('[data-lng-placeholder]').forEach(el => {
        const key = el.getAttribute('data-lng-placeholder');
        if (translations[key]) {
          el.placeholder = translations[key];
        }
      });
    }

    async function setLanguage(lang) {
      await loadLanguageFile(lang);
      localStorage.setItem(LANG_KEY, lang);
      applyTranslations(lang);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      let storedLang = localStorage.getItem(LANG_KEY) || 'ar';
      await loadLanguageFile(storedLang);
      applyTranslations(storedLang);
    });

    document.getElementById('langSelector').addEventListener('change', async function () {
      await setLanguage(this.value);
    });

    /* ----------------------------------------
     *   2) إدارة القواعد
     * ---------------------------------------- */
    let authToken = null;
    let allRules = [];
    let editModeRuleId = null;

    function initPage() {
      authToken = localStorage.getItem('authToken');
      if (!authToken) {
        window.location.href = 'login.html';
        return;
      }
      loadRules();
    }

    function logout() {
      localStorage.removeItem('authToken');
      window.location.href = 'login.html';
    }

    async function loadRules() {
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      try {
        const resp = await fetch('/api/rules', {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) {
          throw new Error('فشل جلب القواعد من السيرفر. (status=' + resp.status + ')');
        }
        const data = await resp.json();
        allRules = data;
        renderRules(allRules);
      } catch (err) {
        errorMsg.textContent = err.message;
      }
    }

    function renderRules(rulesArr) {
      const tb = document.querySelector('#rulesTable tbody');
      tb.innerHTML = '';
      rulesArr.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.name || ''}</td>
          <td>${r.priority || 0}</td>
          <td>${r.stopOnMatch ? 'نعم' : 'لا'}</td>
          <td>
            <i class="bi bi-pencil-fill actionIcon" onclick="openModalForEdit('${r._id}')"></i>
            <i class="bi bi-trash-fill actionIcon" onclick="deleteRule('${r._id}')"></i>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    function openModalForAdd() {
      editModeRuleId = null;
      document.getElementById('modalTitle').textContent = getTranslate("rules_modal_title_add");
      document.getElementById('ruleId').value = '';
      document.getElementById('ruleName').value = '';
      document.getElementById('rulePriority').value = '0';
      document.getElementById('ruleStopOnMatch').checked = false;
      document.getElementById('ruleValidFrom').value = '';
      document.getElementById('ruleValidTo').value = '';
      document.getElementById('conditionsTableBody').innerHTML = '';
      document.getElementById('actionsTableBody').innerHTML = '';
      showModal();
    }

    async function openModalForEdit(ruleId) {
      editModeRuleId = ruleId;
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      try {
        const resp = await fetch(`/api/rules/${ruleId}`, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) {
          throw new Error('تعذر جلب القاعدة. (status=' + resp.status + ')');
        }
        const rule = await resp.json();

        document.getElementById('modalTitle').textContent = getTranslate("rules_modal_title_edit");
        document.getElementById('ruleId').value = rule._id || '';
        document.getElementById('ruleName').value = rule.name || '';
        document.getElementById('rulePriority').value = rule.priority || 0;
        document.getElementById('ruleStopOnMatch').checked = rule.stopOnMatch ? true : false;
        document.getElementById('ruleValidFrom').value = rule.validFrom ? rule.validFrom.substring(0, 10) : '';
        document.getElementById('ruleValidTo').value = rule.validTo ? rule.validTo.substring(0, 10) : '';
        document.getElementById('conditionsTableBody').innerHTML = '';
        document.getElementById('actionsTableBody').innerHTML = '';
        (rule.conditions || []).forEach(cond => addConditionRow(cond));
        (rule.actions || []).forEach(act => addActionRow(act));
        showModal();
      } catch (err) {
        errorMsg.textContent = err.message;
      }
    }

    async function saveRule() {
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      const ruleId = document.getElementById('ruleId').value;
      const name = document.getElementById('ruleName').value.trim();
      const priority = parseInt(document.getElementById('rulePriority').value) || 0;
      const stopOnMatch = document.getElementById('ruleStopOnMatch').checked;
      const validFrom = document.getElementById('ruleValidFrom').value;
      const validTo = document.getElementById('ruleValidTo').value;

      const condRows = document.querySelectorAll('#conditionsTableBody tr');
      let conditions = [];
      condRows.forEach(row => {
        const selects = row.querySelectorAll('select');
        const inputs = row.querySelectorAll('input');
        const field = selects[0].value;
        const operator = selects[1].value;
        const value = inputs[0].value.trim();
        if (field && operator) {
          conditions.push({ field, operator, value });
        }
      });

      const actRows = document.querySelectorAll('#actionsTableBody tr');
      let actions = [];
      actRows.forEach(row => {
        const selects = row.querySelectorAll('select');
        const inputs = row.querySelectorAll('input');
        const field = selects[0].value;
        const type = selects[1].value;
        const value = inputs[0].value.trim();
        if (field && type) {
          actions.push({ field, type, value });
        }
      });

      const bodyObj = {
        name,
        priority,
        stopOnMatch,
        validFrom,
        validTo,
        conditions,
        actions
      };

      try {
        let method = 'POST';
        let url = '/api/rules';
        if (ruleId) {
          method = 'PUT';
          url = `/api/rules/${ruleId}`;
        }

        const resp = await fetch(url, {
          method,
          headers: {
            'Authorization': 'Bearer ' + authToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bodyObj)
        });
        if (!resp.ok) {
          throw new Error(`فشل ${ruleId ? 'تعديل' : 'إضافة'} القاعدة. (status=${resp.status})`);
        }

        successMsg.textContent = ruleId ? 'تم تعديل القاعدة بنجاح' : 'تم إضافة القاعدة بنجاح';
        closeModal();
        loadRules();
      } catch (err) {
        errorMsg.textContent = err.message;
      }
    }

    async function deleteRule(ruleId) {
      const errorMsg = document.getElementById('errorMsg');
      const successMsg = document.getElementById('successMsg');
      errorMsg.textContent = '';
      successMsg.textContent = '';

      if (!confirm('هل أنت متأكد من الحذف؟')) return;

      try {
        const resp = await fetch(`/api/rules/${ruleId}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (!resp.ok) {
          throw new Error('فشل حذف القاعدة. (status=' + resp.status + ')');
        }
        successMsg.textContent = 'تم حذف القاعدة بنجاح';
        loadRules();
      } catch (err) {
        errorMsg.textContent = err.message;
      }
    }

    function showModal() {
      document.getElementById('ruleModal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('ruleModal').style.display = 'none';
      document.getElementById('ruleId').value = '';
      document.getElementById('modalTitle').textContent = getTranslate("rules_modal_title_add");
      document.getElementById('ruleName').value = '';
      document.getElementById('rulePriority').value = '0';
      document.getElementById('ruleStopOnMatch').checked = false;
      document.getElementById('ruleValidFrom').value = '';
      document.getElementById('ruleValidTo').value = '';
      document.getElementById('conditionsTableBody').innerHTML = '';
      document.getElementById('actionsTableBody').innerHTML = '';
    }

    /* ----------------------------------------
     *   8) الحقول والعمليات الممكنة
     * ---------------------------------------- */
    const AVAILABLE_FIELDS = [
      "event", "check_in", "check_out", "rest_breaks", "total_rest_minutes", "total_rest_duration",
      "delay_minutes", "early_exit_minutes", "overtime_minutes", "status_code", "attendance_date",
      "employee_name", "department_id", "department_name", "daily_salary", "hour_price", "overtime_price",
      "works_for_daily_wage", "official_working_hours", "endDayOffset", "minimum_working_hours_overtime",
      "base_work_hours", "work_hours", "salary_earned_for_work", "overtime_entitlement", "late_cutting_by_count",
      "early_cutting_by_count", "absent_cutting", "late_arrival_deduction", "early_exit_deduction",
      "rest_cutting", "net_salary_before_rounding", "net_salary", "rewards_penalties_amount",
      "is_vacation_day", "is_paid_vacation", "vacation_status", "leave_duration_for_entry",
      "leave_duration_for_exit", "attendance_status", "enroll_id"
    ];

    const AVAILABLE_OPERATORS = [
      { val: "eq", label: "==" },
      { val: "ne", label: "!=" },
      { val: "gt", label: ">" },
      { val: "lt", label: "<" },
      { val: "gte", label: ">=" },
      { val: "lte", label: "<=" },
      { val: "gtTime", label: "وقت أكبر من" },
      { val: "ltTime", label: "وقت أصغر من" }
    ];

    const AVAILABLE_ACTION_TYPES = [
      { val: "set", label: "set (تعيين)" },
      { val: "increment", label: "increment (زيادة/نقصان)" },
      { val: "multiply", label: "multiply (ضرب)" },
      { val: "time_adjust", label: "time_adjust (تعديل الوقت)" }
    ];

    function addConditionRow(cond = { field: '', operator: '', value: '' }) {
      const tBody = document.getElementById('conditionsTableBody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <select>
            ${AVAILABLE_FIELDS.map(f => {
        const sel = (cond.field === f) ? 'selected' : '';
        return `<option value="${f}" ${sel}>${f}</option>`;
      }).join('')}
          </select>
        </td>
        <td>
          <select>
            ${AVAILABLE_OPERATORS.map(o => {
        const sel = (cond.operator === o.val) ? 'selected' : '';
        return `<option value="${o.val}" ${sel}>${o.label}</option>`;
      }).join('')}
          </select>
        </td>
        <td>
          <input type="text" value="${cond.value}">
        </td>
        <td>
          <button type="button" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="removeRow(this)" data-lng="modal_button_remove">حذف</button>
        </td>
      `;
      tBody.appendChild(row);
    }

    function addActionRow(action = { field: '', type: '', value: '' }) {
      const tBody = document.getElementById('actionsTableBody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <select>
            ${AVAILABLE_FIELDS.map(f => {
        const sel = (action.field === f) ? 'selected' : '';
        return `<option value="${f}" ${sel}>${f}</option>`;
      }).join('')}
          </select>
        </td>
        <td>
          <select>
            ${AVAILABLE_ACTION_TYPES.map(a => {
        const sel = (action.type === a.val) ? 'selected' : '';
        return `<option value="${a.val}" ${sel}>${a.label}</option>`;
      }).join('')}
          </select>
        </td>
        <td>
          <input type="text" value="${action.value}">
        </td>
        <td>
          <button type="button" style="background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;" onclick="removeRow(this)" data-lng="modal_button_remove">حذف</button>
        </td>
      `;
      tBody.appendChild(row);
    }

    function removeRow(btn) {
      btn.parentElement.parentElement.remove();
    }
  </script>
</body>

</html>